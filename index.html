<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boud Pricing Engine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      /* Brand Colors from Guidelines */
      --boud-magenta: #883f68;
      --boud-purple: #5e56de;
      --boud-orange: #e46a17;
      --boud-lime: #def763;
      --boud-light-gray: #f4f4f4;
      --boud-dark: #231F20;
      --boud-charcoal: #2D2A2B;
      --text-white: #FFFFFF;
      --text-black: #231F20;
      --gray-text: #9A9A9A;
      --success: #4ADE80;
      --warning: #FBBF24;
      --error: #F87171;
      --info: #def763;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--boud-light-gray);
      color: var(--text-black);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    h1 { font-size: 28px; font-weight: 700; color: var(--boud-dark); letter-spacing: -0.02em; }
    h2 { font-size: 22px; font-weight: 600; color: var(--boud-charcoal); }
    h3 { font-size: 18px; font-weight: 600; color: var(--boud-charcoal); }
    h4 { font-size: 14px; font-weight: 600; color: var(--gray-text); text-transform: uppercase; letter-spacing: 0.05em; }
    .text-secondary { color: var(--gray-text); }
    .app-container { display: flex; min-height: 100vh; }
    .sidebar {
      width: 260px;
      background: var(--boud-charcoal);
      color: white;
      padding: var(--spacing-lg);
      display: flex;
      flex-direction: column;
    }
    .main-content { flex: 1; padding: var(--spacing-xl); overflow-y: auto; }
    .logo { display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-2xl); padding-bottom: var(--spacing-lg); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .logo-text { font-size: 24px; font-weight: 700; color: white; letter-spacing: 0.05em; }
    .logo-subtitle { font-size: 11px; color: var(--boud-lime); text-transform: uppercase; letter-spacing: 0.1em; }
    .nav-menu { list-style: none; display: flex; flex-direction: column; gap: var(--spacing-xs); }
    .nav-item { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s ease; color: rgba(255, 255, 255, 0.7); font-size: 14px; font-weight: 500; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.1); color: white; }
    .nav-item.active { background: var(--boud-lime); color: var(--boud-dark); }
    .nav-item svg { width: 20px; height: 20px; }
    .card { background: white; border-radius: var(--radius-lg); padding: var(--spacing-lg); box-shadow: var(--shadow-sm); border: 1px solid rgba(0, 0, 0, 0.05); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--boud-light-gray); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border: none; outline: none; }
    .btn-primary { background: var(--boud-lime); color: var(--boud-dark); }
    .btn-primary:hover { background: #c9e050; }
    .btn-secondary { background: var(--boud-light-gray); color: var(--text-black); border: 1px solid rgba(0, 0, 0, 0.1); }
    .btn-secondary:hover { background: #ebedf0; }
    .btn-danger { background: var(--error); color: white; }
    .btn-purple { background: var(--boud-purple); color: white; }
    .btn-purple:hover { background: #4d47c7; }
    .btn-magenta { background: var(--boud-magenta); color: white; }
    .btn-magenta:hover { background: #703456; }
    .btn-orange { background: var(--boud-orange); color: white; }
    .btn-orange:hover { background: #c55a12; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn-icon { padding: var(--spacing-sm); background: transparent; color: var(--gray-text); }
    .btn-icon:hover { background: var(--boud-light-gray); color: var(--text-black); }
    .form-group { margin-bottom: var(--spacing-md); }
    .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--gray-text); margin-bottom: var(--spacing-xs); }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border: 1px solid rgba(0, 0, 0, 0.15); border-radius: var(--radius-md); font-size: 14px; font-family: inherit; transition: border-color 0.2s ease, box-shadow 0.2s ease; background: white; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--boud-lime); box-shadow: 0 0 0 3px rgba(222, 247, 99, 0.25); }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: var(--spacing-md); font-size: 12px; font-weight: 600; color: var(--gray-text); text-transform: uppercase; letter-spacing: 0.05em; background: var(--boud-light-gray); border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
    td { padding: var(--spacing-md); border-bottom: 1px solid var(--boud-light-gray); font-size: 14px; }
    tr:hover { background: rgba(222, 247, 99, 0.05); }
    .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 100px; font-size: 12px; font-weight: 500; }
    .badge-success { background: rgba(40, 167, 69, 0.1); color: var(--success); }
    .badge-warning { background: rgba(255, 193, 7, 0.15); color: #d39e00; }
    .badge-error { background: rgba(220, 53, 69, 0.1); color: var(--error); }
    .badge-info { background: rgba(222, 247, 99, 0.15); color: #8B9A30; }
    .badge-purple { background: rgba(94, 86, 222, 0.15); color: var(--boud-purple); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-xl); }
    .stat-card { background: white; padding: var(--spacing-lg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid rgba(0, 0, 0, 0.05); }
    .stat-label { font-size: 13px; color: var(--gray-text); margin-bottom: var(--spacing-xs); }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--boud-dark); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: white; border-radius: var(--radius-lg); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-lg); border-bottom: 1px solid var(--boud-light-gray); }
    .modal-body { padding: var(--spacing-lg); }
    .modal-footer { display: flex; justify-content: flex-end; gap: var(--spacing-sm); padding: var(--spacing-lg); border-top: 1px solid var(--boud-light-gray); }
    .tabs { display: flex; gap: var(--spacing-xs); border-bottom: 1px solid rgba(0, 0, 0, 0.1); margin-bottom: var(--spacing-lg); }
    .tab { padding: var(--spacing-md) var(--spacing-lg); font-size: 14px; font-weight: 500; color: var(--gray-text); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s ease; background: none; border-top: none; border-left: none; border-right: none; }
    .tab:hover { color: var(--text-black); }
    .tab.active { color: var(--boud-purple); border-bottom-color: var(--boud-purple); }
    .empty-state { text-align: center; padding: var(--spacing-2xl); color: var(--gray-text); }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl); }
    .page-title { font-size: 24px; font-weight: 700; color: var(--boud-dark); }
    .margin-display { display: flex; align-items: center; gap: var(--spacing-lg); padding: var(--spacing-lg); background: var(--boud-dark); border-radius: var(--radius-lg); color: white; flex-wrap: wrap; }
    .margin-item { text-align: center; }
    .margin-item .label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.7; margin-bottom: 4px; }
    .margin-item .value { font-size: 24px; font-weight: 700; }
    .margin-divider { width: 1px; height: 40px; background: rgba(255, 255, 255, 0.2); }
    .phase-section { background: white; border-radius: var(--radius-lg); margin-bottom: var(--spacing-md); border: 1px solid rgba(0, 0, 0, 0.05); overflow: hidden; }
    .phase-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md) var(--spacing-lg); background: var(--boud-light-gray); cursor: pointer; }
    .phase-content { padding: var(--spacing-lg); }
    .actions { display: flex; gap: var(--spacing-sm); }
    .loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #231F20; color: white; }
    @keyframes loading { 0% { transform: translateX(-100%); } 50% { transform: translateX(100%); } 100% { transform: translateX(200%); } }

    /* Auth Page Styles */
    .auth-container { min-height: 100vh; display: flex; }
    .auth-left { flex: 1; background: linear-gradient(135deg, var(--boud-purple) 0%, var(--boud-magenta) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px; color: white; }
    .auth-right { flex: 1; display: flex; align-items: center; justify-content: center; padding: 48px; background: white; }
    .auth-form { width: 100%; max-width: 400px; }
    .auth-title { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
    .auth-subtitle { color: var(--gray-text); margin-bottom: 32px; }
    .auth-divider { display: flex; align-items: center; gap: 16px; margin: 24px 0; color: var(--gray-text); font-size: 13px; }
    .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: rgba(0,0,0,0.1); }
    .auth-link { color: var(--boud-purple); text-decoration: none; font-weight: 500; cursor: pointer; }
    .auth-link:hover { text-decoration: underline; }

    /* Dark Mode Styles */
    [data-theme="dark"] {
      --boud-light-gray: #1a1a1a;
      --text-black: #ffffff;
      --gray-text: #a0a0a0;
    }
    [data-theme="dark"] body { background-color: #121212; color: #ffffff; }
    [data-theme="dark"] .card { background: #1e1e1e; border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] .stat-card { background: #1e1e1e; }
    [data-theme="dark"] .stat-value { color: #ffffff; }
    [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3 { color: #ffffff; }
    [data-theme="dark"] .page-title { color: #ffffff; }
    [data-theme="dark"] .form-input, [data-theme="dark"] .form-select, [data-theme="dark"] .form-textarea {
      background: #2a2a2a; border-color: rgba(255,255,255,0.2); color: #ffffff;
    }
    [data-theme="dark"] .modal { background: #1e1e1e; }
    [data-theme="dark"] .modal-header, [data-theme="dark"] .modal-footer { border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] th { background: #2a2a2a; }
    [data-theme="dark"] td { border-color: rgba(255,255,255,0.05); }
    [data-theme="dark"] .phase-section { background: #1e1e1e; border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] .phase-header { background: #2a2a2a; }
    [data-theme="dark"] .btn-secondary { background: #2a2a2a; color: #ffffff; border-color: rgba(255,255,255,0.2); }
    [data-theme="dark"] .tabs { border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] .notification-panel { background: #1e1e1e; }
    [data-theme="dark"] .notification-item { border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] .auth-right { background: #1e1e1e; }

    /* Notification Panel */
    .notification-panel {
      position: fixed; top: 0; right: -400px; width: 400px; height: 100vh;
      background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      z-index: 1001; transition: right 0.3s ease; overflow-y: auto;
    }
    .notification-panel.open { right: 0; }
    .notification-item {
      padding: 16px; border-bottom: 1px solid var(--boud-light-gray);
      cursor: pointer; transition: background 0.2s;
    }
    .notification-item:hover { background: var(--boud-light-gray); }
    .notification-item.unread { background: rgba(222, 247, 99, 0.1); }
    .notification-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.3);
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s;
    }
    .notification-overlay.open { opacity: 1; visibility: visible; }

    /* Version History */
    .version-history { max-height: 400px; overflow-y: auto; }
    .version-item { padding: 12px 16px; border-left: 3px solid var(--boud-purple); background: var(--boud-light-gray); margin-bottom: 8px; border-radius: 0 8px 8px 0; }
    .version-time { font-size: 11px; color: var(--gray-text); }
    .version-change { font-size: 13px; margin-top: 4px; }

    /* Template Card */
    .template-card { padding: 16px; border: 2px solid var(--boud-light-gray); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
    .template-card:hover { border-color: var(--boud-purple); background: rgba(94, 86, 222, 0.05); }
    .template-card.selected { border-color: var(--boud-lime); background: rgba(222, 247, 99, 0.1); }

    /* Role Selector Styles */
    .role-selector { position: relative; }
    .role-selector-trigger { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border: 1px solid var(--boud-light-gray); border-radius: 8px; background: white; cursor: pointer; min-height: 44px; transition: all 0.2s; }
    .role-selector-trigger:hover { border-color: var(--boud-purple); }
    .role-selector-trigger.open { border-color: var(--boud-purple); box-shadow: 0 0 0 3px rgba(94, 86, 222, 0.1); }
    .role-selector-placeholder { color: var(--gray-text); }
    .role-selector-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--boud-light-gray); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 1000; margin-top: 4px; max-height: 380px; overflow: hidden; display: flex; flex-direction: column; }
    .role-selector-search { padding: 12px; border-bottom: 1px solid var(--boud-light-gray); }
    .role-selector-search input { width: 100%; padding: 10px 12px; border: 1px solid var(--boud-light-gray); border-radius: 8px; font-size: 14px; }
    .role-selector-search input:focus { outline: none; border-color: var(--boud-purple); }
    .role-selector-tabs { display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid var(--boud-light-gray); flex-wrap: wrap; }
    .role-selector-tab { padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; background: var(--boud-light-gray); border: none; transition: all 0.15s; }
    .role-selector-tab:hover { background: rgba(94, 86, 222, 0.1); }
    .role-selector-tab.active { background: var(--boud-purple); color: white; }
    .role-selector-list { flex: 1; overflow-y: auto; padding: 8px; }
    .role-selector-section { margin-bottom: 8px; }
    .role-selector-section-title { font-size: 11px; font-weight: 600; color: var(--gray-text); text-transform: uppercase; padding: 4px 8px; }
    .role-selector-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.15s; }
    .role-selector-item:hover { background: rgba(94, 86, 222, 0.08); }
    .role-selector-item.selected { background: rgba(94, 86, 222, 0.12); }
    .role-selector-item-name { font-weight: 500; }
    .role-selector-item-rate { font-size: 13px; color: var(--gray-text); }
    .role-selector-item-dept { font-size: 11px; color: var(--boud-purple); background: rgba(94, 86, 222, 0.1); padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    .role-selector-empty { padding: 24px; text-align: center; color: var(--gray-text); }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Simple UUID generator
    const generateId = (prefix = '') => prefix + '_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);

    // Database state stored in memory (will use localStorage for persistence)
    let dbState = {
      roles: [],
      tools: [],
      projects: [],
      phases: [],
      resourceCosts: [],
      toolCosts: [],
      vendorCosts: [],
      rateHistory: [],
      versionHistory: [],
      templates: [],
      recentRoles: []
    };

    // Load from localStorage
    const loadState = () => {
      const saved = localStorage.getItem('boud_pricing_state');
      if (saved) {
        dbState = JSON.parse(saved);
        // Ensure new fields exist
        if (!dbState.versionHistory) dbState.versionHistory = [];
        if (!dbState.templates) dbState.templates = [];
      } else {
        // Seed initial data - 89 roles from Resources Pricing List
        dbState.roles = [
          // Product Owner (PO)
          { id: 'role_1', name: 'Senior Consultant - PO', hourly_rate: 710, department: 'PO', grade: 7 },
          { id: 'role_2', name: 'Consultant - PO', hourly_rate: 600, department: 'PO', grade: 8 },
          { id: 'role_3', name: 'Associate Consultant - PO', hourly_rate: 450, department: 'PO', grade: 9 },
          { id: 'role_4', name: 'Senior Specialist - PO', hourly_rate: 250, department: 'PO', grade: 10 },
          { id: 'role_5', name: 'Specialist - PO', hourly_rate: 190, department: 'PO', grade: 11 },
          { id: 'role_6', name: 'Senior Analyst - PO', hourly_rate: 142.5, department: 'PO', grade: 12 },
          { id: 'role_7', name: 'Junior Analyst - PO', hourly_rate: 110, department: 'PO', grade: 13 },
          { id: 'role_8', name: 'Intern - PO', hourly_rate: 15, department: 'PO', grade: 14 },
          // Project Management (PM)
          { id: 'role_9', name: 'Senior Consultant - PM', hourly_rate: 560, department: 'PM', grade: 7 },
          { id: 'role_10', name: 'Consultant - PM', hourly_rate: 450, department: 'PM', grade: 8 },
          { id: 'role_11', name: 'Associate Consultant - PM', hourly_rate: 350, department: 'PM', grade: 9 },
          { id: 'role_12', name: 'Senior Specialist - PM', hourly_rate: 220, department: 'PM', grade: 10 },
          { id: 'role_13', name: 'Specialist - PM', hourly_rate: 150, department: 'PM', grade: 11 },
          { id: 'role_14', name: 'Senior Analyst - PM', hourly_rate: 100, department: 'PM', grade: 12 },
          { id: 'role_15', name: 'Junior Analyst - PM', hourly_rate: 70, department: 'PM', grade: 13 },
          { id: 'role_16', name: 'Intern - PM', hourly_rate: 30, department: 'PM', grade: 14 },
          // Business Analysis (BA)
          { id: 'role_17', name: 'Senior Consultant - BA', hourly_rate: 350, department: 'BA', grade: 7 },
          { id: 'role_18', name: 'Consultant - BA', hourly_rate: 300, department: 'BA', grade: 8 },
          { id: 'role_19', name: 'Associate Consultant - BA', hourly_rate: 250, department: 'BA', grade: 9 },
          { id: 'role_20', name: 'Senior Specialist - BA', hourly_rate: 200, department: 'BA', grade: 10 },
          { id: 'role_21', name: 'Specialist - BA', hourly_rate: 170, department: 'BA', grade: 11 },
          { id: 'role_22', name: 'Senior Analyst - BA', hourly_rate: 140, department: 'BA', grade: 12 },
          { id: 'role_23', name: 'Junior Analyst - BA', hourly_rate: 100, department: 'BA', grade: 13 },
          { id: 'role_24', name: 'Intern - BA', hourly_rate: 30, department: 'BA', grade: 14 },
          // UX/UI Design (UXUI)
          { id: 'role_25', name: 'Senior Consultant - UXUI', hourly_rate: 450, department: 'UXUI', grade: 7 },
          { id: 'role_26', name: 'Consultant - UXUI', hourly_rate: 300, department: 'UXUI', grade: 8 },
          { id: 'role_27', name: 'Associate Consultant - UXUI', hourly_rate: 200, department: 'UXUI', grade: 9 },
          { id: 'role_28', name: 'Senior Specialist - UXUI', hourly_rate: 160, department: 'UXUI', grade: 10 },
          { id: 'role_29', name: 'Specialist - UXUI', hourly_rate: 125, department: 'UXUI', grade: 11 },
          { id: 'role_30', name: 'Senior Analyst - UXUI', hourly_rate: 95, department: 'UXUI', grade: 12 },
          { id: 'role_31', name: 'Junior Analyst - UXUI', hourly_rate: 57, department: 'UXUI', grade: 13 },
          { id: 'role_32', name: 'Intern - UXUI', hourly_rate: 30, department: 'UXUI', grade: 14 },
          // Front End (FE)
          { id: 'role_33', name: 'Senior Consultant Engineer - FE', hourly_rate: 250, department: 'FE', grade: 7 },
          { id: 'role_34', name: 'Consultant Engineer - FE', hourly_rate: 200, department: 'FE', grade: 8 },
          { id: 'role_35', name: 'Associate Consultant Engineer - FE', hourly_rate: 160, department: 'FE', grade: 9 },
          { id: 'role_36', name: 'Senior Specialist - FE', hourly_rate: 120, department: 'FE', grade: 10 },
          { id: 'role_37', name: 'Specialist - FE', hourly_rate: 80, department: 'FE', grade: 11 },
          { id: 'role_38', name: 'Senior Analyst - FE', hourly_rate: 45, department: 'FE', grade: 12 },
          { id: 'role_39', name: 'Junior Analyst - FE', hourly_rate: 45, department: 'FE', grade: 13 },
          { id: 'role_40', name: 'Intern - FE', hourly_rate: 30, department: 'FE', grade: 14 },
          // Mobile Development (Mobile)
          { id: 'role_41', name: 'Senior Consultant Engineer - Mobile', hourly_rate: 350, department: 'Mobile', grade: 7 },
          { id: 'role_42', name: 'Consultant Engineer - Mobile', hourly_rate: 250, department: 'Mobile', grade: 8 },
          { id: 'role_43', name: 'Associate Consultant Engineer - Mobile', hourly_rate: 200, department: 'Mobile', grade: 9 },
          { id: 'role_44', name: 'Senior Specialist - Mobile', hourly_rate: 140, department: 'Mobile', grade: 10 },
          { id: 'role_45', name: 'Specialist - Mobile', hourly_rate: 80, department: 'Mobile', grade: 11 },
          { id: 'role_46', name: 'Senior Analyst - Mobile', hourly_rate: 57, department: 'Mobile', grade: 12 },
          { id: 'role_47', name: 'Junior Analyst - Mobile', hourly_rate: 40, department: 'Mobile', grade: 13 },
          { id: 'role_48', name: 'Intern - Mobile', hourly_rate: 30, department: 'Mobile', grade: 14 },
          // Back End (BE)
          { id: 'role_49', name: 'Senior Consultant Engineer - BE', hourly_rate: 250, department: 'BE', grade: 7 },
          { id: 'role_50', name: 'Consultant Engineer - BE', hourly_rate: 190, department: 'BE', grade: 8 },
          { id: 'role_51', name: 'Associate Consultant Engineer - BE', hourly_rate: 150, department: 'BE', grade: 9 },
          { id: 'role_52', name: 'Senior Specialist - BE', hourly_rate: 115, department: 'BE', grade: 10 },
          { id: 'role_53', name: 'Specialist - BE', hourly_rate: 90, department: 'BE', grade: 11 },
          { id: 'role_54', name: 'Senior Analyst - BE', hourly_rate: 70, department: 'BE', grade: 12 },
          { id: 'role_55', name: 'Junior Analyst - BE', hourly_rate: 50, department: 'BE', grade: 13 },
          { id: 'role_56', name: 'Intern - BE', hourly_rate: 30, department: 'BE', grade: 14 },
          // Quality Assurance (QA)
          { id: 'role_57', name: 'Senior Consultant - QA', hourly_rate: 250, department: 'QA', grade: 7 },
          { id: 'role_58', name: 'Consultant - QA', hourly_rate: 190, department: 'QA', grade: 8 },
          { id: 'role_59', name: 'Associate Consultant - QA', hourly_rate: 150, department: 'QA', grade: 9 },
          { id: 'role_60', name: 'Senior Specialist - QA', hourly_rate: 115, department: 'QA', grade: 10 },
          { id: 'role_61', name: 'Specialist - QA', hourly_rate: 90, department: 'QA', grade: 11 },
          { id: 'role_62', name: 'Senior Analyst - QA', hourly_rate: 70, department: 'QA', grade: 12 },
          { id: 'role_63', name: 'Junior Analyst - QA', hourly_rate: 50, department: 'QA', grade: 13 },
          { id: 'role_64', name: 'Intern - QA', hourly_rate: 30, department: 'QA', grade: 14 },
          // Scrum Master (SM)
          { id: 'role_65', name: 'Senior Consultant - SM', hourly_rate: 250, department: 'SM', grade: 7 },
          { id: 'role_66', name: 'Consultant - SM', hourly_rate: 190, department: 'SM', grade: 8 },
          { id: 'role_67', name: 'Associate Consultant - SM', hourly_rate: 150, department: 'SM', grade: 9 },
          { id: 'role_68', name: 'Senior Specialist - SM', hourly_rate: 115, department: 'SM', grade: 10 },
          { id: 'role_69', name: 'Specialist - SM', hourly_rate: 90, department: 'SM', grade: 11 },
          { id: 'role_70', name: 'Senior Analyst - SM', hourly_rate: 70, department: 'SM', grade: 12 },
          { id: 'role_71', name: 'Junior Analyst - SM', hourly_rate: 50, department: 'SM', grade: 13 },
          { id: 'role_72', name: 'Intern - SM', hourly_rate: 30, department: 'SM', grade: 14 },
          // CMS Development (CMS)
          { id: 'role_73', name: 'Senior Consultant - CMS', hourly_rate: 250, department: 'CMS', grade: 7 },
          { id: 'role_74', name: 'Consultant - CMS', hourly_rate: 190, department: 'CMS', grade: 8 },
          { id: 'role_75', name: 'Associate Consultant - CMS', hourly_rate: 150, department: 'CMS', grade: 9 },
          { id: 'role_76', name: 'Senior Specialist - CMS', hourly_rate: 115, department: 'CMS', grade: 10 },
          { id: 'role_77', name: 'Specialist - CMS', hourly_rate: 90, department: 'CMS', grade: 11 },
          { id: 'role_78', name: 'Senior Analyst - CMS', hourly_rate: 70, department: 'CMS', grade: 12 },
          { id: 'role_79', name: 'Junior Analyst - CMS', hourly_rate: 50, department: 'CMS', grade: 13 },
          { id: 'role_80', name: 'Intern - CMS', hourly_rate: 30, department: 'CMS', grade: 14 },
          // Data Analytics (DA)
          { id: 'role_81', name: 'Senior Consultant - DA', hourly_rate: 490.91, department: 'DA', grade: 7 },
          { id: 'role_82', name: 'Consultant - DA', hourly_rate: 409.09, department: 'DA', grade: 8 },
          { id: 'role_83', name: 'Associate Consultant - DA', hourly_rate: 318.18, department: 'DA', grade: 9 },
          { id: 'role_84', name: 'Senior Specialist - DA', hourly_rate: 227.27, department: 'DA', grade: 10 },
          { id: 'role_85', name: 'Specialist - DA', hourly_rate: 181.82, department: 'DA', grade: 11 },
          { id: 'role_86', name: 'Senior Analyst - DA', hourly_rate: 159.09, department: 'DA', grade: 12 },
          { id: 'role_87', name: 'Junior Analyst - DA', hourly_rate: 136.36, department: 'DA', grade: 13 },
          { id: 'role_88', name: 'Intern - DA', hourly_rate: 45.45, department: 'DA', grade: 14 },
          // Other
          { id: 'role_89', name: 'Web Designer', hourly_rate: 109.09, department: 'Design', grade: 15 }
        ];
        dbState.tools = [
          { id: 'tool_1', name: 'AWS Cloud Services', cost_type: 'monthly', cost: 500, description: 'Cloud infrastructure' },
          { id: 'tool_2', name: 'Azure Cloud Services', cost_type: 'monthly', cost: 500, description: 'Cloud infrastructure' },
          { id: 'tool_3', name: 'Figma Enterprise', cost_type: 'monthly', cost: 75, description: 'Design tool' },
          { id: 'tool_4', name: 'GitHub Enterprise', cost_type: 'monthly', cost: 21, description: 'Version control' },
          { id: 'tool_5', name: 'Jira', cost_type: 'monthly', cost: 10, description: 'Project tracking' },
          { id: 'tool_6', name: 'OpenAI API Credits', cost_type: 'one-time', cost: 1000, description: 'AI API usage' }
        ];
        dbState.versionHistory = [];
        dbState.templates = [];
        saveState();
      }
    };

    const saveState = () => {
      localStorage.setItem('boud_pricing_state', JSON.stringify(dbState));
    };

    // Version History tracking
    const addVersionHistory = (projectId, changeType, changeDescription, changedBy = 'User') => {
      const entry = {
        id: generateId('vh'),
        project_id: projectId,
        change_type: changeType,
        description: changeDescription,
        changed_by: changedBy,
        changed_at: new Date().toISOString()
      };
      dbState.versionHistory.push(entry);
      saveState();
    };

    // Templates management
    const getTemplates = () => dbState.templates || [];
    const saveTemplate = (template) => {
      const id = generateId('tmpl');
      dbState.templates.push({ id, ...template, created_at: new Date().toISOString() });
      saveState();
      return id;
    };
    const deleteTemplate = (id) => {
      dbState.templates = dbState.templates.filter(t => t.id !== id);
      saveState();
    };

    // Database operations
    const db = {
      getRoles: () => [...dbState.roles],
      createRole: (name, hourly_rate, description) => {
        const id = generateId('role');
        dbState.roles.push({ id, name, hourly_rate, description, updated_at: new Date().toISOString() });
        saveState();
        return id;
      },
      updateRole: (id, name, hourly_rate, description) => {
        const idx = dbState.roles.findIndex(r => r.id === id);
        if (idx !== -1) {
          const oldRate = dbState.roles[idx].hourly_rate;
          dbState.roles[idx] = { ...dbState.roles[idx], name, hourly_rate, description, updated_at: new Date().toISOString() };
          if (oldRate !== hourly_rate) {
            dbState.rateHistory.push({ id: generateId('hist'), role_id: id, old_rate: oldRate, new_rate: hourly_rate, changed_at: new Date().toISOString() });
          }
          saveState();
        }
      },
      deleteRole: (id) => {
        dbState.roles = dbState.roles.filter(r => r.id !== id);
        saveState();
      },
      updateRoleStatus: (id, status) => {
        const idx = dbState.roles.findIndex(r => r.id === id);
        if (idx !== -1) {
          dbState.roles[idx] = { ...dbState.roles[idx], status, updated_at: new Date().toISOString() };
          saveState();
        }
      },
      getRecentRoles: () => dbState.recentRoles || [],
      addRecentRole: (roleId) => {
        if (!dbState.recentRoles) dbState.recentRoles = [];
        dbState.recentRoles = [roleId, ...dbState.recentRoles.filter(id => id !== roleId)].slice(0, 8);
        saveState();
      },

      getTools: () => [...dbState.tools],
      createTool: (name, cost_type, cost, description) => {
        const id = generateId('tool');
        dbState.tools.push({ id, name, cost_type, cost, description });
        saveState();
        return id;
      },
      updateTool: (id, name, cost_type, cost, description) => {
        const idx = dbState.tools.findIndex(t => t.id === id);
        if (idx !== -1) {
          dbState.tools[idx] = { ...dbState.tools[idx], name, cost_type, cost, description };
          saveState();
        }
      },
      deleteTool: (id) => {
        dbState.tools = dbState.tools.filter(t => t.id !== id);
        saveState();
      },

      getProjects: () => [...dbState.projects].sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at)),
      getProject: (id) => dbState.projects.find(p => p.id === id),
      createProject: (data) => {
        const id = generateId('proj');
        const project = {
          id, ...data,
          status: 'draft',
          risk_margin: data.risk_margin || 0,
          discount_percent: data.discount_percent || 0,
          discount_amount: data.discount_amount || 0,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        dbState.projects.push(project);
        const phaseId = generateId('phase');
        dbState.phases.push({ id: phaseId, project_id: id, name: 'Phase 1', order_index: 0 });
        addVersionHistory(id, 'created', 'Project created');
        saveState();
        return id;
      },
      updateProject: (id, data, trackHistory = true) => {
        const idx = dbState.projects.findIndex(p => p.id === id);
        if (idx !== -1) {
          const oldProject = dbState.projects[idx];
          dbState.projects[idx] = { ...oldProject, ...data, updated_at: new Date().toISOString() };

          // Track specific changes
          if (trackHistory) {
            if (data.risk_margin !== undefined && data.risk_margin !== oldProject.risk_margin) {
              addVersionHistory(id, 'risk_margin', `Risk margin changed from ${oldProject.risk_margin || 0}% to ${data.risk_margin}%`);
            }
            if (data.discount_percent !== undefined && data.discount_percent !== oldProject.discount_percent) {
              addVersionHistory(id, 'discount', `Discount changed from ${oldProject.discount_percent || 0}% to ${data.discount_percent}%`);
            }
            if (data.target_margin !== undefined && data.target_margin !== oldProject.target_margin) {
              addVersionHistory(id, 'margin', `Target margin changed from ${oldProject.target_margin}% to ${data.target_margin}%`);
            }
          }
          saveState();
        }
      },
      deleteProject: (id) => {
        const phases = dbState.phases.filter(p => p.project_id === id);
        phases.forEach(phase => {
          dbState.resourceCosts = dbState.resourceCosts.filter(rc => rc.phase_id !== phase.id);
          dbState.toolCosts = dbState.toolCosts.filter(tc => tc.phase_id !== phase.id);
          dbState.vendorCosts = dbState.vendorCosts.filter(vc => vc.phase_id !== phase.id);
        });
        dbState.phases = dbState.phases.filter(p => p.project_id !== id);
        dbState.projects = dbState.projects.filter(p => p.id !== id);
        dbState.versionHistory = dbState.versionHistory.filter(v => v.project_id !== id);
        saveState();
      },

      getVersionHistory: (projectId) => (dbState.versionHistory || []).filter(v => v.project_id === projectId).sort((a, b) => new Date(b.changed_at) - new Date(a.changed_at)),

      getPhases: (projectId) => dbState.phases.filter(p => p.project_id === projectId).sort((a, b) => a.order_index - b.order_index),
      createPhase: (projectId, name) => {
        const id = generateId('phase');
        const phases = dbState.phases.filter(p => p.project_id === projectId);
        dbState.phases.push({ id, project_id: projectId, name, order_index: phases.length });
        addVersionHistory(projectId, 'phase_added', `Phase "${name}" added`);
        saveState();
        return id;
      },
      updatePhase: (id, name) => {
        const idx = dbState.phases.findIndex(p => p.id === id);
        if (idx !== -1) {
          dbState.phases[idx].name = name;
          saveState();
        }
      },
      deletePhase: (id) => {
        const phase = dbState.phases.find(p => p.id === id);
        if (phase) {
          addVersionHistory(phase.project_id, 'phase_deleted', `Phase "${phase.name}" deleted`);
        }
        dbState.resourceCosts = dbState.resourceCosts.filter(rc => rc.phase_id !== id);
        dbState.toolCosts = dbState.toolCosts.filter(tc => tc.phase_id !== id);
        dbState.vendorCosts = dbState.vendorCosts.filter(vc => vc.phase_id !== id);
        dbState.phases = dbState.phases.filter(p => p.id !== id);
        saveState();
      },

      getResourceCosts: (phaseId) => {
        return dbState.resourceCosts.filter(rc => rc.phase_id === phaseId).map(rc => {
          const role = dbState.roles.find(r => r.id === rc.role_id);
          const effectiveRate = rc.rate_override || role?.hourly_rate || 0;
          return { ...rc, role_name: role?.name || 'Unknown', default_rate: role?.hourly_rate, effective_rate: effectiveRate, total: rc.hours * effectiveRate };
        });
      },
      addResourceCost: (phaseId, roleId, hours, rateOverride, notes) => {
        const id = generateId('rc');
        dbState.resourceCosts.push({ id, phase_id: phaseId, role_id: roleId, hours, rate_override: rateOverride, notes });
        saveState();
        return id;
      },
      updateResourceCost: (id, hours, rateOverride, notes) => {
        const idx = dbState.resourceCosts.findIndex(rc => rc.id === id);
        if (idx !== -1) {
          dbState.resourceCosts[idx] = { ...dbState.resourceCosts[idx], hours, rate_override: rateOverride, notes };
          saveState();
        }
      },
      deleteResourceCost: (id) => {
        dbState.resourceCosts = dbState.resourceCosts.filter(rc => rc.id !== id);
        saveState();
      },

      getToolCosts: (phaseId) => {
        return dbState.toolCosts.filter(tc => tc.phase_id === phaseId).map(tc => ({ ...tc, total: tc.cost * tc.quantity }));
      },
      addToolCost: (phaseId, data) => {
        const id = generateId('tc');
        dbState.toolCosts.push({ id, phase_id: phaseId, ...data, quantity: data.quantity || 1 });
        saveState();
        return id;
      },
      updateToolCost: (id, data) => {
        const idx = dbState.toolCosts.findIndex(tc => tc.id === id);
        if (idx !== -1) {
          dbState.toolCosts[idx] = { ...dbState.toolCosts[idx], ...data };
          saveState();
        }
      },
      deleteToolCost: (id) => {
        dbState.toolCosts = dbState.toolCosts.filter(tc => tc.id !== id);
        saveState();
      },

      getVendorCosts: (phaseId) => dbState.vendorCosts.filter(vc => vc.phase_id === phaseId),
      addVendorCost: (phaseId, data) => {
        const id = generateId('vc');
        dbState.vendorCosts.push({ id, phase_id: phaseId, ...data });
        saveState();
        return id;
      },
      updateVendorCost: (id, data) => {
        const idx = dbState.vendorCosts.findIndex(vc => vc.id === id);
        if (idx !== -1) {
          dbState.vendorCosts[idx] = { ...dbState.vendorCosts[idx], ...data };
          saveState();
        }
      },
      deleteVendorCost: (id) => {
        dbState.vendorCosts = dbState.vendorCosts.filter(vc => vc.id !== id);
        saveState();
      },

      calculateProjectTotals: (projectId) => {
        const phases = db.getPhases(projectId);
        const project = db.getProject(projectId);
        let totalResourceCost = 0, totalToolCost = 0, totalVendorCost = 0, totalHours = 0;

        phases.forEach(phase => {
          const resources = db.getResourceCosts(phase.id);
          const tools = db.getToolCosts(phase.id);
          const vendors = db.getVendorCosts(phase.id);
          totalResourceCost += resources.reduce((sum, r) => sum + r.total, 0);
          totalToolCost += tools.reduce((sum, t) => sum + t.total, 0);
          totalVendorCost += vendors.reduce((sum, v) => sum + v.cost, 0);
          totalHours += resources.reduce((sum, r) => sum + r.hours, 0);
        });

        // SaaS recurring revenue
        const saasMonthly = project?.saas_monthly_price || 0;
        const saasYearly = project?.saas_yearly_price || 0;
        const saasAnnualRevenue = saasYearly || (saasMonthly * 12);

        // Setup fees
        const setupFee = project?.setup_fee || 0;

        // API hits revenue
        const apiBasePrices = getApiBasePrices();
        const apiType = project?.api_type || '';
        const apiBasePrice = apiType ? (apiBasePrices[apiType] || 0) : 0;
        const apiMarkup = project?.api_markup || 0;
        const apiPricePerHit = apiBasePrice + apiMarkup;
        const apiExpectedHits = project?.api_expected_hits || 0;
        const apiMonthlyRevenue = apiPricePerHit * apiExpectedHits;
        const apiAnnualRevenue = apiMonthlyRevenue * 12;

        // Product fees
        const productFees = getProductFees();
        const selectedProducts = project?.selected_products || [];
        let productSetupTotal = 0;
        let productLicenseAnnual = 0;
        selectedProducts.forEach(sp => {
          const fees = productFees[sp.id] || {};
          productSetupTotal += fees.setup || 0;
          if (sp.billing_cycle === 'weekly') productLicenseAnnual += (fees.weekly || 0) * 52;
          else if (sp.billing_cycle === 'monthly') productLicenseAnnual += (fees.monthly || 0) * 12;
          else if (sp.billing_cycle === 'yearly') productLicenseAnnual += fees.yearly || 0;
        });
        const productTotalAnnual = productSetupTotal + productLicenseAnnual;

        // Total hourly-based cost
        const totalHourlyCost = totalResourceCost + totalToolCost + totalVendorCost;

        // Risk margin (extra buffer)
        const riskMarginPercent = project?.risk_margin || 0;
        const riskMarginAmount = totalHourlyCost * (riskMarginPercent / 100);

        // Target margin and selling price calculation
        const targetMargin = project?.target_margin || 30;
        const costWithRisk = totalHourlyCost + riskMarginAmount;
        const hourlySellingPrice = costWithRisk > 0 ? costWithRisk / (1 - targetMargin / 100) : 0;

        // Total before discount
        const subtotal = hourlySellingPrice + setupFee + saasAnnualRevenue + apiAnnualRevenue + productTotalAnnual;

        // Discount calculation
        const discountPercent = project?.discount_percent || 0;
        const discountAmount = project?.discount_amount || (subtotal * (discountPercent / 100));

        // Final selling price
        const sellingPrice = subtotal - discountAmount;
        const totalCost = totalHourlyCost;
        const grossProfit = sellingPrice - totalCost - riskMarginAmount;
        const actualMargin = sellingPrice > 0 ? (grossProfit / sellingPrice) * 100 : 0;

        return {
          totalResourceCost, totalToolCost, totalVendorCost, totalHourlyCost, totalHours,
          hourlySellingPrice,
          saasMonthly, saasYearly, saasAnnualRevenue,
          setupFee,
          apiType, apiBasePrice, apiMarkup, apiPricePerHit, apiExpectedHits, apiMonthlyRevenue, apiAnnualRevenue,
          selectedProducts, productSetupTotal, productLicenseAnnual, productTotalAnnual,
          riskMarginPercent, riskMarginAmount,
          discountPercent, discountAmount, subtotal,
          totalCost, sellingPrice, grossProfit, targetMargin, actualMargin,
          pricingModels: project?.pricing_models || ['hourly']
        };
      }
    };

    // Product List
    const PRODUCT_LIST = [
      { id: 'salis', name: 'Salis', description: 'Sales Management Platform' },
      { id: 'wafir', name: 'Wafir', description: 'Financial Optimization Tool' },
      { id: 'hackify', name: 'Hackify', description: 'Development Platform' },
      { id: 'connect_ai', name: 'Connect AI', description: 'AI Integration Suite' },
      { id: 'riyali', name: 'Riyali', description: 'Financial Analytics' }
    ];

    // API List
    const API_LIST = [
      { id: 'wathq', name: 'Wathq', description: 'Commercial Registration API' },
      { id: 'spl', name: 'SPL', description: 'Saudi Post Logistics API' },
      { id: 'moj', name: 'MOJ', description: 'Ministry of Justice API' },
      { id: 'gosi', name: 'GOSI', description: 'General Organization for Social Insurance API' }
    ];

    // Get settings from localStorage
    const getProductFees = () => {
      const saved = localStorage.getItem('boud_product_fees');
      if (saved) return JSON.parse(saved);
      return { salis: { setup: 0, weekly: 0, monthly: 0, yearly: 0 }, wafir: { setup: 0, weekly: 0, monthly: 0, yearly: 0 }, hackify: { setup: 0, weekly: 0, monthly: 0, yearly: 0 }, connect_ai: { setup: 0, weekly: 0, monthly: 0, yearly: 0 }, riyali: { setup: 0, weekly: 0, monthly: 0, yearly: 0 } };
    };

    const getApiBasePrices = () => {
      const saved = localStorage.getItem('boud_api_base_prices');
      if (saved) return JSON.parse(saved);
      return { wathq: 0, spl: 0, moj: 0, gosi: 0 };
    };

    // Theme management
    const getTheme = () => localStorage.getItem('boud_theme') || 'light';
    const setTheme = (theme) => {
      localStorage.setItem('boud_theme', theme);
      document.documentElement.setAttribute('data-theme', theme);
    };

    // Auth state
    const isLoggedIn = () => localStorage.getItem('boud_logged_in') === 'true';
    const setLoggedIn = (val) => localStorage.setItem('boud_logged_in', val ? 'true' : 'false');

    // Format currency
    const formatCurrency = (amount) => new Intl.NumberFormat('en-SA', { style: 'currency', currency: 'SAR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount || 0);

    // Export Proposal to printable view
    const handleExportProposal = (project, phases, totals, vatRate) => {
      const priceWithVat = totals.sellingPrice * (1 + vatRate / 100);
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Proposal - ${project.name}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 40px; color: #231F20; line-height: 1.6; }
            .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; padding-bottom: 24px; border-bottom: 3px solid #def763; }
            .logo { font-size: 28px; font-weight: 700; color: #231F20; }
            .logo span { color: #5e56de; }
            .doc-info { text-align: right; }
            .doc-info h1 { font-size: 24px; color: #231F20; margin-bottom: 8px; }
            .doc-info p { color: #666; font-size: 14px; }
            .section { margin-bottom: 32px; }
            .section h2 { font-size: 18px; color: #5e56de; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
            .project-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .detail-item { padding: 12px; background: #f9f9f9; border-radius: 8px; }
            .detail-item .label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
            .detail-item .value { font-size: 16px; font-weight: 600; color: #231F20; margin-top: 4px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
            th { text-align: left; padding: 12px; background: #f4f4f4; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; border-bottom: 2px solid #ddd; }
            td { padding: 12px; border-bottom: 1px solid #eee; }
            .phase-name { font-weight: 600; color: #5e56de; background: #f9f9ff; }
            .subtotal { font-weight: 600; background: #f9f9f9; }
            .pricing-summary { background: #231F20; color: white; padding: 24px; border-radius: 12px; margin-top: 32px; }
            .pricing-summary h2 { color: #def763; border-bottom-color: rgba(255,255,255,0.2); }
            .pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px; }
            .pricing-item { text-align: center; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 8px; }
            .pricing-item .label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; }
            .pricing-item .value { font-size: 20px; font-weight: 700; margin-top: 4px; }
            .pricing-item .value.highlight { color: #def763; }
            .pricing-item .value.success { color: #4ADE80; }
            .pricing-item .value.orange { color: #e46a17; }
            .footer { margin-top: 48px; padding-top: 24px; border-top: 1px solid #eee; text-align: center; color: #999; font-size: 12px; }
            @media print { body { padding: 20px; } .pricing-summary { break-inside: avoid; } }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="logo">B<span>OUD</span></div>
            <div class="doc-info">
              <h1>Project Proposal</h1>
              <p>Generated: ${new Date().toLocaleDateString('en-SA', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>
          </div>

          <div class="section">
            <h2>Project Details</h2>
            <div class="project-details">
              <div class="detail-item"><div class="label">Project Name</div><div class="value">${project.name}</div></div>
              <div class="detail-item"><div class="label">Client</div><div class="value">${project.client || 'N/A'}</div></div>
              <div class="detail-item"><div class="label">Duration</div><div class="value">${project.duration_weeks ? project.duration_weeks + ' weeks' : 'N/A'}</div></div>
              <div class="detail-item"><div class="label">Target Margin</div><div class="value">${project.target_margin || 30}%</div></div>
            </div>
          </div>

          <div class="section">
            <h2>Cost Breakdown</h2>
            <table>
              <thead><tr><th>Item</th><th>Details</th><th style="text-align:right">Amount</th></tr></thead>
              <tbody>
                ${phases.map(phase => `
                  <tr class="phase-name"><td colspan="3">${phase.name}</td></tr>
                  ${phase.resources.map(r => `<tr><td style="padding-left:24px">${r.role_name}</td><td>${r.hours} hrs @ SAR ${r.rate}/hr</td><td style="text-align:right">SAR ${r.total.toLocaleString()}</td></tr>`).join('')}
                  ${phase.tools.map(t => `<tr><td style="padding-left:24px">${t.tool_name}</td><td>${t.cost_type === 'monthly' ? 'Monthly' : t.cost_type === 'yearly' ? 'Yearly' : 'One-time'}</td><td style="text-align:right">SAR ${t.total.toLocaleString()}</td></tr>`).join('')}
                  ${phase.vendors.map(v => `<tr><td style="padding-left:24px">${v.vendor_name}</td><td>${v.description || 'Vendor'}</td><td style="text-align:right">SAR ${v.cost.toLocaleString()}</td></tr>`).join('')}
                `).join('')}
                <tr class="subtotal"><td colspan="2">Total Cost</td><td style="text-align:right">SAR ${totals.totalCost.toLocaleString()}</td></tr>
              </tbody>
            </table>
          </div>

          <div class="pricing-summary">
            <h2>Pricing Summary</h2>
            <div class="pricing-grid">
              <div class="pricing-item"><div class="label">Total Cost</div><div class="value">SAR ${totals.totalCost.toLocaleString()}</div></div>
              ${totals.riskMarginPercent > 0 ? `<div class="pricing-item"><div class="label">Risk Buffer (${totals.riskMarginPercent}%)</div><div class="value orange">SAR ${totals.riskMarginAmount.toLocaleString()}</div></div>` : ''}
              <div class="pricing-item"><div class="label">Subtotal</div><div class="value">SAR ${totals.subtotal.toLocaleString()}</div></div>
              ${totals.discountPercent > 0 ? `<div class="pricing-item"><div class="label">Discount (${totals.discountPercent}%)</div><div class="value orange">-SAR ${totals.discountAmount.toLocaleString()}</div></div>` : ''}
              <div class="pricing-item"><div class="label">Selling Price</div><div class="value highlight">SAR ${totals.sellingPrice.toLocaleString()}</div></div>
              <div class="pricing-item"><div class="label">With VAT (${vatRate}%)</div><div class="value">SAR ${Math.round(priceWithVat).toLocaleString()}</div></div>
              <div class="pricing-item"><div class="label">Profit Margin</div><div class="value success">${totals.actualMargin.toFixed(1)}%</div></div>
            </div>
          </div>

          <div class="footer">
            <p>This proposal was generated by Boud Pricing Engine</p>
            <p>Valid for 30 days from the date of issue</p>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 250);
    };

    // Export Proposal to CSV
    const handleExportCSV = (project, phases, totals, vatRate) => {
      const priceWithVat = totals.sellingPrice * (1 + vatRate / 100);
      const rows = [];

      // Header info
      rows.push(['BOUD PRICING ENGINE - PROJECT PROPOSAL']);
      rows.push(['Generated', new Date().toLocaleDateString('en-SA', { year: 'numeric', month: 'long', day: 'numeric' })]);
      rows.push([]);

      // Project details
      rows.push(['PROJECT DETAILS']);
      rows.push(['Project Name', project.name]);
      rows.push(['Client', project.client || 'N/A']);
      rows.push(['Duration', project.duration_weeks ? project.duration_weeks + ' weeks' : 'N/A']);
      rows.push(['Target Margin', (project.target_margin || 30) + '%']);
      rows.push([]);

      // Cost breakdown
      rows.push(['COST BREAKDOWN']);
      rows.push(['Phase', 'Item', 'Type', 'Details', 'Amount (SAR)']);

      phases.forEach(phase => {
        phase.resources.forEach(r => {
          rows.push([phase.name, r.role_name, 'Resource', r.hours + ' hrs @ ' + r.rate + '/hr', r.total]);
        });
        phase.tools.forEach(t => {
          rows.push([phase.name, t.tool_name, 'Tool', t.cost_type === 'monthly' ? 'Monthly' : t.cost_type === 'yearly' ? 'Yearly' : 'One-time', t.total]);
        });
        phase.vendors.forEach(v => {
          rows.push([phase.name, v.vendor_name, 'Vendor', v.description || '', v.cost]);
        });
      });

      rows.push([]);

      // Pricing summary
      rows.push(['PRICING SUMMARY']);
      rows.push(['Total Cost', '', '', '', totals.totalCost]);
      if (totals.riskMarginPercent > 0) {
        rows.push(['Risk Buffer (' + totals.riskMarginPercent + '%)', '', '', '', totals.riskMarginAmount]);
      }
      rows.push(['Subtotal', '', '', '', totals.subtotal]);
      if (totals.discountPercent > 0) {
        rows.push(['Discount (' + totals.discountPercent + '%)', '', '', '', -totals.discountAmount]);
      }
      rows.push(['Selling Price', '', '', '', totals.sellingPrice]);
      rows.push(['With VAT (' + vatRate + '%)', '', '', '', Math.round(priceWithVat)]);
      rows.push(['Profit Margin', '', '', '', totals.actualMargin.toFixed(1) + '%']);

      // Convert to CSV
      const csvContent = rows.map(row => row.map(cell => {
        const cellStr = String(cell === undefined || cell === null ? '' : cell);
        return cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')
          ? '"' + cellStr.replace(/"/g, '""') + '"'
          : cellStr;
      }).join(',')).join('\n');

      // Download
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = project.name.replace(/[^a-z0-9]/gi, '_') + '_proposal.csv';
      link.click();
    };

    // Boud Logo Component (SVG based on brand guidelines - curved B shape)
    const BoudLogo = ({ size = 36, showText = true }) => (
      <div style={{display: 'flex', alignItems: 'center', gap: 12}}>
        <svg width={size} height={size} viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="100" height="100" rx="16" fill="#def763"/>
          <path d="M25 20 C25 20 25 80 25 80 C25 80 55 80 65 70 C75 60 75 50 65 45 C55 40 45 45 45 45 C45 45 60 45 65 35 C70 25 60 20 50 20 C40 20 25 20 25 20 Z" fill="#231F20"/>
          <circle cx="42" cy="35" r="8" fill="#def763"/>
          <circle cx="45" cy="60" r="10" fill="#def763"/>
        </svg>
        {showText && (
          <div>
            <div style={{fontSize: size * 0.6, fontWeight: 700, color: 'white', letterSpacing: '0.05em'}}>BOUD</div>
            <div style={{fontSize: size * 0.28, color: 'var(--boud-lime)', textTransform: 'uppercase', letterSpacing: '0.1em'}}>Pricing Engine</div>
          </div>
        )}
      </div>
    );

    // Auth Pages Component
    const AuthPage = ({ onLogin }) => {
      const [isSignUp, setIsSignUp] = React.useState(false);
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [name, setName] = React.useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        // Bypass auth - just log in
        setLoggedIn(true);
        onLogin();
      };

      return (
        <div className="auth-container">
          <div className="auth-left">
            <BoudLogo size={56} showText={true} />
            <div style={{marginTop: 48, textAlign: 'center', maxWidth: 400}}>
              <h2 style={{fontSize: 28, marginBottom: 16, color: 'white'}}>Smart Pricing for Your Projects</h2>
              <p style={{opacity: 0.9, lineHeight: 1.7}}>
                Create accurate project quotes with multiple pricing models, track margins, and close deals faster.
              </p>
            </div>
            <div style={{display: 'flex', gap: 16, marginTop: 48}}>
              <div style={{textAlign: 'center', padding: 16}}>
                <div style={{fontSize: 32, fontWeight: 700, color: 'var(--boud-lime)'}}>5</div>
                <div style={{fontSize: 13, opacity: 0.8}}>Pricing Models</div>
              </div>
              <div style={{textAlign: 'center', padding: 16}}>
                <div style={{fontSize: 32, fontWeight: 700, color: 'var(--boud-lime)'}}></div>
                <div style={{fontSize: 13, opacity: 0.8}}>Projects</div>
              </div>
              <div style={{textAlign: 'center', padding: 16}}>
                <div style={{fontSize: 32, fontWeight: 700, color: 'var(--boud-lime)'}}>100%</div>
                <div style={{fontSize: 13, opacity: 0.8}}>Local Data</div>
              </div>
            </div>
          </div>
          <div className="auth-right">
            <div className="auth-form">
              <h1 className="auth-title">{isSignUp ? 'Create Account' : 'Welcome Back'}</h1>
              <p className="auth-subtitle">{isSignUp ? 'Start building your pricing engine' : 'Sign in to continue to Boud'}</p>

              <form onSubmit={handleSubmit}>
                {isSignUp && (
                  <div className="form-group">
                    <label className="form-label">Full Name</label>
                    <input type="text" className="form-input" placeholder="Enter your name" value={name} onChange={e => setName(e.target.value)} />
                  </div>
                )}
                <div className="form-group">
                  <label className="form-label">Email Address</label>
                  <input type="email" className="form-input" placeholder="name@company.com" value={email} onChange={e => setEmail(e.target.value)} />
                </div>
                <div className="form-group">
                  <label className="form-label">Password</label>
                  <input type="password" className="form-input" placeholder="" value={password} onChange={e => setPassword(e.target.value)} />
                </div>
                {!isSignUp && (
                  <div style={{textAlign: 'right', marginBottom: 16}}>
                    <span className="auth-link" style={{fontSize: 13}}>Forgot password?</span>
                  </div>
                )}
                <button type="submit" className="btn btn-purple" style={{width: '100%', padding: '12px 24px', fontSize: 15}}>
                  {isSignUp ? 'Create Account' : 'Sign In'}
                </button>
              </form>

              <div className="auth-divider">or continue with</div>

              <div style={{display: 'flex', gap: 12}}>
                <button className="btn btn-secondary" style={{flex: 1}} onClick={handleSubmit}>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                  Google
                </button>
                <button className="btn btn-secondary" style={{flex: 1}} onClick={handleSubmit}>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.866-.013-1.7-2.782.604-3.369-1.341-3.369-1.341-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.071 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.163 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg>
                  GitHub
                </button>
              </div>

              <p style={{textAlign: 'center', marginTop: 24, fontSize: 14, color: 'var(--gray-text)'}}>
                {isSignUp ? 'Already have an account?' : "Don't have an account?"}{' '}
                <span className="auth-link" onClick={() => setIsSignUp(!isSignUp)}>
                  {isSignUp ? 'Sign In' : 'Sign Up'}
                </span>
              </p>

              <p style={{textAlign: 'center', marginTop: 16, fontSize: 12, color: 'var(--gray-text)'}}>
                Demo Mode: Click any button to enter the app
              </p>
            </div>
          </div>
        </div>
      );
    };

    // Sidebar Component
    const Sidebar = ({ currentView, onNavigate, theme, onToggleTheme, onOpenNotifications, notificationCount, onLogout }) => {
      const [pricingExpanded, setPricingExpanded] = React.useState(['rates', 'tools', 'api-settings', 'product-fees'].includes(currentView));

      const mainNavItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
        { id: 'insights', label: 'Insights', icon: 'bar-chart-3' },
        { id: 'projects', label: 'Projects', icon: 'folder-open' },
        { id: 'templates', label: 'Templates', icon: 'file-stack' },
      ];

      const pricingNavItems = [
        { id: 'rates', label: 'Role Rates', icon: 'users' },
        { id: 'tools', label: 'Tools & Subscriptions', icon: 'wrench' },
        { id: 'api-settings', label: 'API Pricing', icon: 'zap' },
        { id: 'product-fees', label: 'Product Fees', icon: 'package' },
      ];

      React.useEffect(() => { lucide.createIcons(); }, [currentView, pricingExpanded]);

      return (
        <aside className="sidebar">
          <div className="logo">
            <BoudLogo size={36} showText={true} />
          </div>

          <div style={{display: 'flex', gap: 8, marginBottom: 16, padding: '0 8px'}}>
            <button onClick={onToggleTheme} className="btn btn-icon" style={{flex: 1, background: 'rgba(255,255,255,0.1)', color: 'white', justifyContent: 'center'}}>
              <i data-lucide={theme === 'dark' ? 'sun' : 'moon'} style={{width: 16, height: 16}}></i>
            </button>
            <button onClick={onOpenNotifications} className="btn btn-icon" style={{flex: 1, background: 'rgba(255,255,255,0.1)', color: 'white', justifyContent: 'center', position: 'relative'}}>
              <i data-lucide="bell" style={{width: 16, height: 16}}></i>
              {notificationCount > 0 && (
                <span style={{position: 'absolute', top: 4, right: 4, width: 16, height: 16, background: 'var(--error)', borderRadius: '50%', fontSize: 10, display: 'flex', alignItems: 'center', justifyContent: 'center'}}>{notificationCount}</span>
              )}
            </button>
          </div>

          <nav style={{flex: 1}}>
            <ul className="nav-menu">
              {mainNavItems.map(item => (
                <li key={item.id} className={`nav-item ${currentView === item.id ? 'active' : ''}`} onClick={() => onNavigate(item.id)}>
                  <i data-lucide={item.icon}></i>
                  <span>{item.label}</span>
                </li>
              ))}

              <li className="nav-item" onClick={() => setPricingExpanded(!pricingExpanded)} style={{marginTop: 8}}>
                <i data-lucide="calculator"></i>
                <span style={{flex: 1}}>Pricing Settings</span>
                <i data-lucide={pricingExpanded ? 'chevron-down' : 'chevron-right'} style={{width: 16, height: 16, opacity: 0.5}}></i>
              </li>
              {pricingExpanded && (
                <div style={{marginLeft: 16, borderLeft: '2px solid rgba(255,255,255,0.1)', paddingLeft: 8}}>
                  {pricingNavItems.map(item => (
                    <li key={item.id} className={`nav-item ${currentView === item.id ? 'active' : ''}`} onClick={() => onNavigate(item.id)} style={{fontSize: 13, padding: '10px 12px'}}>
                      <i data-lucide={item.icon} style={{width: 16, height: 16}}></i>
                      <span>{item.label}</span>
                    </li>
                  ))}
                </div>
              )}

              <li className={`nav-item ${currentView === 'settings' ? 'active' : ''}`} onClick={() => onNavigate('settings')} style={{marginTop: 8}}>
                <i data-lucide="settings"></i>
                <span>Settings</span>
              </li>
            </ul>
          </nav>

          <div style={{borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: 16, marginTop: 16}}>
            <button onClick={onLogout} className="btn" style={{width: '100%', background: 'rgba(255,255,255,0.1)', color: 'white', justifyContent: 'flex-start'}}>
              <i data-lucide="log-out" style={{width: 16, height: 16}}></i>
              <span>Sign Out</span>
            </button>
          </div>
        </aside>
      );
    };

    // Templates Library Component
    const TemplatesLibrary = ({ onNavigate, onRefresh }) => {
      const [templates, setTemplates] = React.useState([]);
      const [isCreateModalOpen, setIsCreateModalOpen] = React.useState(false);

      const loadTemplates = () => {
        setTemplates(getTemplates());
        setTimeout(() => lucide.createIcons(), 0);
      };

      React.useEffect(() => { loadTemplates(); }, []);

      const handleDelete = (id) => {
        if (confirm('Delete this template?')) {
          deleteTemplate(id);
          loadTemplates();
        }
      };

      const handleUseTemplate = (template) => {
        const projectData = {
          name: `${template.name} (Copy)`,
          client: '',
          duration_weeks: template.config.duration_weeks,
          target_margin: template.config.target_margin,
          pricing_models: template.config.pricing_models,
          risk_margin: template.config.risk_margin || 0,
          saas_monthly_price: template.config.saas_monthly_price,
          saas_yearly_price: template.config.saas_yearly_price,
          setup_fee: template.config.setup_fee,
          api_type: template.config.api_type,
          api_markup: template.config.api_markup,
          api_expected_hits: template.config.api_expected_hits,
          selected_products: template.config.selected_products || []
        };
        const id = db.createProject(projectData);
        onNavigate('project-pricing', id);
      };

      return (
        <div>
          <div className="page-header">
            <div>
              <h1 className="page-title">Templates Library</h1>
              <p className="text-secondary">Reusable project configurations</p>
            </div>
            <button className="btn btn-primary" onClick={() => setIsCreateModalOpen(true)}>
              <i data-lucide="plus" style={{width: 18, height: 18}}></i> Create from Project
            </button>
          </div>

          {templates.length === 0 ? (
            <div className="card">
              <div className="empty-state">
                <i data-lucide="file-stack" style={{width: 48, height: 48, color: 'var(--gray-text)', marginBottom: 16}}></i>
                <h3>No Templates Yet</h3>
                <p style={{marginTop: 8}}>Save project configurations as templates for quick reuse.</p>
              </div>
            </div>
          ) : (
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 16}}>
              {templates.map(template => (
                <div key={template.id} className="card">
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12}}>
                    <div>
                      <h3 style={{margin: 0, fontSize: 16}}>{template.name}</h3>
                      <p className="text-secondary" style={{margin: '4px 0 0', fontSize: 13}}>{template.description || 'No description'}</p>
                    </div>
                    <span className="badge badge-purple">Template</span>
                  </div>
                  <div style={{fontSize: 13, color: 'var(--gray-text)', marginBottom: 16}}>
                    <div>Margin: {template.config.target_margin}%</div>
                    <div>Models: {template.config.pricing_models?.join(', ') || 'hourly'}</div>
                    {template.config.risk_margin > 0 && <div>Risk Buffer: {template.config.risk_margin}%</div>}
                  </div>
                  <div style={{display: 'flex', gap: 8}}>
                    <button className="btn btn-primary btn-sm" onClick={() => handleUseTemplate(template)}>Use Template</button>
                    <button className="btn btn-icon btn-sm" onClick={() => handleDelete(template.id)} style={{color: 'var(--error)'}}><i data-lucide="trash-2" style={{width: 14, height: 14}}></i></button>
                  </div>
                </div>
              ))}
            </div>
          )}

          {isCreateModalOpen && <CreateTemplateModal onClose={() => setIsCreateModalOpen(false)} onSave={() => { loadTemplates(); setIsCreateModalOpen(false); }} />}
        </div>
      );
    };

    // Create Template Modal
    const CreateTemplateModal = ({ onClose, onSave }) => {
      const [name, setName] = React.useState('');
      const [description, setDescription] = React.useState('');
      const [selectedProject, setSelectedProject] = React.useState('');
      const projects = db.getProjects();

      React.useEffect(() => { lucide.createIcons(); }, []);

      const handleSave = () => {
        if (!name || !selectedProject) return;
        const project = db.getProject(selectedProject);
        if (!project) return;

        saveTemplate({
          name,
          description,
          config: {
            duration_weeks: project.duration_weeks,
            target_margin: project.target_margin,
            pricing_models: project.pricing_models,
            risk_margin: project.risk_margin,
            saas_monthly_price: project.saas_monthly_price,
            saas_yearly_price: project.saas_yearly_price,
            setup_fee: project.setup_fee,
            api_type: project.api_type,
            api_markup: project.api_markup,
            api_expected_hits: project.api_expected_hits,
            selected_products: project.selected_products
          }
        });
        onSave();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>Create Template from Project</h3>
              <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
            </div>
            <div className="modal-body">
              <div className="form-group">
                <label className="form-label">Template Name *</label>
                <input type="text" className="form-input" value={name} onChange={e => setName(e.target.value)} placeholder="e.g., Standard SaaS Project" />
              </div>
              <div className="form-group">
                <label className="form-label">Description</label>
                <textarea className="form-textarea" rows={2} value={description} onChange={e => setDescription(e.target.value)} placeholder="Brief description of when to use this template" />
              </div>
              <div className="form-group">
                <label className="form-label">Base Project *</label>
                <select className="form-select" value={selectedProject} onChange={e => setSelectedProject(e.target.value)}>
                  <option value="">Select a project</option>
                  {projects.map(p => (
                    <option key={p.id} value={p.id}>{p.name}</option>
                  ))}
                </select>
              </div>
            </div>
            <div className="modal-footer">
              <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
              <button className="btn btn-primary" onClick={handleSave} disabled={!name || !selectedProject}>Save Template</button>
            </div>
          </div>
        </div>
      );
    };

    // Role Selector Component - Enhanced with search, department tabs, and recent roles
    const RoleSelector = ({ roles, value, onChange, formatCurrency }) => {
      const [isOpen, setIsOpen] = React.useState(false);
      const [search, setSearch] = React.useState('');
      const [activeDept, setActiveDept] = React.useState('all');
      const dropdownRef = React.useRef(null);

      const departments = ['all', 'PO', 'PM', 'BA', 'UXUI', 'FE', 'Mobile', 'BE', 'QA', 'SM', 'CMS', 'DA', 'Design'];
      const recentRoleIds = db.getRecentRoles();
      const activeRoles = roles.filter(r => r.status !== 'inactive' && r.status !== 'hidden');
      const selectedRole = roles.find(r => r.id === value);

      // Filter roles by search and department
      const filteredRoles = activeRoles.filter(r => {
        const matchesSearch = !search || r.name.toLowerCase().includes(search.toLowerCase());
        const matchesDept = activeDept === 'all' || r.department === activeDept;
        return matchesSearch && matchesDept;
      });

      // Get recent roles that exist and are active
      const recentRoles = recentRoleIds.map(id => activeRoles.find(r => r.id === id)).filter(Boolean).slice(0, 5);

      // Close dropdown when clicking outside
      React.useEffect(() => {
        const handleClickOutside = (e) => {
          if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setIsOpen(false);
        };
        if (isOpen) document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [isOpen]);

      React.useEffect(() => { if (isOpen) setTimeout(() => lucide.createIcons(), 0); }, [isOpen]);

      const handleSelect = (role) => {
        onChange(role.id);
        db.addRecentRole(role.id);
        setIsOpen(false);
        setSearch('');
      };

      return (
        <div className="role-selector" ref={dropdownRef}>
          <div className={`role-selector-trigger ${isOpen ? 'open' : ''}`} onClick={() => setIsOpen(!isOpen)}>
            {selectedRole ? (
              <span><strong>{selectedRole.name}</strong> - {formatCurrency(selectedRole.hourly_rate)}/hr</span>
            ) : (
              <span className="role-selector-placeholder">Select a role...</span>
            )}
            <i data-lucide={isOpen ? 'chevron-up' : 'chevron-down'} style={{width: 18, height: 18, color: 'var(--gray-text)'}}></i>
          </div>
          {isOpen && (
            <div className="role-selector-dropdown">
              <div className="role-selector-search">
                <input type="text" placeholder="Search roles..." value={search} onChange={e => setSearch(e.target.value)} autoFocus />
              </div>
              <div className="role-selector-tabs">
                {departments.map(dept => (
                  <button key={dept} className={`role-selector-tab ${activeDept === dept ? 'active' : ''}`} onClick={() => setActiveDept(dept)}>
                    {dept === 'all' ? 'All' : dept}
                  </button>
                ))}
              </div>
              <div className="role-selector-list">
                {!search && activeDept === 'all' && recentRoles.length > 0 && (
                  <div className="role-selector-section">
                    <div className="role-selector-section-title">Recent</div>
                    {recentRoles.map(role => (
                      <div key={role.id} className={`role-selector-item ${value === role.id ? 'selected' : ''}`} onClick={() => handleSelect(role)}>
                        <div>
                          <span className="role-selector-item-name">{role.name}</span>
                          <span className="role-selector-item-dept">{role.department}</span>
                        </div>
                        <span className="role-selector-item-rate">{formatCurrency(role.hourly_rate)}/hr</span>
                      </div>
                    ))}
                  </div>
                )}
                <div className="role-selector-section">
                  {(search || activeDept !== 'all' || recentRoles.length === 0) && <div className="role-selector-section-title">{activeDept === 'all' ? 'All Roles' : activeDept}</div>}
                  {filteredRoles.length === 0 ? (
                    <div className="role-selector-empty">No roles found</div>
                  ) : (
                    filteredRoles.map(role => (
                      <div key={role.id} className={`role-selector-item ${value === role.id ? 'selected' : ''}`} onClick={() => handleSelect(role)}>
                        <div>
                          <span className="role-selector-item-name">{role.name}</span>
                          {activeDept === 'all' && <span className="role-selector-item-dept">{role.department}</span>}
                        </div>
                        <span className="role-selector-item-rate">{formatCurrency(role.hourly_rate)}/hr</span>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Notification Center
    const NotificationCenter = ({ isOpen, onClose, notifications, onMarkRead, onClearAll }) => {
      React.useEffect(() => { lucide.createIcons(); }, [isOpen, notifications]);

      const getIcon = (type) => {
        switch(type) {
          case 'success': return { icon: 'check-circle', color: 'var(--success)' };
          case 'warning': return { icon: 'alert-triangle', color: 'var(--warning)' };
          case 'error': return { icon: 'alert-circle', color: 'var(--error)' };
          default: return { icon: 'info', color: 'var(--boud-purple)' };
        }
      };

      return (
        <>
          <div className={`notification-overlay ${isOpen ? 'open' : ''}`} onClick={onClose}></div>
          <div className={`notification-panel ${isOpen ? 'open' : ''}`}>
            <div style={{padding: 20, borderBottom: '1px solid var(--boud-light-gray)', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
              <h3 style={{margin: 0}}>Notifications</h3>
              <div style={{display: 'flex', gap: 8}}>
                <button className="btn btn-secondary btn-sm" onClick={onClearAll}>Clear All</button>
                <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
              </div>
            </div>
            <div>
              {notifications.length === 0 ? (
                <div style={{padding: 40, textAlign: 'center', color: 'var(--gray-text)'}}>No notifications</div>
              ) : (
                notifications.map(notif => {
                  const { icon, color } = getIcon(notif.type);
                  return (
                    <div key={notif.id} className={`notification-item ${!notif.read ? 'unread' : ''}`} onClick={() => onMarkRead(notif.id)}>
                      <div style={{display: 'flex', gap: 12}}>
                        <i data-lucide={icon} style={{width: 20, height: 20, color, flexShrink: 0}}></i>
                        <div style={{flex: 1}}>
                          <div style={{fontWeight: 500, marginBottom: 4}}>{notif.title}</div>
                          <div style={{fontSize: 13, color: 'var(--gray-text)'}}>{notif.message}</div>
                          <div style={{fontSize: 11, color: 'var(--gray-text)', marginTop: 8}}>{notif.time}</div>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>
        </>
      );
    };

    // Dashboard Component
    const Dashboard = ({ onNavigate, refreshKey }) => {
      const [stats, setStats] = React.useState({ totalProjects: 0, totalRoles: 0, totalPipelineValue: 0 });
      const [recentProjects, setRecentProjects] = React.useState([]);

      React.useEffect(() => {
        const projects = db.getProjects();
        let totalPipelineValue = 0;
        const projectsWithTotals = projects.slice(0, 5).map(p => {
          const totals = db.calculateProjectTotals(p.id);
          totalPipelineValue += totals.sellingPrice;
          return { ...p, ...totals };
        });
        setStats({ totalProjects: projects.length, totalRoles: db.getRoles().length, totalPipelineValue });
        setRecentProjects(projectsWithTotals);
        lucide.createIcons();
      }, [refreshKey]);

      return (
        <div>
          <div className="page-header">
            <h1 className="page-title">Dashboard</h1>
            <button className="btn btn-primary" onClick={() => onNavigate('projects')}>
              <i data-lucide="plus" style={{width: 18, height: 18}}></i> New Project
            </button>
          </div>
          <div className="stats-grid">
            <div className="stat-card"><div className="stat-label">Total Projects</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{stats.totalProjects}</div></div>
            <div className="stat-card"><div className="stat-label">Role Templates</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{stats.totalRoles}</div></div>
            <div className="stat-card"><div className="stat-label">Pipeline Value</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{formatCurrency(stats.totalPipelineValue)}</div></div>
          </div>
          <div className="card">
            <div className="card-header"><h2>Recent Projects</h2></div>
            {recentProjects.length === 0 ? (
              <div className="empty-state">
                <p>No projects yet. Create your first project to start pricing.</p>
                <button className="btn btn-primary" onClick={() => onNavigate('projects')} style={{ marginTop: 16 }}>Create Project</button>
              </div>
            ) : (
              <table>
                <thead><tr><th>Project</th><th>Client</th><th>Total Cost</th><th>Selling Price</th><th>Margin</th><th></th></tr></thead>
                <tbody>
                  {recentProjects.map(p => (
                    <tr key={p.id}>
                      <td>
                        <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                          <span style={{fontWeight: 500}}>{p.name}</span>
                          {p.riskMarginPercent > 0 && (
                            <span style={{display: 'inline-flex', alignItems: 'center', gap: 3, padding: '2px 6px', borderRadius: 100, fontSize: 10, fontWeight: 500, background: 'rgba(94, 86, 222, 0.15)', color: 'var(--boud-purple)'}}>
                              <i data-lucide="shield" style={{width: 10, height: 10}}></i>{p.riskMarginPercent}%
                            </span>
                          )}
                          {p.discountPercent > 0 && (
                            <span style={{display: 'inline-flex', alignItems: 'center', gap: 3, padding: '2px 6px', borderRadius: 100, fontSize: 10, fontWeight: 500, background: 'rgba(228, 106, 23, 0.15)', color: 'var(--boud-orange)'}}>
                              <i data-lucide="tag" style={{width: 10, height: 10}}></i>{p.discountPercent}%
                            </span>
                          )}
                        </div>
                      </td>
                      <td className="text-secondary">{p.client || '-'}</td>
                      <td>{formatCurrency(p.totalCost)}</td>
                      <td style={{fontWeight: 500}}>{formatCurrency(p.sellingPrice)}</td>
                      <td><span className={`badge ${p.actualMargin >= 25 ? 'badge-success' : p.actualMargin >= 15 ? 'badge-warning' : 'badge-error'}`}>{p.actualMargin.toFixed(1)}%</span></td>
                      <td><button className="btn btn-secondary btn-sm" onClick={() => onNavigate('project-pricing', p.id)}>Open</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </div>
      );
    };

    // Rates Management, Tools Management, Projects List, Project Pricing, Insights, Settings, API Settings, Product Fees
    // These components are included in continuation due to length...

    // [Additional components continue - Rates, Tools, Projects, Settings, etc.]
    // For brevity, I'll include the key new features and modified components

    // Version History Component
    const VersionHistory = ({ projectId, onClose }) => {
      const [history, setHistory] = React.useState([]);

      React.useEffect(() => {
        setHistory(db.getVersionHistory(projectId));
        lucide.createIcons();
      }, [projectId]);

      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      };

      const getChangeIcon = (type) => {
        switch(type) {
          case 'created': return 'plus-circle';
          case 'margin': return 'percent';
          case 'discount': return 'tag';
          case 'risk_margin': return 'shield';
          case 'phase_added': return 'layers';
          case 'phase_deleted': return 'trash-2';
          default: return 'edit';
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" style={{maxWidth: 500}} onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 style={{display: 'flex', alignItems: 'center', gap: 8}}>
                <i data-lucide="history" style={{width: 20, height: 20}}></i>
                Version History
              </h3>
              <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
            </div>
            <div className="modal-body">
              {history.length === 0 ? (
                <div style={{textAlign: 'center', padding: 24, color: 'var(--gray-text)'}}>No changes recorded yet</div>
              ) : (
                <div className="version-history">
                  {history.map(entry => (
                    <div key={entry.id} className="version-item">
                      <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                        <i data-lucide={getChangeIcon(entry.change_type)} style={{width: 14, height: 14, color: 'var(--boud-purple)'}}></i>
                        <span className="version-time">{formatDate(entry.changed_at)}</span>
                        <span style={{fontSize: 11, color: 'var(--gray-text)'}}>by {entry.changed_by}</span>
                      </div>
                      <div className="version-change">{entry.description}</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Risk & Discount Modal
    const RiskDiscountModal = ({ project, onSave, onClose }) => {
      const [riskMargin, setRiskMargin] = React.useState(project?.risk_margin?.toString() || '0');
      const [discountPercent, setDiscountPercent] = React.useState(project?.discount_percent?.toString() || '0');

      React.useEffect(() => { lucide.createIcons(); }, []);

      const handleSave = () => {
        onSave({
          risk_margin: parseFloat(riskMargin) || 0,
          discount_percent: parseFloat(discountPercent) || 0
        });
        onClose();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>Risk Margin & Discount</h3>
              <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
            </div>
            <div className="modal-body">
              <div style={{padding: 16, background: 'rgba(94, 86, 222, 0.1)', borderRadius: 8, marginBottom: 24}}>
                <h4 style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8, color: 'var(--boud-purple)'}}>
                  <i data-lucide="shield" style={{width: 16, height: 16}}></i>
                  Risk Margin
                </h4>
                <p style={{fontSize: 13, color: 'var(--gray-text)', marginBottom: 12}}>
                  Add a buffer percentage to cover potential delays, scope creep, hidden costs, or client-side issues.
                </p>
                <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                  <input type="number" className="form-input" value={riskMargin} onChange={e => setRiskMargin(e.target.value)} min="0" max="50" step="1" style={{width: 100}} />
                  <span>%</span>
                </div>
              </div>

              <div style={{padding: 16, background: 'rgba(228, 106, 23, 0.1)', borderRadius: 8}}>
                <h4 style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8, color: 'var(--boud-orange)'}}>
                  <i data-lucide="tag" style={{width: 16, height: 16}}></i>
                  Discount
                </h4>
                <p style={{fontSize: 13, color: 'var(--gray-text)', marginBottom: 12}}>
                  Apply a discount to the final price. Can be added or modified at any time.
                </p>
                <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                  <input type="number" className="form-input" value={discountPercent} onChange={e => setDiscountPercent(e.target.value)} min="0" max="100" step="1" style={{width: 100}} />
                  <span>%</span>
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
              <button className="btn btn-primary" onClick={handleSave}>Save Changes</button>
            </div>
          </div>
        </div>
      );
    };

    // Simplified Project Pricing Component with new features
    const ProjectPricing = ({ projectId, onBack, onRefresh, onNavigate }) => {
      const [project, setProject] = React.useState(null);
      const [phases, setPhases] = React.useState([]);
      const [totals, setTotals] = React.useState(null);
      const [roles, setRoles] = React.useState([]);
      const [expandedPhases, setExpandedPhases] = React.useState({});
      const [isHistoryOpen, setIsHistoryOpen] = React.useState(false);
      const [isRiskDiscountOpen, setIsRiskDiscountOpen] = React.useState(false);
      const [isPhaseModalOpen, setIsPhaseModalOpen] = React.useState(false);
      const [isResourceModalOpen, setIsResourceModalOpen] = React.useState(false);
      const [currentPhaseId, setCurrentPhaseId] = React.useState(null);
      const [editingItem, setEditingItem] = React.useState(null);
      const [phaseForm, setPhaseForm] = React.useState({ name: '' });
      const [resourceForm, setResourceForm] = React.useState({ role_id: '', hours: '', rate_override: '', notes: '' });

      const loadData = React.useCallback(() => {
        const p = db.getProject(projectId);
        setProject(p);
        const phaseList = db.getPhases(projectId).map(phase => ({
          ...phase,
          resources: db.getResourceCosts(phase.id),
          tools: db.getToolCosts(phase.id),
          vendors: db.getVendorCosts(phase.id)
        }));
        setPhases(phaseList);
        const exp = {};
        phaseList.forEach(ph => exp[ph.id] = true);
        setExpandedPhases(exp);
        setTotals(db.calculateProjectTotals(projectId));
        setRoles(db.getRoles());
        setTimeout(() => lucide.createIcons(), 0);
      }, [projectId]);

      React.useEffect(() => { loadData(); }, [loadData]);

      const handleSavePhase = () => {
        if (editingItem) db.updatePhase(editingItem.id, phaseForm.name);
        else db.createPhase(projectId, phaseForm.name);
        setIsPhaseModalOpen(false);
        loadData();
      };

      const handleSaveResource = () => {
        if (editingItem) db.updateResourceCost(editingItem.id, parseFloat(resourceForm.hours), resourceForm.rate_override ? parseFloat(resourceForm.rate_override) : null, resourceForm.notes);
        else db.addResourceCost(currentPhaseId, resourceForm.role_id, parseFloat(resourceForm.hours), resourceForm.rate_override ? parseFloat(resourceForm.rate_override) : null, resourceForm.notes);
        setIsResourceModalOpen(false);
        loadData();
      };

      const handleSaveRiskDiscount = (data) => {
        db.updateProject(projectId, data);
        loadData();
        onRefresh?.();
      };

      const handleSaveAsTemplate = () => {
        const name = prompt('Template name:');
        if (name) {
          saveTemplate({
            name,
            description: `Based on ${project.name}`,
            config: {
              duration_weeks: project.duration_weeks,
              target_margin: project.target_margin,
              pricing_models: project.pricing_models,
              risk_margin: project.risk_margin,
              saas_monthly_price: project.saas_monthly_price,
              saas_yearly_price: project.saas_yearly_price,
              setup_fee: project.setup_fee,
              api_type: project.api_type,
              api_markup: project.api_markup,
              api_expected_hits: project.api_expected_hits,
              selected_products: project.selected_products
            }
          });
          alert('Template saved!');
        }
      };

      if (!project || !totals) return <div>Loading...</div>;

      const vatRate = parseFloat(localStorage.getItem('boud_vat_rate') || '15');
      const priceWithVat = totals.sellingPrice * (1 + vatRate / 100);

      return (
        <div>
          <div style={{display: 'flex', alignItems: 'center', gap: 16, marginBottom: 24}}>
            <button className="btn btn-icon" onClick={onBack}><i data-lucide="arrow-left" style={{width: 20, height: 20}}></i></button>
            <div style={{flex: 1}}>
              <h1 className="page-title" style={{margin: 0}}>{project.name}</h1>
              <p className="text-secondary" style={{margin: 0}}>{project.client && `${project.client}  `}{project.duration_weeks && `${project.duration_weeks} weeks`}</p>
            </div>
            <button className="btn btn-secondary" onClick={() => setIsHistoryOpen(true)}>
              <i data-lucide="history" style={{width: 16, height: 16}}></i> History
            </button>
            <button className="btn btn-secondary" onClick={handleSaveAsTemplate}>
              <i data-lucide="bookmark" style={{width: 16, height: 16}}></i> Save as Template
            </button>
            <button className="btn btn-secondary" onClick={() => handleExportCSV(project, phases, totals, vatRate)}>
              <i data-lucide="table" style={{width: 16, height: 16}}></i> CSV
            </button>
            <button className="btn btn-primary" onClick={() => handleExportProposal(project, phases, totals, vatRate)}>
              <i data-lucide="printer" style={{width: 16, height: 16}}></i> Print
            </button>
          </div>

          {/* Pricing Summary with Risk & Discount */}
          <div className="margin-display" style={{marginBottom: 24}}>
            <div className="margin-item">
              <div className="label">Total Cost</div>
              <div className="value">{formatCurrency(totals.totalCost)}</div>
            </div>
            <div className="margin-divider"></div>
            {totals.riskMarginPercent > 0 && (
              <>
                <div className="margin-item">
                  <div className="label">Risk Buffer ({totals.riskMarginPercent}%)</div>
                  <div className="value" style={{color: 'var(--boud-orange)'}}>{formatCurrency(totals.riskMarginAmount)}</div>
                </div>
                <div className="margin-divider"></div>
              </>
            )}
            <div className="margin-item">
              <div className="label">Subtotal</div>
              <div className="value">{formatCurrency(totals.subtotal)}</div>
            </div>
            {totals.discountPercent > 0 && (
              <>
                <div className="margin-divider"></div>
                <div className="margin-item">
                  <div className="label">Discount ({totals.discountPercent}%)</div>
                  <div className="value" style={{color: 'var(--boud-orange)'}}>-{formatCurrency(totals.discountAmount)}</div>
                </div>
              </>
            )}
            <div className="margin-divider"></div>
            <div className="margin-item">
              <div className="label">Selling Price</div>
              <div className="value" style={{color: 'var(--boud-lime)'}}>{formatCurrency(totals.sellingPrice)}</div>
            </div>
            <div className="margin-divider"></div>
            <div className="margin-item">
              <div className="label">With VAT ({vatRate}%)</div>
              <div className="value">{formatCurrency(priceWithVat)}</div>
            </div>
            <div className="margin-divider"></div>
            <div className="margin-item">
              <div className="label">Margin</div>
              <div className="value" style={{color: totals.actualMargin >= 25 ? 'var(--success)' : totals.actualMargin >= 15 ? 'var(--warning)' : 'var(--error)'}}>{totals.actualMargin.toFixed(1)}%</div>
            </div>
          </div>

          {/* Action Buttons */}
          <div style={{display: 'flex', gap: 8, marginBottom: 24}}>
            <button className="btn btn-purple" onClick={() => setIsRiskDiscountOpen(true)}>
              <i data-lucide="sliders" style={{width: 16, height: 16}}></i> Risk & Discount
            </button>
            <button className="btn btn-secondary" onClick={() => { setPhaseForm({ name: '' }); setEditingItem(null); setIsPhaseModalOpen(true); }}>
              <i data-lucide="plus" style={{width: 16, height: 16}}></i> Add Phase
            </button>
          </div>

          {/* Phases */}
          {phases.map(phase => (
            <div key={phase.id} className="phase-section">
              <div className="phase-header" onClick={() => setExpandedPhases(prev => ({...prev, [phase.id]: !prev[phase.id]}))}>
                <h3 style={{display: 'flex', alignItems: 'center', gap: 8}}>
                  <i data-lucide={expandedPhases[phase.id] ? 'chevron-down' : 'chevron-right'} style={{width: 16, height: 16}}></i>
                  {phase.name}
                </h3>
                <div className="phase-total">{formatCurrency(phase.resources.reduce((s, r) => s + r.total, 0) + phase.tools.reduce((s, t) => s + t.total, 0) + phase.vendors.reduce((s, v) => s + v.cost, 0))}</div>
              </div>
              {expandedPhases[phase.id] && (
                <div className="phase-content">
                  <div style={{marginBottom: 16}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                      <h4>Resources</h4>
                      <button className="btn btn-sm btn-secondary" onClick={() => { setCurrentPhaseId(phase.id); setResourceForm({ role_id: '', hours: '', rate_override: '', notes: '' }); setEditingItem(null); setIsResourceModalOpen(true); }}>
                        <i data-lucide="plus" style={{width: 14, height: 14}}></i> Add
                      </button>
                    </div>
                    {phase.resources.length === 0 ? (
                      <p className="text-secondary" style={{fontSize: 13}}>No resources added yet</p>
                    ) : (
                      <table>
                        <thead><tr><th>Role</th><th>Hours</th><th>Rate</th><th>Total</th><th></th></tr></thead>
                        <tbody>
                          {phase.resources.map(r => (
                            <tr key={r.id}>
                              <td>{r.role_name}</td>
                              <td>{r.hours}h</td>
                              <td>{formatCurrency(r.effective_rate)}/hr</td>
                              <td style={{fontWeight: 600}}>{formatCurrency(r.total)}</td>
                              <td>
                                <button className="btn btn-icon btn-sm" onClick={() => db.deleteResourceCost(r.id) || loadData()} style={{color: 'var(--error)'}}><i data-lucide="trash-2" style={{width: 14, height: 14}}></i></button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>
                </div>
              )}
            </div>
          ))}

          {/* Modals */}
          {isHistoryOpen && <VersionHistory projectId={projectId} onClose={() => setIsHistoryOpen(false)} />}
          {isRiskDiscountOpen && <RiskDiscountModal project={project} onSave={handleSaveRiskDiscount} onClose={() => setIsRiskDiscountOpen(false)} />}

          {isPhaseModalOpen && (
            <div className="modal-overlay" onClick={() => setIsPhaseModalOpen(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>{editingItem ? 'Edit Phase' : 'Add Phase'}</h3><button className="btn btn-icon" onClick={() => setIsPhaseModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <div className="modal-body">
                  <div className="form-group"><label className="form-label">Phase Name</label><input type="text" className="form-input" value={phaseForm.name} onChange={e => setPhaseForm({name: e.target.value})} placeholder="e.g., Discovery, Development" /></div>
                </div>
                <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setIsPhaseModalOpen(false)}>Cancel</button><button className="btn btn-primary" onClick={handleSavePhase}>Save</button></div>
              </div>
            </div>
          )}

          {isResourceModalOpen && (
            <div className="modal-overlay" onClick={() => setIsResourceModalOpen(false)}>
              <div className="modal" style={{maxWidth: 550}} onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>Add Resource</h3><button className="btn btn-icon" onClick={() => setIsResourceModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <div className="modal-body">
                  <div className="form-group">
                    <label className="form-label">Role</label>
                    <RoleSelector roles={roles} value={resourceForm.role_id} onChange={id => setResourceForm({...resourceForm, role_id: id})} formatCurrency={formatCurrency} />
                  </div>
                  <div className="form-row">
                    <div className="form-group"><label className="form-label">Hours</label><input type="number" className="form-input" value={resourceForm.hours} onChange={e => setResourceForm({...resourceForm, hours: e.target.value})} min="0" /></div>
                    <div className="form-group"><label className="form-label">Rate Override (optional)</label><input type="number" className="form-input" value={resourceForm.rate_override} onChange={e => setResourceForm({...resourceForm, rate_override: e.target.value})} placeholder="Use default" /></div>
                  </div>
                </div>
                <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setIsResourceModalOpen(false)}>Cancel</button><button className="btn btn-primary" onClick={handleSaveResource}>Add</button></div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Default 89 roles from Resources Pricing List
    const DEFAULT_ROLES = [
      { name: 'Senior Consultant - PO', hourly_rate: 710, department: 'PO' },
      { name: 'Consultant - PO', hourly_rate: 600, department: 'PO' },
      { name: 'Associate Consultant - PO', hourly_rate: 450, department: 'PO' },
      { name: 'Senior Specialist - PO', hourly_rate: 250, department: 'PO' },
      { name: 'Specialist - PO', hourly_rate: 190, department: 'PO' },
      { name: 'Senior Analyst - PO', hourly_rate: 142.5, department: 'PO' },
      { name: 'Junior Analyst - PO', hourly_rate: 110, department: 'PO' },
      { name: 'Intern - PO', hourly_rate: 15, department: 'PO' },
      { name: 'Senior Consultant - PM', hourly_rate: 560, department: 'PM' },
      { name: 'Consultant - PM', hourly_rate: 450, department: 'PM' },
      { name: 'Associate Consultant - PM', hourly_rate: 350, department: 'PM' },
      { name: 'Senior Specialist - PM', hourly_rate: 220, department: 'PM' },
      { name: 'Specialist - PM', hourly_rate: 150, department: 'PM' },
      { name: 'Senior Analyst - PM', hourly_rate: 100, department: 'PM' },
      { name: 'Junior Analyst - PM', hourly_rate: 70, department: 'PM' },
      { name: 'Intern - PM', hourly_rate: 30, department: 'PM' },
      { name: 'Senior Consultant - BA', hourly_rate: 350, department: 'BA' },
      { name: 'Consultant - BA', hourly_rate: 300, department: 'BA' },
      { name: 'Associate Consultant - BA', hourly_rate: 250, department: 'BA' },
      { name: 'Senior Specialist - BA', hourly_rate: 200, department: 'BA' },
      { name: 'Specialist - BA', hourly_rate: 170, department: 'BA' },
      { name: 'Senior Analyst - BA', hourly_rate: 140, department: 'BA' },
      { name: 'Junior Analyst - BA', hourly_rate: 100, department: 'BA' },
      { name: 'Intern - BA', hourly_rate: 30, department: 'BA' },
      { name: 'Senior Consultant - UXUI', hourly_rate: 450, department: 'UXUI' },
      { name: 'Consultant - UXUI', hourly_rate: 300, department: 'UXUI' },
      { name: 'Associate Consultant - UXUI', hourly_rate: 200, department: 'UXUI' },
      { name: 'Senior Specialist - UXUI', hourly_rate: 160, department: 'UXUI' },
      { name: 'Specialist - UXUI', hourly_rate: 125, department: 'UXUI' },
      { name: 'Senior Analyst - UXUI', hourly_rate: 95, department: 'UXUI' },
      { name: 'Junior Analyst - UXUI', hourly_rate: 57, department: 'UXUI' },
      { name: 'Intern - UXUI', hourly_rate: 30, department: 'UXUI' },
      { name: 'Senior Consultant Engineer - FE', hourly_rate: 250, department: 'FE' },
      { name: 'Consultant Engineer - FE', hourly_rate: 200, department: 'FE' },
      { name: 'Associate Consultant Engineer - FE', hourly_rate: 160, department: 'FE' },
      { name: 'Senior Specialist - FE', hourly_rate: 120, department: 'FE' },
      { name: 'Specialist - FE', hourly_rate: 80, department: 'FE' },
      { name: 'Senior Analyst - FE', hourly_rate: 45, department: 'FE' },
      { name: 'Junior Analyst - FE', hourly_rate: 45, department: 'FE' },
      { name: 'Intern - FE', hourly_rate: 30, department: 'FE' },
      { name: 'Senior Consultant Engineer - Mobile', hourly_rate: 350, department: 'Mobile' },
      { name: 'Consultant Engineer - Mobile', hourly_rate: 250, department: 'Mobile' },
      { name: 'Associate Consultant Engineer - Mobile', hourly_rate: 200, department: 'Mobile' },
      { name: 'Senior Specialist - Mobile', hourly_rate: 140, department: 'Mobile' },
      { name: 'Specialist - Mobile', hourly_rate: 80, department: 'Mobile' },
      { name: 'Senior Analyst - Mobile', hourly_rate: 57, department: 'Mobile' },
      { name: 'Junior Analyst - Mobile', hourly_rate: 40, department: 'Mobile' },
      { name: 'Intern - Mobile', hourly_rate: 30, department: 'Mobile' },
      { name: 'Senior Consultant Engineer - BE', hourly_rate: 250, department: 'BE' },
      { name: 'Consultant Engineer - BE', hourly_rate: 190, department: 'BE' },
      { name: 'Associate Consultant Engineer - BE', hourly_rate: 150, department: 'BE' },
      { name: 'Senior Specialist - BE', hourly_rate: 115, department: 'BE' },
      { name: 'Specialist - BE', hourly_rate: 90, department: 'BE' },
      { name: 'Senior Analyst - BE', hourly_rate: 70, department: 'BE' },
      { name: 'Junior Analyst - BE', hourly_rate: 50, department: 'BE' },
      { name: 'Intern - BE', hourly_rate: 30, department: 'BE' },
      { name: 'Senior Consultant - QA', hourly_rate: 250, department: 'QA' },
      { name: 'Consultant - QA', hourly_rate: 190, department: 'QA' },
      { name: 'Associate Consultant - QA', hourly_rate: 150, department: 'QA' },
      { name: 'Senior Specialist - QA', hourly_rate: 115, department: 'QA' },
      { name: 'Specialist - QA', hourly_rate: 90, department: 'QA' },
      { name: 'Senior Analyst - QA', hourly_rate: 70, department: 'QA' },
      { name: 'Junior Analyst - QA', hourly_rate: 50, department: 'QA' },
      { name: 'Intern - QA', hourly_rate: 30, department: 'QA' },
      { name: 'Senior Consultant - SM', hourly_rate: 250, department: 'SM' },
      { name: 'Consultant - SM', hourly_rate: 190, department: 'SM' },
      { name: 'Associate Consultant - SM', hourly_rate: 150, department: 'SM' },
      { name: 'Senior Specialist - SM', hourly_rate: 115, department: 'SM' },
      { name: 'Specialist - SM', hourly_rate: 90, department: 'SM' },
      { name: 'Senior Analyst - SM', hourly_rate: 70, department: 'SM' },
      { name: 'Junior Analyst - SM', hourly_rate: 50, department: 'SM' },
      { name: 'Intern - SM', hourly_rate: 30, department: 'SM' },
      { name: 'Senior Consultant - CMS', hourly_rate: 250, department: 'CMS' },
      { name: 'Consultant - CMS', hourly_rate: 190, department: 'CMS' },
      { name: 'Associate Consultant - CMS', hourly_rate: 150, department: 'CMS' },
      { name: 'Senior Specialist - CMS', hourly_rate: 115, department: 'CMS' },
      { name: 'Specialist - CMS', hourly_rate: 90, department: 'CMS' },
      { name: 'Senior Analyst - CMS', hourly_rate: 70, department: 'CMS' },
      { name: 'Junior Analyst - CMS', hourly_rate: 50, department: 'CMS' },
      { name: 'Intern - CMS', hourly_rate: 30, department: 'CMS' },
      { name: 'Senior Consultant - DA', hourly_rate: 490.91, department: 'DA' },
      { name: 'Consultant - DA', hourly_rate: 409.09, department: 'DA' },
      { name: 'Associate Consultant - DA', hourly_rate: 318.18, department: 'DA' },
      { name: 'Senior Specialist - DA', hourly_rate: 227.27, department: 'DA' },
      { name: 'Specialist - DA', hourly_rate: 181.82, department: 'DA' },
      { name: 'Senior Analyst - DA', hourly_rate: 159.09, department: 'DA' },
      { name: 'Junior Analyst - DA', hourly_rate: 136.36, department: 'DA' },
      { name: 'Intern - DA', hourly_rate: 45.45, department: 'DA' },
      { name: 'Web Designer', hourly_rate: 109.09, department: 'Design' }
    ];

    // Simplified components for rates, tools, projects list, insights, settings
    const RatesManagement = ({ onRefresh }) => {
      const [roles, setRoles] = React.useState([]);
      const [isModalOpen, setIsModalOpen] = React.useState(false);
      const [isImportModalOpen, setIsImportModalOpen] = React.useState(false);
      const [importPreview, setImportPreview] = React.useState([]);
      const [editingRole, setEditingRole] = React.useState(null);
      const [formData, setFormData] = React.useState({ name: '', hourly_rate: '', department: '' });
      const [filterDept, setFilterDept] = React.useState('all');
      const [isDragging, setIsDragging] = React.useState(false);
      const [selectedRoles, setSelectedRoles] = React.useState([]);
      const [showInactive, setShowInactive] = React.useState(false);
      const [showHidden, setShowHidden] = React.useState(false);
      const fileInputRef = React.useRef(null);
      const dropZoneRef = React.useRef(null);

      const departments = ['PO', 'PM', 'BA', 'UXUI', 'FE', 'Mobile', 'BE', 'QA', 'SM', 'CMS', 'DA', 'Design'];

      React.useEffect(() => { setRoles(db.getRoles()); setTimeout(() => lucide.createIcons(), 0); }, []);

      // Filter roles based on department and status
      const filteredRoles = roles.filter(r => {
        if (filterDept !== 'all' && r.department !== filterDept) return false;
        if (!showInactive && r.status === 'inactive') return false;
        if (!showHidden && r.status === 'hidden') return false;
        return true;
      });
      const displayedRoles = filteredRoles;

      // Toggle role status
      const toggleRoleStatus = (roleId, newStatus) => {
        db.updateRoleStatus(roleId, newStatus);
        setRoles(db.getRoles());
        setTimeout(() => lucide.createIcons(), 0);
      };

      // Bulk actions
      const bulkAction = (action) => {
        if (selectedRoles.length === 0) return;
        if (action === 'delete') {
          if (!confirm(`Delete ${selectedRoles.length} roles? This cannot be undone.`)) return;
          selectedRoles.forEach(id => db.deleteRole(id));
        } else if (action === 'deactivate') {
          if (!confirm(`Deactivate ${selectedRoles.length} roles?`)) return;
          selectedRoles.forEach(id => db.updateRoleStatus(id, 'inactive'));
        } else if (action === 'activate') {
          selectedRoles.forEach(id => db.updateRoleStatus(id, 'active'));
        } else if (action === 'hide') {
          if (!confirm(`Hide ${selectedRoles.length} roles?`)) return;
          selectedRoles.forEach(id => db.updateRoleStatus(id, 'hidden'));
        } else if (action === 'unhide') {
          selectedRoles.forEach(id => db.updateRoleStatus(id, 'active'));
        }
        setSelectedRoles([]);
        setRoles(db.getRoles());
        onRefresh?.();
        setTimeout(() => lucide.createIcons(), 0);
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (editingRole) {
          db.updateRole(editingRole.id, formData.name, parseFloat(formData.hourly_rate), formData.department);
        } else {
          db.createRole(formData.name, parseFloat(formData.hourly_rate), formData.department);
        }
        setRoles(db.getRoles());
        setIsModalOpen(false);
        onRefresh?.();
      };

      const processFile = (file) => {
        if (!file || !file.name.endsWith('.csv')) {
          alert('Please upload a CSV file');
          return;
        }
        const reader = new FileReader();
        reader.onload = (evt) => {
          const text = evt.target.result;
          const lines = text.split('\n').filter(l => l.trim());
          const preview = [];
          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
            if (cols.length >= 2 && cols[0] && !isNaN(parseFloat(cols[1]))) {
              preview.push({ name: cols[0], hourly_rate: parseFloat(cols[1]), department: cols[2] || '' });
            }
          }
          if (preview.length > 0) {
            setImportPreview(preview);
            setIsImportModalOpen(true);
          } else {
            alert('No valid roles found in CSV');
          }
        };
        reader.readAsText(file);
      };

      const handleFileUpload = (e) => {
        processFile(e.target.files[0]);
        e.target.value = '';
      };

      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        const file = e.dataTransfer.files[0];
        processFile(file);
      };

      const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
      const handleDragLeave = (e) => { e.preventDefault(); setIsDragging(false); };

      const confirmImport = () => {
        importPreview.forEach(role => db.createRole(role.name, role.hourly_rate, role.department));
        setRoles(db.getRoles());
        setIsImportModalOpen(false);
        setImportPreview([]);
        onRefresh?.();
      };

      const downloadTemplate = () => {
        const csv = 'Role Name,Hourly Rate,Department\n' + DEFAULT_ROLES.map(r => `"${r.name}",${r.hourly_rate},${r.department}`).join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'boud_roles_template.csv';
        link.click();
      };

      const loadDefaultRoles = () => {
        if (confirm(`This will add ${DEFAULT_ROLES.length} default roles to your list. Continue?`)) {
          DEFAULT_ROLES.forEach(role => db.createRole(role.name, role.hourly_rate, role.department));
          setRoles(db.getRoles());
          onRefresh?.();
        }
      };

      return (
        <div>
          <div className="page-header">
            <div><h1 className="page-title">Role Rates</h1><p className="text-secondary">Manage hourly rates for each role ({roles.length} roles)</p></div>
            <div style={{display: 'flex', gap: 8}}>
              <button className="btn btn-secondary" onClick={loadDefaultRoles}>
                <i data-lucide="database" style={{width: 16, height: 16}}></i> Load Defaults (89)
              </button>
              <button className="btn btn-primary" onClick={() => { setEditingRole(null); setFormData({ name: '', hourly_rate: '', department: '' }); setIsModalOpen(true); }}>
                <i data-lucide="plus" style={{width: 18, height: 18}}></i> Add Role
              </button>
            </div>
          </div>

          {/* Import Zone */}
          <div
            ref={dropZoneRef}
            onDrop={handleDrop}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onClick={() => fileInputRef.current?.click()}
            style={{
              border: `2px dashed ${isDragging ? 'var(--boud-purple)' : 'rgba(0,0,0,0.15)'}`,
              borderRadius: 12, padding: 24, marginBottom: 24, textAlign: 'center',
              background: isDragging ? 'rgba(94, 86, 222, 0.05)' : 'white',
              cursor: 'pointer', transition: 'all 0.2s ease'
            }}
          >
            <input type="file" ref={fileInputRef} accept=".csv" onChange={handleFileUpload} style={{display: 'none'}} />
            <i data-lucide="upload-cloud" style={{width: 40, height: 40, color: 'var(--boud-purple)', marginBottom: 12}}></i>
            <p style={{fontWeight: 600, margin: '0 0 4px 0'}}>Drag & drop CSV file here, or click to browse</p>
            <p className="text-secondary" style={{fontSize: 13, margin: 0}}>CSV format: Role Name, Hourly Rate, Department</p>
            <div style={{marginTop: 16, display: 'flex', gap: 12, justifyContent: 'center'}}>
              <button className="btn btn-sm btn-secondary" onClick={(e) => { e.stopPropagation(); downloadTemplate(); }}>
                <i data-lucide="download" style={{width: 14, height: 14}}></i> Download Template (89 roles)
              </button>
            </div>
          </div>

          {/* Example Format */}
          <div className="card" style={{marginBottom: 24, padding: 16, background: 'rgba(94, 86, 222, 0.05)'}}>
            <h4 style={{margin: '0 0 12px 0', display: 'flex', alignItems: 'center', gap: 8}}>
              <i data-lucide="file-text" style={{width: 16, height: 16}}></i> CSV Format Example
            </h4>
            <div style={{background: '#1e1e1e', color: '#def763', padding: 16, borderRadius: 8, fontFamily: 'monospace', fontSize: 13, overflowX: 'auto'}}>
              <div style={{color: '#888'}}>// Header row (required)</div>
              <div>Role Name,Hourly Rate,Department</div>
              <div style={{color: '#888', marginTop: 8}}>// Data rows</div>
              <div>Senior Consultant - PM,560,PM</div>
              <div>Consultant - BA,300,BA</div>
              <div>Specialist - FE,80,FE</div>
            </div>
          </div>

          <div style={{marginBottom: 16, display: 'flex', gap: 8, flexWrap: 'wrap', alignItems: 'center'}}>
            <button className={`btn btn-sm ${filterDept === 'all' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setFilterDept('all')}>All ({roles.filter(r => r.status !== 'hidden').length})</button>
            {departments.map(dept => {
              const count = roles.filter(r => r.department === dept && r.status !== 'hidden').length;
              return count > 0 ? (
                <button key={dept} className={`btn btn-sm ${filterDept === dept ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setFilterDept(dept)}>{dept} ({count})</button>
              ) : null;
            })}
            <span style={{marginLeft: 'auto'}}></span>
            <label style={{display: 'flex', alignItems: 'center', gap: 6, fontSize: 13, cursor: 'pointer'}}>
              <input type="checkbox" checked={showInactive} onChange={e => setShowInactive(e.target.checked)} />
              Show Inactive
            </label>
            <label style={{display: 'flex', alignItems: 'center', gap: 6, fontSize: 13, cursor: 'pointer'}}>
              <input type="checkbox" checked={showHidden} onChange={e => setShowHidden(e.target.checked)} />
              Show Hidden
            </label>
          </div>

          {/* Bulk Actions Bar */}
          {selectedRoles.length > 0 && (
            <div style={{display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: 'rgba(94, 86, 222, 0.1)', borderRadius: 8, marginBottom: 16}}>
              <span style={{fontWeight: 600}}>{selectedRoles.length} selected</span>
              <button className="btn btn-sm btn-secondary" onClick={() => bulkAction('deactivate')}>
                <i data-lucide="pause-circle" style={{width: 14, height: 14}}></i> Deactivate
              </button>
              <button className="btn btn-sm btn-secondary" onClick={() => bulkAction('activate')}>
                <i data-lucide="play-circle" style={{width: 14, height: 14}}></i> Activate
              </button>
              <button className="btn btn-sm btn-secondary" onClick={() => bulkAction('hide')}>
                <i data-lucide="eye-off" style={{width: 14, height: 14}}></i> Hide
              </button>
              <button className="btn btn-sm btn-secondary" onClick={() => bulkAction('unhide')}>
                <i data-lucide="eye" style={{width: 14, height: 14}}></i> Unhide
              </button>
              <button className="btn btn-sm" style={{background: 'var(--error)', color: 'white'}} onClick={() => bulkAction('delete')}>
                <i data-lucide="trash-2" style={{width: 14, height: 14}}></i> Delete
              </button>
              <button className="btn btn-sm btn-secondary" onClick={() => setSelectedRoles([])} style={{marginLeft: 'auto'}}>
                Clear Selection
              </button>
            </div>
          )}

          <div className="card">
            <table>
              <thead>
                <tr>
                  <th style={{width: 40}}>
                    <input type="checkbox" checked={selectedRoles.length === displayedRoles.length && displayedRoles.length > 0} onChange={e => setSelectedRoles(e.target.checked ? displayedRoles.map(r => r.id) : [])} />
                  </th>
                  <th>Role Name</th>
                  <th>Department</th>
                  <th>Hourly Rate</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {displayedRoles.length === 0 ? (
                  <tr><td colSpan={6} style={{textAlign: 'center', padding: 32}} className="text-secondary">
                    No roles yet. Click "Load Defaults" to add 89 pre-configured roles, or import your own CSV.
                  </td></tr>
                ) : displayedRoles.map(role => (
                  <tr key={role.id} style={{opacity: role.status === 'inactive' || role.status === 'hidden' ? 0.5 : 1}}>
                    <td>
                      <input type="checkbox" checked={selectedRoles.includes(role.id)} onChange={e => {
                        if (e.target.checked) setSelectedRoles([...selectedRoles, role.id]);
                        else setSelectedRoles(selectedRoles.filter(id => id !== role.id));
                      }} />
                    </td>
                    <td style={{fontWeight: 500}}>{role.name}</td>
                    <td><span className="badge badge-info" style={{background: 'rgba(94, 86, 222, 0.15)', color: 'var(--boud-purple)'}}>{role.department || '-'}</span></td>
                    <td style={{color: 'var(--boud-purple)', fontWeight: 600}}>{formatCurrency(role.hourly_rate)}/hr</td>
                    <td>
                      {role.status === 'inactive' && <span className="badge" style={{background: 'rgba(251, 191, 36, 0.2)', color: '#b45309'}}>Inactive</span>}
                      {role.status === 'hidden' && <span className="badge" style={{background: 'rgba(156, 163, 175, 0.2)', color: '#6b7280'}}>Hidden</span>}
                      {(!role.status || role.status === 'active') && <span className="badge" style={{background: 'rgba(74, 222, 128, 0.2)', color: '#15803d'}}>Active</span>}
                    </td>
                    <td>
                      <div className="actions">
                        <button className="btn btn-icon btn-sm" onClick={() => { setEditingRole(role); setFormData({ name: role.name, hourly_rate: role.hourly_rate.toString(), department: role.department || '' }); setIsModalOpen(true); }} title="Edit"><i data-lucide="edit-2" style={{width: 16, height: 16}}></i></button>
                        <button className="btn btn-icon btn-sm" onClick={() => toggleRoleStatus(role.id, role.status === 'inactive' ? 'active' : 'inactive')} title={role.status === 'inactive' ? 'Activate' : 'Deactivate'}>
                          <i data-lucide={role.status === 'inactive' ? 'play-circle' : 'pause-circle'} style={{width: 16, height: 16, color: role.status === 'inactive' ? 'var(--success)' : 'var(--warning)'}}></i>
                        </button>
                        <button className="btn btn-icon btn-sm" onClick={() => toggleRoleStatus(role.id, role.status === 'hidden' ? 'active' : 'hidden')} title={role.status === 'hidden' ? 'Unhide' : 'Hide'}>
                          <i data-lucide={role.status === 'hidden' ? 'eye' : 'eye-off'} style={{width: 16, height: 16}}></i>
                        </button>
                        <button className="btn btn-icon btn-sm" onClick={() => { if (confirm('Delete this role?')) { db.deleteRole(role.id); setRoles(db.getRoles()); setSelectedRoles(selectedRoles.filter(id => id !== role.id)); } }} style={{color: 'var(--error)'}} title="Delete"><i data-lucide="trash-2" style={{width: 16, height: 16}}></i></button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Add/Edit Role Modal */}
          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>{editingRole ? 'Edit Role' : 'Add Role'}</h3><button className="btn btn-icon" onClick={() => setIsModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <form onSubmit={handleSubmit}>
                  <div className="modal-body">
                    <div className="form-group"><label className="form-label">Role Name</label><input type="text" className="form-input" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required placeholder="e.g. Senior Consultant - PM" /></div>
                    <div className="form-row">
                      <div className="form-group"><label className="form-label">Hourly Rate (SAR)</label><input type="number" step="0.01" className="form-input" value={formData.hourly_rate} onChange={e => setFormData({...formData, hourly_rate: e.target.value})} required /></div>
                      <div className="form-group"><label className="form-label">Department</label>
                        <select className="form-select" value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})}>
                          <option value="">Select...</option>
                          {departments.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                      </div>
                    </div>
                  </div>
                  <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={() => setIsModalOpen(false)}>Cancel</button><button type="submit" className="btn btn-primary">Save</button></div>
                </form>
              </div>
            </div>
          )}

          {/* Import Confirmation Modal */}
          {isImportModalOpen && (
            <div className="modal-overlay" onClick={() => setIsImportModalOpen(false)}>
              <div className="modal" style={{maxWidth: 600}} onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                  <h3>Confirm Import</h3>
                  <button className="btn btn-icon" onClick={() => setIsImportModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
                </div>
                <div className="modal-body">
                  <div style={{padding: 16, background: 'rgba(222, 247, 99, 0.2)', borderRadius: 8, marginBottom: 16}}>
                    <p style={{fontWeight: 600, margin: 0}}><i data-lucide="alert-circle" style={{width: 16, height: 16, display: 'inline', verticalAlign: 'middle', marginRight: 8}}></i>You are about to import {importPreview.length} roles</p>
                    <p className="text-secondary" style={{margin: '8px 0 0 0', fontSize: 13}}>These roles will be added to your existing roles and can be used immediately in project pricing.</p>
                  </div>
                  <div style={{maxHeight: 300, overflowY: 'auto'}}>
                    <table style={{fontSize: 13}}>
                      <thead><tr><th>Role Name</th><th>Department</th><th>Hourly Rate</th></tr></thead>
                      <tbody>
                        {importPreview.slice(0, 20).map((role, i) => (
                          <tr key={i}>
                            <td>{role.name}</td>
                            <td>{role.department || '-'}</td>
                            <td>{formatCurrency(role.hourly_rate)}/hr</td>
                          </tr>
                        ))}
                        {importPreview.length > 20 && <tr><td colSpan={3} className="text-secondary" style={{textAlign: 'center'}}>...and {importPreview.length - 20} more</td></tr>}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div className="modal-footer">
                  <button className="btn btn-secondary" onClick={() => setIsImportModalOpen(false)}>Cancel</button>
                  <button className="btn btn-primary" onClick={confirmImport}><i data-lucide="check" style={{width: 16, height: 16}}></i> Confirm Import</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const ToolsManagement = ({ onRefresh }) => {
      const [tools, setTools] = React.useState([]);
      React.useEffect(() => { setTools(db.getTools()); lucide.createIcons(); }, []);
      return (
        <div>
          <div className="page-header"><div><h1 className="page-title">Tools & Subscriptions</h1><p className="text-secondary">Manage costs for tools and services</p></div></div>
          <div className="card">
            <table>
              <thead><tr><th>Name</th><th>Type</th><th>Cost</th><th>Description</th></tr></thead>
              <tbody>
                {tools.map(tool => (
                  <tr key={tool.id}>
                    <td style={{fontWeight: 500}}>{tool.name}</td>
                    <td><span className="badge badge-info">{tool.cost_type}</span></td>
                    <td style={{color: 'var(--boud-dark)', fontWeight: 600}}>{formatCurrency(tool.cost)}</td>
                    <td className="text-secondary">{tool.description || '-'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    const ProjectsList = ({ onNavigate, refreshKey, onRefresh }) => {
      const [projects, setProjects] = React.useState([]);
      const [isModalOpen, setIsModalOpen] = React.useState(false);
      const [formData, setFormData] = React.useState({ name: '', client: '', duration_weeks: '', target_margin: '30', pricing_models: ['hourly'], risk_margin: '0' });

      React.useEffect(() => {
        const list = db.getProjects().map(p => ({ ...p, ...db.calculateProjectTotals(p.id) }));
        setProjects(list);
        setTimeout(() => lucide.createIcons(), 0);
      }, [refreshKey]);

      const handleSubmit = (e) => {
        e.preventDefault();
        const id = db.createProject({
          name: formData.name,
          client: formData.client,
          duration_weeks: formData.duration_weeks ? parseInt(formData.duration_weeks) : null,
          target_margin: parseFloat(formData.target_margin),
          pricing_models: formData.pricing_models,
          risk_margin: parseFloat(formData.risk_margin) || 0
        });
        setIsModalOpen(false);
        onNavigate('project-pricing', id);
      };

      return (
        <div>
          <div className="page-header">
            <div><h1 className="page-title">Projects</h1><p className="text-secondary">Create and manage pricing models</p></div>
            <button className="btn btn-primary" onClick={() => setIsModalOpen(true)}><i data-lucide="plus" style={{width: 18, height: 18}}></i> New Project</button>
          </div>
          {projects.length === 0 ? (
            <div className="card"><div className="empty-state"><p>No projects yet.</p><button className="btn btn-primary" onClick={() => setIsModalOpen(true)} style={{marginTop: 16}}>Create Project</button></div></div>
          ) : (
            <div style={{display: 'grid', gap: 16}}>
              {projects.map(p => (
                <div key={p.id} className="card" style={{cursor: 'pointer'}} onClick={() => onNavigate('project-pricing', p.id)}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                    <div>
                      <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                        <h3 style={{margin: 0}}>{p.name}</h3>
                        {p.riskMarginPercent > 0 && (
                          <span style={{display: 'inline-flex', alignItems: 'center', gap: 4, padding: '2px 8px', borderRadius: 100, fontSize: 11, fontWeight: 500, background: 'rgba(94, 86, 222, 0.15)', color: 'var(--boud-purple)'}}>
                            <i data-lucide="shield" style={{width: 12, height: 12}}></i>
                            {p.riskMarginPercent}% Risk
                          </span>
                        )}
                        {p.discountPercent > 0 && (
                          <span style={{display: 'inline-flex', alignItems: 'center', gap: 4, padding: '2px 8px', borderRadius: 100, fontSize: 11, fontWeight: 500, background: 'rgba(228, 106, 23, 0.15)', color: 'var(--boud-orange)'}}>
                            <i data-lucide="tag" style={{width: 12, height: 12}}></i>
                            {p.discountPercent}% Off
                          </span>
                        )}
                      </div>
                      <p className="text-secondary" style={{margin: '4px 0 0'}}>{p.client || 'No client'}  {p.duration_weeks ? `${p.duration_weeks} weeks` : 'No duration'}</p>
                    </div>
                    <div style={{display: 'flex', gap: 24, alignItems: 'center'}}>
                      <div style={{textAlign: 'right'}}><div style={{fontSize: 12, color: 'var(--gray-text)'}}>Cost</div><div style={{fontWeight: 500}}>{formatCurrency(p.totalCost)}</div></div>
                      <div style={{textAlign: 'right'}}><div style={{fontSize: 12, color: 'var(--gray-text)'}}>Price</div><div style={{fontSize: 18, fontWeight: 700, color: 'var(--boud-purple)'}}>{formatCurrency(p.sellingPrice)}</div></div>
                      <div style={{textAlign: 'right'}}><div style={{fontSize: 12, color: 'var(--gray-text)'}}>Margin</div><div style={{fontWeight: 600, color: p.actualMargin >= 25 ? 'var(--success)' : p.actualMargin >= 15 ? '#d39e00' : 'var(--error)'}}>{p.actualMargin.toFixed(1)}%</div></div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>Create Project</h3><button className="btn btn-icon" onClick={() => setIsModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <form onSubmit={handleSubmit}>
                  <div className="modal-body">
                    <div className="form-group"><label className="form-label">Project Name *</label><input type="text" className="form-input" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required /></div>
                    <div className="form-group"><label className="form-label">Client</label><input type="text" className="form-input" value={formData.client} onChange={e => setFormData({...formData, client: e.target.value})} /></div>
                    <div className="form-row">
                      <div className="form-group"><label className="form-label">Duration (weeks)</label><input type="number" className="form-input" value={formData.duration_weeks} onChange={e => setFormData({...formData, duration_weeks: e.target.value})} /></div>
                      <div className="form-group"><label className="form-label">Target Margin (%)</label><input type="number" className="form-input" value={formData.target_margin} onChange={e => setFormData({...formData, target_margin: e.target.value})} /></div>
                    </div>
                    <div className="form-group"><label className="form-label">Risk Buffer (%)</label><input type="number" className="form-input" value={formData.risk_margin} onChange={e => setFormData({...formData, risk_margin: e.target.value})} placeholder="0" /></div>
                  </div>
                  <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={() => setIsModalOpen(false)}>Cancel</button><button type="submit" className="btn btn-primary">Create & Configure</button></div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    };

    const Insights = ({ refreshKey }) => {
      const [stats, setStats] = React.useState({ totalProjects: 0, pipelineValue: 0, totalProfit: 0, avgMargin: 0 });
      React.useEffect(() => {
        const projects = db.getProjects();
        let pipelineValue = 0, totalProfit = 0, margins = [];
        projects.forEach(p => {
          const totals = db.calculateProjectTotals(p.id);
          pipelineValue += totals.sellingPrice;
          totalProfit += totals.grossProfit;
          margins.push(totals.actualMargin);
        });
        const avgMargin = margins.length > 0 ? margins.reduce((a, b) => a + b, 0) / margins.length : 0;
        setStats({ totalProjects: projects.length, pipelineValue, totalProfit, avgMargin });
        lucide.createIcons();
      }, [refreshKey]);
      return (
        <div>
          <div className="page-header"><h1 className="page-title">Insights</h1><p className="text-secondary">Performance metrics</p></div>
          <div className="stats-grid">
            <div className="stat-card"><div className="stat-label">Total Projects</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{stats.totalProjects}</div></div>
            <div className="stat-card"><div className="stat-label">Pipeline Value</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{formatCurrency(stats.pipelineValue)}</div></div>
            <div className="stat-card"><div className="stat-label">Total Profit</div><div className="stat-value" style={{color: 'var(--success)'}}>{formatCurrency(stats.totalProfit)}</div></div>
            <div className="stat-card"><div className="stat-label">Average Margin</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{stats.avgMargin.toFixed(1)}%</div></div>
          </div>
        </div>
      );
    };

    const Settings = ({ onRefresh }) => {
      const [vatRate, setVatRate] = React.useState('15');
      const [saved, setSaved] = React.useState(false);
      React.useEffect(() => { const s = localStorage.getItem('boud_vat_rate'); if (s) setVatRate(s); lucide.createIcons(); }, []);
      const handleSave = () => { localStorage.setItem('boud_vat_rate', vatRate); setSaved(true); setTimeout(() => setSaved(false), 2000); onRefresh?.(); };
      return (
        <div>
          <div className="page-header"><div><h1 className="page-title">Settings</h1><p className="text-secondary">Configure application settings</p></div></div>
          <div className="card" style={{maxWidth: 600}}>
            <h3 style={{marginBottom: 24}}>Tax Settings</h3>
            <div className="form-group">
              <label className="form-label">VAT Rate (%)</label>
              <div style={{display: 'flex', gap: 12, alignItems: 'center'}}>
                <input type="number" className="form-input" value={vatRate} onChange={e => setVatRate(e.target.value)} min="0" max="100" style={{maxWidth: 120}} />
                <span>%</span>
              </div>
            </div>
            <button className="btn btn-primary" onClick={handleSave}>Save Settings</button>
            {saved && <span style={{marginLeft: 12, color: 'var(--success)'}}>Saved!</span>}
          </div>
        </div>
      );
    };

    const ApiSettings = ({ onRefresh }) => {
      React.useEffect(() => { lucide.createIcons(); }, []);
      return (
        <div>
          <div className="page-header"><div><h1 className="page-title">API Pricing</h1><p className="text-secondary">Configure API base prices</p></div></div>
          <div className="card"><p>Configure API pricing in Settings.</p></div>
        </div>
      );
    };

    const ProductFees = ({ onRefresh }) => {
      React.useEffect(() => { lucide.createIcons(); }, []);
      return (
        <div>
          <div className="page-header"><div><h1 className="page-title">Product Fees</h1><p className="text-secondary">Configure product license fees</p></div></div>
          <div className="card"><p>Product fees configuration.</p></div>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [isLoading, setIsLoading] = React.useState(true);
      const [isAuthenticated, setIsAuthenticated] = React.useState(false);
      const [currentView, setCurrentView] = React.useState('dashboard');
      const [selectedProjectId, setSelectedProjectId] = React.useState(null);
      const [refreshKey, setRefreshKey] = React.useState(0);
      const [theme, setThemeState] = React.useState(getTheme());
      const [isNotificationsOpen, setIsNotificationsOpen] = React.useState(false);
      const [notifications, setNotifications] = React.useState([
        { id: 1, type: 'success', title: 'Welcome to Boud!', message: 'Your pricing engine is ready to use.', time: 'Just now', read: false },
        { id: 2, type: 'info', title: 'New Features', message: 'Risk margin, discounts, templates & version history now available.', time: '2 min ago', read: false }
      ]);

      React.useEffect(() => {
        loadState();
        document.documentElement.setAttribute('data-theme', theme);
        setIsAuthenticated(isLoggedIn());
        setIsLoading(false);
      }, []);

      const handleNavigate = (view, projectId = null) => {
        setCurrentView(view);
        setSelectedProjectId(projectId);
      };

      const triggerRefresh = () => setRefreshKey(k => k + 1);
      const handleToggleTheme = () => { const newTheme = theme === 'dark' ? 'light' : 'dark'; setThemeState(newTheme); setTheme(newTheme); };
      const handleMarkRead = (id) => setNotifications(prev => prev.map(n => n.id === id ? {...n, read: true} : n));
      const handleClearAll = () => setNotifications([]);
      const unreadCount = notifications.filter(n => !n.read).length;

      const handleLogin = () => setIsAuthenticated(true);
      const handleLogout = () => { setLoggedIn(false); setIsAuthenticated(false); };

      if (isLoading) {
        return (
          <div className="loading-screen">
            <BoudLogo size={56} showText={true} />
            <div style={{marginTop: 16, fontSize: 14, color: 'var(--boud-lime)', textTransform: 'uppercase', letterSpacing: '0.2em'}}>Loading...</div>
          </div>
        );
      }

      if (!isAuthenticated) {
        return <AuthPage onLogin={handleLogin} />;
      }

      const renderContent = () => {
        switch (currentView) {
          case 'dashboard': return <Dashboard onNavigate={handleNavigate} refreshKey={refreshKey} />;
          case 'insights': return <Insights refreshKey={refreshKey} />;
          case 'rates': return <RatesManagement onRefresh={triggerRefresh} />;
          case 'tools': return <ToolsManagement onRefresh={triggerRefresh} />;
          case 'api-settings': return <ApiSettings onRefresh={triggerRefresh} />;
          case 'product-fees': return <ProductFees onRefresh={triggerRefresh} />;
          case 'projects': return <ProjectsList onNavigate={handleNavigate} refreshKey={refreshKey} onRefresh={triggerRefresh} />;
          case 'project-pricing': return <ProjectPricing projectId={selectedProjectId} onBack={() => handleNavigate('projects')} onRefresh={triggerRefresh} onNavigate={handleNavigate} />;
          case 'templates': return <TemplatesLibrary onNavigate={handleNavigate} onRefresh={triggerRefresh} />;
          case 'settings': return <Settings onRefresh={triggerRefresh} />;
          default: return <Dashboard onNavigate={handleNavigate} refreshKey={refreshKey} />;
        }
      };

      return (
        <div className="app-container">
          <Sidebar
            currentView={currentView}
            onNavigate={handleNavigate}
            theme={theme}
            onToggleTheme={handleToggleTheme}
            onOpenNotifications={() => setIsNotificationsOpen(true)}
            notificationCount={unreadCount}
            onLogout={handleLogout}
          />
          <main className="main-content">{renderContent()}</main>
          <NotificationCenter
            isOpen={isNotificationsOpen}
            onClose={() => setIsNotificationsOpen(false)}
            notifications={notifications}
            onMarkRead={handleMarkRead}
            onClearAll={handleClearAll}
          />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
