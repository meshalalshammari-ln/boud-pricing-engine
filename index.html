<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boud Pricing Engine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      /* Brand Colors from Guidelines */
      --boud-magenta: #883f68;
      --boud-purple: #5e56de;
      --boud-orange: #e46a17;
      --boud-lime: #def763;
      --boud-light-gray: #f4f4f4;
      --boud-dark: #231F20;
      --boud-charcoal: #2D2A2B;
      --text-white: #FFFFFF;
      --text-black: #231F20;
      --gray-text: #9A9A9A;
      --success: #4ADE80;
      --warning: #FBBF24;
      --error: #F87171;
      --info: #def763;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--boud-light-gray);
      color: var(--text-black);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    h1 { font-size: 28px; font-weight: 700; color: var(--boud-dark); letter-spacing: -0.02em; }
    h2 { font-size: 22px; font-weight: 600; color: var(--boud-charcoal); }
    h3 { font-size: 18px; font-weight: 600; color: var(--boud-charcoal); }
    h4 { font-size: 14px; font-weight: 600; color: var(--gray-text); text-transform: uppercase; letter-spacing: 0.05em; }
    .text-secondary { color: var(--gray-text); }
    .app-container { display: flex; min-height: 100vh; }
    .sidebar {
      width: 260px;
      background: var(--boud-charcoal);
      color: white;
      padding: var(--spacing-lg);
      display: flex;
      flex-direction: column;
    }
    .main-content { flex: 1; padding: var(--spacing-xl); overflow-y: auto; }
    .logo { display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-2xl); padding-bottom: var(--spacing-lg); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .logo-text { font-size: 24px; font-weight: 700; color: white; letter-spacing: 0.05em; }
    .logo-subtitle { font-size: 11px; color: var(--boud-lime); text-transform: uppercase; letter-spacing: 0.1em; }
    .nav-menu { list-style: none; display: flex; flex-direction: column; gap: var(--spacing-xs); }
    .nav-item { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s ease; color: rgba(255, 255, 255, 0.7); font-size: 14px; font-weight: 500; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.1); color: white; }
    .nav-item.active { background: var(--boud-lime); color: var(--boud-dark); }
    .nav-item svg { width: 20px; height: 20px; }
    .card { background: white; border-radius: var(--radius-lg); padding: var(--spacing-lg); box-shadow: var(--shadow-sm); border: 1px solid rgba(0, 0, 0, 0.05); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--boud-light-gray); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border: none; outline: none; }
    .btn-primary { background: var(--boud-lime); color: var(--boud-dark); }
    .btn-primary:hover { background: #c9e050; }
    .btn-secondary { background: var(--boud-light-gray); color: var(--text-black); border: 1px solid rgba(0, 0, 0, 0.1); }
    .btn-secondary:hover { background: #ebedf0; }
    .btn-danger { background: var(--error); color: white; }
    .btn-purple { background: var(--boud-purple); color: white; }
    .btn-purple:hover { background: #4d47c7; }
    .btn-magenta { background: var(--boud-magenta); color: white; }
    .btn-magenta:hover { background: #703456; }
    .btn-orange { background: var(--boud-orange); color: white; }
    .btn-orange:hover { background: #c55a12; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn-icon { padding: var(--spacing-sm); background: transparent; color: var(--gray-text); }
    .btn-icon:hover { background: var(--boud-light-gray); color: var(--text-black); }
    .form-group { margin-bottom: var(--spacing-md); }
    .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--gray-text); margin-bottom: var(--spacing-xs); }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border: 1px solid rgba(0, 0, 0, 0.15); border-radius: var(--radius-md); font-size: 14px; font-family: inherit; transition: border-color 0.2s ease, box-shadow 0.2s ease; background: white; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--boud-lime); box-shadow: 0 0 0 3px rgba(222, 247, 99, 0.25); }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: var(--spacing-md); font-size: 12px; font-weight: 600; color: var(--gray-text); text-transform: uppercase; letter-spacing: 0.05em; background: var(--boud-light-gray); border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
    td { padding: var(--spacing-md); border-bottom: 1px solid var(--boud-light-gray); font-size: 14px; }
    tr:hover { background: rgba(222, 247, 99, 0.05); }
    .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 100px; font-size: 12px; font-weight: 500; }
    .badge-success { background: rgba(40, 167, 69, 0.1); color: var(--success); }
    .badge-warning { background: rgba(255, 193, 7, 0.15); color: #d39e00; }
    .badge-error { background: rgba(220, 53, 69, 0.1); color: var(--error); }
    .badge-info { background: rgba(222, 247, 99, 0.15); color: #8B9A30; }
    .badge-purple { background: rgba(94, 86, 222, 0.15); color: var(--boud-purple); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-xl); }
    .stat-card { background: white; padding: var(--spacing-lg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid rgba(0, 0, 0, 0.05); }
    .stat-label { font-size: 13px; color: var(--gray-text); margin-bottom: var(--spacing-xs); }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--boud-dark); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: white; border-radius: var(--radius-lg); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-lg); border-bottom: 1px solid var(--boud-light-gray); }
    .modal-body { padding: var(--spacing-lg); }
    .modal-footer { display: flex; justify-content: flex-end; gap: var(--spacing-sm); padding: var(--spacing-lg); border-top: 1px solid var(--boud-light-gray); }
    .tabs { display: flex; gap: var(--spacing-xs); border-bottom: 1px solid rgba(0, 0, 0, 0.1); margin-bottom: var(--spacing-lg); }
    .tab { padding: var(--spacing-md) var(--spacing-lg); font-size: 14px; font-weight: 500; color: var(--gray-text); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s ease; background: none; border-top: none; border-left: none; border-right: none; }
    .tab:hover { color: var(--text-black); }
    .tab.active { color: var(--boud-purple); border-bottom-color: var(--boud-purple); }
    .empty-state { text-align: center; padding: var(--spacing-2xl); color: var(--gray-text); }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl); }
    .page-title { font-size: 24px; font-weight: 700; color: var(--boud-dark); }
    .margin-display { display: flex; align-items: center; gap: var(--spacing-lg); padding: var(--spacing-lg); background: var(--boud-dark); border-radius: var(--radius-lg); color: white; flex-wrap: wrap; }
    .margin-item { text-align: center; }
    .margin-item .label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.7; margin-bottom: 4px; }
    .margin-item .value { font-size: 24px; font-weight: 700; }
    .margin-divider { width: 1px; height: 40px; background: rgba(255, 255, 255, 0.2); }
    .phase-section { background: white; border-radius: var(--radius-lg); margin-bottom: var(--spacing-md); border: 1px solid rgba(0, 0, 0, 0.05); overflow: hidden; }
    .phase-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md) var(--spacing-lg); background: var(--boud-light-gray); cursor: pointer; }
    .phase-content { padding: var(--spacing-lg); }
    .actions { display: flex; gap: var(--spacing-sm); }
    .loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #231F20; color: white; }
    @keyframes loading { 0% { transform: translateX(-100%); } 50% { transform: translateX(100%); } 100% { transform: translateX(200%); } }

    /* Auth Page Styles */
    .auth-container { min-height: 100vh; display: flex; }
    .auth-left { flex: 1; background: linear-gradient(135deg, var(--boud-purple) 0%, var(--boud-magenta) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px; color: white; }
    .auth-right { flex: 1; display: flex; align-items: center; justify-content: center; padding: 48px; background: white; }
    .auth-form { width: 100%; max-width: 400px; }
    .auth-title { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
    .auth-subtitle { color: var(--gray-text); margin-bottom: 32px; }
    .auth-divider { display: flex; align-items: center; gap: 16px; margin: 24px 0; color: var(--gray-text); font-size: 13px; }
    .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: rgba(0,0,0,0.1); }
    .auth-link { color: var(--boud-purple); text-decoration: none; font-weight: 500; cursor: pointer; }
    .auth-link:hover { text-decoration: underline; }

    /* Dark Mode Styles */
    [data-theme="dark"] {
      --boud-light-gray: #1a1a1a;
      --text-black: #ffffff;
      --gray-text: #a0a0a0;
    }
    [data-theme="dark"] body { background-color: #121212; color: #ffffff; }
    [data-theme="dark"] .card { background: #1e1e1e; border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] .stat-card { background: #1e1e1e; }
    [data-theme="dark"] .stat-value { color: #ffffff; }
    [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3 { color: #ffffff; }
    [data-theme="dark"] .page-title { color: #ffffff; }
    [data-theme="dark"] .form-input, [data-theme="dark"] .form-select, [data-theme="dark"] .form-textarea {
      background: #2a2a2a; border-color: rgba(255,255,255,0.2); color: #ffffff;
    }
    [data-theme="dark"] .modal { background: #1e1e1e; }
    [data-theme="dark"] .modal-header, [data-theme="dark"] .modal-footer { border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] th { background: #2a2a2a; }
    [data-theme="dark"] td { border-color: rgba(255,255,255,0.05); }
    [data-theme="dark"] .phase-section { background: #1e1e1e; border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] .phase-header { background: #2a2a2a; }
    [data-theme="dark"] .btn-secondary { background: #2a2a2a; color: #ffffff; border-color: rgba(255,255,255,0.2); }
    [data-theme="dark"] .tabs { border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] .notification-panel { background: #1e1e1e; }
    [data-theme="dark"] .notification-item { border-color: rgba(255,255,255,0.1); }
    [data-theme="dark"] .auth-right { background: #1e1e1e; }

    /* Notification Panel */
    .notification-panel {
      position: fixed; top: 0; right: -400px; width: 400px; height: 100vh;
      background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      z-index: 1001; transition: right 0.3s ease; overflow-y: auto;
    }
    .notification-panel.open { right: 0; }
    .notification-item {
      padding: 16px; border-bottom: 1px solid var(--boud-light-gray);
      cursor: pointer; transition: background 0.2s;
    }
    .notification-item:hover { background: var(--boud-light-gray); }
    .notification-item.unread { background: rgba(222, 247, 99, 0.1); }
    .notification-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.3);
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s;
    }
    .notification-overlay.open { opacity: 1; visibility: visible; }

    /* Version History */
    .version-history { max-height: 400px; overflow-y: auto; }
    .version-item { padding: 12px 16px; border-left: 3px solid var(--boud-purple); background: var(--boud-light-gray); margin-bottom: 8px; border-radius: 0 8px 8px 0; }
    .version-time { font-size: 11px; color: var(--gray-text); }
    .version-change { font-size: 13px; margin-top: 4px; }

    /* Template Card */
    .template-card { padding: 16px; border: 2px solid var(--boud-light-gray); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
    .template-card:hover { border-color: var(--boud-purple); background: rgba(94, 86, 222, 0.05); }
    .template-card.selected { border-color: var(--boud-lime); background: rgba(222, 247, 99, 0.1); }

    /* Role Selector Styles */
    .role-selector { position: relative; }
    .role-selector-trigger { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border: 1px solid var(--boud-light-gray); border-radius: 8px; background: white; cursor: pointer; min-height: 44px; transition: all 0.2s; }
    .role-selector-trigger:hover { border-color: var(--boud-purple); }
    .role-selector-trigger.open { border-color: var(--boud-purple); box-shadow: 0 0 0 3px rgba(94, 86, 222, 0.1); }
    .role-selector-placeholder { color: var(--gray-text); }
    .role-selector-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--boud-light-gray); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 1000; margin-top: 4px; max-height: 380px; overflow: hidden; display: flex; flex-direction: column; }
    .role-selector-search { padding: 12px; border-bottom: 1px solid var(--boud-light-gray); }
    .role-selector-search input { width: 100%; padding: 10px 12px; border: 1px solid var(--boud-light-gray); border-radius: 8px; font-size: 14px; }
    .role-selector-search input:focus { outline: none; border-color: var(--boud-purple); }
    .role-selector-tabs { display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid var(--boud-light-gray); flex-wrap: wrap; }
    .role-selector-tab { padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; background: var(--boud-light-gray); border: none; transition: all 0.15s; }
    .role-selector-tab:hover { background: rgba(94, 86, 222, 0.1); }
    .role-selector-tab.active { background: var(--boud-purple); color: white; }
    .role-selector-list { flex: 1; overflow-y: auto; padding: 8px; }
    .role-selector-section { margin-bottom: 8px; }
    .role-selector-section-title { font-size: 11px; font-weight: 600; color: var(--gray-text); text-transform: uppercase; padding: 4px 8px; }
    .role-selector-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.15s; }
    .role-selector-item:hover { background: rgba(94, 86, 222, 0.08); }
    .role-selector-item.selected { background: rgba(94, 86, 222, 0.12); }
    .role-selector-item-name { font-weight: 500; }
    .role-selector-item-rate { font-size: 13px; color: var(--gray-text); }
    .role-selector-item-dept { font-size: 11px; color: var(--boud-purple); background: rgba(94, 86, 222, 0.1); padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    .role-selector-empty { padding: 24px; text-align: center; color: var(--gray-text); }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Simple UUID generator
    const generateId = (prefix = '') => prefix + '_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);

    // Schema version for data migrations
    const SCHEMA_VERSION = 5;

    // Permission definitions
    const PERMISSIONS = {
      pricing_edit: 'Edit pricing & rates',
      pricing_view: 'View pricing & rates',
      boq_edit: 'Edit BOQ items',
      boq_view: 'View BOQ',
      approve: 'Approve projects',
      create_cr: 'Create change requests',
      view_audit: 'View audit log',
      manage_users: 'Manage users',
      manage_credits: 'Manage credits & packages',
      export: 'Export proposals & CSV',
      manage_templates: 'Manage templates'
    };

    const ROLE_PRESETS = {
      super_admin: { label: 'Super Admin', permissions: Object.keys(PERMISSIONS).reduce((acc, k) => ({...acc, [k]: true}), {}) },
      admin: { label: 'Admin', permissions: { pricing_edit: true, pricing_view: true, boq_edit: true, boq_view: true, approve: true, create_cr: true, view_audit: true, manage_credits: true, export: true, manage_templates: true, manage_users: false } },
      manager: { label: 'Manager', permissions: { pricing_view: true, boq_view: true, approve: true, create_cr: true, view_audit: true, export: true, pricing_edit: false, boq_edit: false, manage_users: false, manage_credits: false, manage_templates: false } },
      bd_user: { label: 'BD User', permissions: { pricing_edit: true, pricing_view: true, boq_edit: true, boq_view: true, create_cr: true, export: true, approve: false, view_audit: false, manage_users: false, manage_credits: false, manage_templates: false } },
      operator: { label: 'Operator', permissions: { pricing_view: true, boq_view: true, view_audit: true, pricing_edit: false, boq_edit: false, approve: false, create_cr: false, manage_users: false, manage_credits: false, export: false, manage_templates: false } },
      finance: { label: 'Finance', permissions: { pricing_view: true, boq_view: true, view_audit: true, export: true, pricing_edit: false, boq_edit: false, approve: false, create_cr: false, manage_users: false, manage_credits: false, manage_templates: false } },
      collections: { label: 'Collections', permissions: { pricing_view: true, boq_view: true, pricing_edit: false, boq_edit: false, approve: false, create_cr: false, view_audit: false, manage_users: false, manage_credits: false, export: false, manage_templates: false } }
    };

    // Database state stored in memory (will use localStorage for persistence)
    let dbState = {
      schema_version: SCHEMA_VERSION,
      roles: [],
      tools: [],
      projects: [],
      phases: [],
      resourceCosts: [],
      toolCosts: [],
      vendorCosts: [],
      boqItems: [],
      rateHistory: [],
      versionHistory: [],
      changeRequests: [],
      creditDefinitions: [],
      clientAgreements: [],
      packages: [],
      users: [],
      currentUserId: null,
      paymentSchedules: [],
      templates: [],
      recentRoles: []
    };

    // Migrate data from older schema versions
    const migrateState = (state) => {
      const version = state.schema_version || 1;

      // Ensure new collections exist
      if (!state.versionHistory) state.versionHistory = [];
      if (!state.templates) state.templates = [];
      if (!state.boqItems) state.boqItems = [];
      if (!state.changeRequests) state.changeRequests = [];

      // Migration v1 → v2: hourly_rate → daily_rate, hours → days
      if (version < 2) {
        // Convert role rates: daily_rate = hourly_rate * 5 (1 day = 5 hours)
        state.roles.forEach(role => {
          if (role.hourly_rate !== undefined && role.daily_rate === undefined) {
            role.daily_rate = Math.round(role.hourly_rate * 5 * 100) / 100;
          }
        });

        // Convert resource costs: hours → days
        state.resourceCosts.forEach(rc => {
          if (rc.hours !== undefined && rc.days === undefined) {
            rc.days = Math.round((rc.hours / 5) * 100) / 100;
          }
          // Convert rate_override from hourly to daily
          if (rc.rate_override && rc.daily_rate_override === undefined) {
            rc.daily_rate_override = Math.round(rc.rate_override * 5 * 100) / 100;
          }
        });

        // Add margin_percent to phases
        state.phases.forEach(phase => {
          if (phase.margin_percent === undefined) phase.margin_percent = null;
        });

        // Add status to projects if missing
        state.projects.forEach(project => {
          if (!project.status) project.status = 'draft';
          // Add duration_months if missing
          if (project.duration_months === undefined) {
            project.duration_months = project.duration_weeks ? Math.round(project.duration_weeks / 4.33) : null;
          }
        });

        state.schema_version = 2;
      }

      if (version < 3) {
        if (!state.creditDefinitions) state.creditDefinitions = [];
        if (!state.clientAgreements) state.clientAgreements = [];
        if (!state.packages) state.packages = [];

        // Seed default credit definitions if empty
        if (state.creditDefinitions.length === 0) {
          state.creditDefinitions = [
            { id: 'cred_1', name: 'Design Hour', type: 'monetary', sar_value: 500, unit_label: 'Design Hour', is_active: true },
            { id: 'cred_2', name: 'Dev Hour', type: 'monetary', sar_value: 700, unit_label: 'Dev Hour', is_active: true },
            { id: 'cred_3', name: 'API Call', type: 'usage', sar_value: 0.5, unit_label: 'API Call', is_active: true },
            { id: 'cred_4', name: 'Support Ticket', type: 'operational', sar_value: 150, unit_label: 'Support Ticket', is_active: true },
            { id: 'cred_5', name: 'Consultation Hour', type: 'monetary', sar_value: 800, unit_label: 'Consultation Hour', is_active: true }
          ];
        }

        // Seed default Hackify packages if empty
        if (state.packages.length === 0) {
          state.packages = [
            {
              id: 'pkg_1', name: 'Hackify Basic', price_sar: 15000, is_active: true,
              credit_bundle: [
                { credit_def_id: 'cred_1', quantity: 10 },
                { credit_def_id: 'cred_2', quantity: 15 },
                { credit_def_id: 'cred_4', quantity: 5 }
              ],
              included_services: [
                { service_name: 'UI/UX Design', credit_allocation: 10 },
                { service_name: 'Frontend Dev', credit_allocation: 15 },
                { service_name: 'Support', credit_allocation: 5 }
              ]
            },
            {
              id: 'pkg_2', name: 'Hackify Plus', price_sar: 35000, is_active: true,
              credit_bundle: [
                { credit_def_id: 'cred_1', quantity: 25 },
                { credit_def_id: 'cred_2', quantity: 40 },
                { credit_def_id: 'cred_3', quantity: 10000 },
                { credit_def_id: 'cred_4', quantity: 15 },
                { credit_def_id: 'cred_5', quantity: 5 }
              ],
              included_services: [
                { service_name: 'UI/UX Design', credit_allocation: 25 },
                { service_name: 'Full-Stack Dev', credit_allocation: 40 },
                { service_name: 'API Access', credit_allocation: 10000 },
                { service_name: 'Support', credit_allocation: 15 },
                { service_name: 'Consultation', credit_allocation: 5 }
              ]
            }
          ];
        }

        state.schema_version = 3;
      }

      if (version < 4) {
        if (!state.users) state.users = [];
        if (!state.currentUserId) state.currentUserId = null;

        // Create default Super Admin user
        if (state.users.length === 0) {
          const adminUser = {
            id: 'user_admin',
            name: 'Admin',
            email: 'admin@boud.sa',
            role: 'super_admin',
            permissions: { ...ROLE_PRESETS.super_admin.permissions },
            is_active: true,
            created_at: new Date().toISOString()
          };
          state.users.push(adminUser);
          state.currentUserId = 'user_admin';
        }

        state.schema_version = 4;
      }

      if (version < 5) {
        if (!state.paymentSchedules) state.paymentSchedules = [];
        state.schema_version = 5;
      }

      return state;
    };

    // Load from localStorage
    const loadState = () => {
      const saved = localStorage.getItem('boud_pricing_state');
      if (saved) {
        dbState = migrateState(JSON.parse(saved));
        saveState();
      } else {
        // Seed initial data - 89 roles from Resources Pricing List
        dbState.roles = [
          // Product Owner (PO) — daily_rate = hourly_rate * 5 (1 day = 5 hours)
          { id: 'role_1', name: 'Senior Consultant - PO', hourly_rate: 710, daily_rate: 3550, department: 'PO', grade: 7 },
          { id: 'role_2', name: 'Consultant - PO', hourly_rate: 600, daily_rate: 3000, department: 'PO', grade: 8 },
          { id: 'role_3', name: 'Associate Consultant - PO', hourly_rate: 450, daily_rate: 2250, department: 'PO', grade: 9 },
          { id: 'role_4', name: 'Senior Specialist - PO', hourly_rate: 250, daily_rate: 1250, department: 'PO', grade: 10 },
          { id: 'role_5', name: 'Specialist - PO', hourly_rate: 190, daily_rate: 950, department: 'PO', grade: 11 },
          { id: 'role_6', name: 'Senior Analyst - PO', hourly_rate: 142.5, daily_rate: 712.5, department: 'PO', grade: 12 },
          { id: 'role_7', name: 'Junior Analyst - PO', hourly_rate: 110, daily_rate: 550, department: 'PO', grade: 13 },
          { id: 'role_8', name: 'Intern - PO', hourly_rate: 15, daily_rate: 75, department: 'PO', grade: 14 },
          // Project Management (PM)
          { id: 'role_9', name: 'Senior Consultant - PM', hourly_rate: 560, daily_rate: 2800, department: 'PM', grade: 7 },
          { id: 'role_10', name: 'Consultant - PM', hourly_rate: 450, daily_rate: 2250, department: 'PM', grade: 8 },
          { id: 'role_11', name: 'Associate Consultant - PM', hourly_rate: 350, daily_rate: 1750, department: 'PM', grade: 9 },
          { id: 'role_12', name: 'Senior Specialist - PM', hourly_rate: 220, daily_rate: 1100, department: 'PM', grade: 10 },
          { id: 'role_13', name: 'Specialist - PM', hourly_rate: 150, daily_rate: 750, department: 'PM', grade: 11 },
          { id: 'role_14', name: 'Senior Analyst - PM', hourly_rate: 100, daily_rate: 500, department: 'PM', grade: 12 },
          { id: 'role_15', name: 'Junior Analyst - PM', hourly_rate: 70, daily_rate: 350, department: 'PM', grade: 13 },
          { id: 'role_16', name: 'Intern - PM', hourly_rate: 30, daily_rate: 150, department: 'PM', grade: 14 },
          // Business Analysis (BA)
          { id: 'role_17', name: 'Senior Consultant - BA', hourly_rate: 350, daily_rate: 1750, department: 'BA', grade: 7 },
          { id: 'role_18', name: 'Consultant - BA', hourly_rate: 300, daily_rate: 1500, department: 'BA', grade: 8 },
          { id: 'role_19', name: 'Associate Consultant - BA', hourly_rate: 250, daily_rate: 1250, department: 'BA', grade: 9 },
          { id: 'role_20', name: 'Senior Specialist - BA', hourly_rate: 200, daily_rate: 1000, department: 'BA', grade: 10 },
          { id: 'role_21', name: 'Specialist - BA', hourly_rate: 170, daily_rate: 850, department: 'BA', grade: 11 },
          { id: 'role_22', name: 'Senior Analyst - BA', hourly_rate: 140, daily_rate: 700, department: 'BA', grade: 12 },
          { id: 'role_23', name: 'Junior Analyst - BA', hourly_rate: 100, daily_rate: 500, department: 'BA', grade: 13 },
          { id: 'role_24', name: 'Intern - BA', hourly_rate: 30, daily_rate: 150, department: 'BA', grade: 14 },
          // UX/UI Design (UXUI)
          { id: 'role_25', name: 'Senior Consultant - UXUI', hourly_rate: 450, daily_rate: 2250, department: 'UXUI', grade: 7 },
          { id: 'role_26', name: 'Consultant - UXUI', hourly_rate: 300, daily_rate: 1500, department: 'UXUI', grade: 8 },
          { id: 'role_27', name: 'Associate Consultant - UXUI', hourly_rate: 200, daily_rate: 1000, department: 'UXUI', grade: 9 },
          { id: 'role_28', name: 'Senior Specialist - UXUI', hourly_rate: 160, daily_rate: 800, department: 'UXUI', grade: 10 },
          { id: 'role_29', name: 'Specialist - UXUI', hourly_rate: 125, daily_rate: 625, department: 'UXUI', grade: 11 },
          { id: 'role_30', name: 'Senior Analyst - UXUI', hourly_rate: 95, daily_rate: 475, department: 'UXUI', grade: 12 },
          { id: 'role_31', name: 'Junior Analyst - UXUI', hourly_rate: 57, daily_rate: 285, department: 'UXUI', grade: 13 },
          { id: 'role_32', name: 'Intern - UXUI', hourly_rate: 30, daily_rate: 150, department: 'UXUI', grade: 14 },
          // Front End (FE)
          { id: 'role_33', name: 'Senior Consultant Engineer - FE', hourly_rate: 250, daily_rate: 1250, department: 'FE', grade: 7 },
          { id: 'role_34', name: 'Consultant Engineer - FE', hourly_rate: 200, daily_rate: 1000, department: 'FE', grade: 8 },
          { id: 'role_35', name: 'Associate Consultant Engineer - FE', hourly_rate: 160, daily_rate: 800, department: 'FE', grade: 9 },
          { id: 'role_36', name: 'Senior Specialist - FE', hourly_rate: 120, daily_rate: 600, department: 'FE', grade: 10 },
          { id: 'role_37', name: 'Specialist - FE', hourly_rate: 80, daily_rate: 400, department: 'FE', grade: 11 },
          { id: 'role_38', name: 'Senior Analyst - FE', hourly_rate: 45, daily_rate: 225, department: 'FE', grade: 12 },
          { id: 'role_39', name: 'Junior Analyst - FE', hourly_rate: 45, daily_rate: 225, department: 'FE', grade: 13 },
          { id: 'role_40', name: 'Intern - FE', hourly_rate: 30, daily_rate: 150, department: 'FE', grade: 14 },
          // Mobile Development (Mobile)
          { id: 'role_41', name: 'Senior Consultant Engineer - Mobile', hourly_rate: 350, daily_rate: 1750, department: 'Mobile', grade: 7 },
          { id: 'role_42', name: 'Consultant Engineer - Mobile', hourly_rate: 250, daily_rate: 1250, department: 'Mobile', grade: 8 },
          { id: 'role_43', name: 'Associate Consultant Engineer - Mobile', hourly_rate: 200, daily_rate: 1000, department: 'Mobile', grade: 9 },
          { id: 'role_44', name: 'Senior Specialist - Mobile', hourly_rate: 140, daily_rate: 700, department: 'Mobile', grade: 10 },
          { id: 'role_45', name: 'Specialist - Mobile', hourly_rate: 80, daily_rate: 400, department: 'Mobile', grade: 11 },
          { id: 'role_46', name: 'Senior Analyst - Mobile', hourly_rate: 57, daily_rate: 285, department: 'Mobile', grade: 12 },
          { id: 'role_47', name: 'Junior Analyst - Mobile', hourly_rate: 40, daily_rate: 200, department: 'Mobile', grade: 13 },
          { id: 'role_48', name: 'Intern - Mobile', hourly_rate: 30, daily_rate: 150, department: 'Mobile', grade: 14 },
          // Back End (BE)
          { id: 'role_49', name: 'Senior Consultant Engineer - BE', hourly_rate: 250, daily_rate: 1250, department: 'BE', grade: 7 },
          { id: 'role_50', name: 'Consultant Engineer - BE', hourly_rate: 190, daily_rate: 950, department: 'BE', grade: 8 },
          { id: 'role_51', name: 'Associate Consultant Engineer - BE', hourly_rate: 150, daily_rate: 750, department: 'BE', grade: 9 },
          { id: 'role_52', name: 'Senior Specialist - BE', hourly_rate: 115, daily_rate: 575, department: 'BE', grade: 10 },
          { id: 'role_53', name: 'Specialist - BE', hourly_rate: 90, daily_rate: 450, department: 'BE', grade: 11 },
          { id: 'role_54', name: 'Senior Analyst - BE', hourly_rate: 70, daily_rate: 350, department: 'BE', grade: 12 },
          { id: 'role_55', name: 'Junior Analyst - BE', hourly_rate: 50, daily_rate: 250, department: 'BE', grade: 13 },
          { id: 'role_56', name: 'Intern - BE', hourly_rate: 30, daily_rate: 150, department: 'BE', grade: 14 },
          // Quality Assurance (QA)
          { id: 'role_57', name: 'Senior Consultant - QA', hourly_rate: 250, daily_rate: 1250, department: 'QA', grade: 7 },
          { id: 'role_58', name: 'Consultant - QA', hourly_rate: 190, daily_rate: 950, department: 'QA', grade: 8 },
          { id: 'role_59', name: 'Associate Consultant - QA', hourly_rate: 150, daily_rate: 750, department: 'QA', grade: 9 },
          { id: 'role_60', name: 'Senior Specialist - QA', hourly_rate: 115, daily_rate: 575, department: 'QA', grade: 10 },
          { id: 'role_61', name: 'Specialist - QA', hourly_rate: 90, daily_rate: 450, department: 'QA', grade: 11 },
          { id: 'role_62', name: 'Senior Analyst - QA', hourly_rate: 70, daily_rate: 350, department: 'QA', grade: 12 },
          { id: 'role_63', name: 'Junior Analyst - QA', hourly_rate: 50, daily_rate: 250, department: 'QA', grade: 13 },
          { id: 'role_64', name: 'Intern - QA', hourly_rate: 30, daily_rate: 150, department: 'QA', grade: 14 },
          // Scrum Master (SM)
          { id: 'role_65', name: 'Senior Consultant - SM', hourly_rate: 250, daily_rate: 1250, department: 'SM', grade: 7 },
          { id: 'role_66', name: 'Consultant - SM', hourly_rate: 190, daily_rate: 950, department: 'SM', grade: 8 },
          { id: 'role_67', name: 'Associate Consultant - SM', hourly_rate: 150, daily_rate: 750, department: 'SM', grade: 9 },
          { id: 'role_68', name: 'Senior Specialist - SM', hourly_rate: 115, daily_rate: 575, department: 'SM', grade: 10 },
          { id: 'role_69', name: 'Specialist - SM', hourly_rate: 90, daily_rate: 450, department: 'SM', grade: 11 },
          { id: 'role_70', name: 'Senior Analyst - SM', hourly_rate: 70, daily_rate: 350, department: 'SM', grade: 12 },
          { id: 'role_71', name: 'Junior Analyst - SM', hourly_rate: 50, daily_rate: 250, department: 'SM', grade: 13 },
          { id: 'role_72', name: 'Intern - SM', hourly_rate: 30, daily_rate: 150, department: 'SM', grade: 14 },
          // CMS Development (CMS)
          { id: 'role_73', name: 'Senior Consultant - CMS', hourly_rate: 250, daily_rate: 1250, department: 'CMS', grade: 7 },
          { id: 'role_74', name: 'Consultant - CMS', hourly_rate: 190, daily_rate: 950, department: 'CMS', grade: 8 },
          { id: 'role_75', name: 'Associate Consultant - CMS', hourly_rate: 150, daily_rate: 750, department: 'CMS', grade: 9 },
          { id: 'role_76', name: 'Senior Specialist - CMS', hourly_rate: 115, daily_rate: 575, department: 'CMS', grade: 10 },
          { id: 'role_77', name: 'Specialist - CMS', hourly_rate: 90, daily_rate: 450, department: 'CMS', grade: 11 },
          { id: 'role_78', name: 'Senior Analyst - CMS', hourly_rate: 70, daily_rate: 350, department: 'CMS', grade: 12 },
          { id: 'role_79', name: 'Junior Analyst - CMS', hourly_rate: 50, daily_rate: 250, department: 'CMS', grade: 13 },
          { id: 'role_80', name: 'Intern - CMS', hourly_rate: 30, daily_rate: 150, department: 'CMS', grade: 14 },
          // Data Analytics (DA)
          { id: 'role_81', name: 'Senior Consultant - DA', hourly_rate: 490.91, daily_rate: 2454.55, department: 'DA', grade: 7 },
          { id: 'role_82', name: 'Consultant - DA', hourly_rate: 409.09, daily_rate: 2045.45, department: 'DA', grade: 8 },
          { id: 'role_83', name: 'Associate Consultant - DA', hourly_rate: 318.18, daily_rate: 1590.9, department: 'DA', grade: 9 },
          { id: 'role_84', name: 'Senior Specialist - DA', hourly_rate: 227.27, daily_rate: 1136.35, department: 'DA', grade: 10 },
          { id: 'role_85', name: 'Specialist - DA', hourly_rate: 181.82, daily_rate: 909.1, department: 'DA', grade: 11 },
          { id: 'role_86', name: 'Senior Analyst - DA', hourly_rate: 159.09, daily_rate: 795.45, department: 'DA', grade: 12 },
          { id: 'role_87', name: 'Junior Analyst - DA', hourly_rate: 136.36, daily_rate: 681.8, department: 'DA', grade: 13 },
          { id: 'role_88', name: 'Intern - DA', hourly_rate: 45.45, daily_rate: 227.25, department: 'DA', grade: 14 },
          // Other
          { id: 'role_89', name: 'Web Designer', hourly_rate: 109.09, daily_rate: 545.45, department: 'Design', grade: 15 }
        ];
        dbState.tools = [
          { id: 'tool_1', name: 'AWS Cloud Services', cost_type: 'monthly', cost: 500, description: 'Cloud infrastructure' },
          { id: 'tool_2', name: 'Azure Cloud Services', cost_type: 'monthly', cost: 500, description: 'Cloud infrastructure' },
          { id: 'tool_3', name: 'Figma Enterprise', cost_type: 'monthly', cost: 75, description: 'Design tool' },
          { id: 'tool_4', name: 'GitHub Enterprise', cost_type: 'monthly', cost: 21, description: 'Version control' },
          { id: 'tool_5', name: 'Jira', cost_type: 'monthly', cost: 10, description: 'Project tracking' },
          { id: 'tool_6', name: 'OpenAI API Credits', cost_type: 'one-time', cost: 1000, description: 'AI API usage' }
        ];
        dbState.versionHistory = [];
        dbState.templates = [];
        dbState.boqItems = [];
        dbState.changeRequests = [];
        dbState.schema_version = SCHEMA_VERSION;
        saveState();
      }
    };

    const saveState = () => {
      localStorage.setItem('boud_pricing_state', JSON.stringify(dbState));
    };

    // Version History tracking
    const addVersionHistory = (projectId, changeType, changeDescription, changedBy = 'User') => {
      const entry = {
        id: generateId('vh'),
        project_id: projectId,
        change_type: changeType,
        description: changeDescription,
        changed_by: changedBy,
        changed_at: new Date().toISOString()
      };
      dbState.versionHistory.push(entry);
      saveState();
    };

    // Templates management
    const getTemplates = () => dbState.templates || [];
    const saveTemplate = (template) => {
      const id = generateId('tmpl');
      dbState.templates.push({ id, ...template, created_at: new Date().toISOString() });
      saveState();
      return id;
    };
    const deleteTemplate = (id) => {
      dbState.templates = dbState.templates.filter(t => t.id !== id);
      saveState();
    };

    // Database operations
    const db = {
      getRoles: () => [...dbState.roles],
      createRole: (name, daily_rate, description) => {
        const id = generateId('role');
        const hourly_rate = Math.round((daily_rate / 5) * 100) / 100;
        dbState.roles.push({ id, name, daily_rate, hourly_rate, description, updated_at: new Date().toISOString() });
        saveState();
        return id;
      },
      updateRole: (id, name, daily_rate, description) => {
        const idx = dbState.roles.findIndex(r => r.id === id);
        if (idx !== -1) {
          const oldRate = dbState.roles[idx].daily_rate;
          const hourly_rate = Math.round((daily_rate / 5) * 100) / 100;
          dbState.roles[idx] = { ...dbState.roles[idx], name, daily_rate, hourly_rate, description, updated_at: new Date().toISOString() };
          if (oldRate !== daily_rate) {
            dbState.rateHistory.push({ id: generateId('hist'), role_id: id, old_rate: oldRate, new_rate: daily_rate, changed_at: new Date().toISOString() });
          }
          saveState();
        }
      },
      deleteRole: (id) => {
        dbState.roles = dbState.roles.filter(r => r.id !== id);
        saveState();
      },
      updateRoleStatus: (id, status) => {
        const idx = dbState.roles.findIndex(r => r.id === id);
        if (idx !== -1) {
          dbState.roles[idx] = { ...dbState.roles[idx], status, updated_at: new Date().toISOString() };
          saveState();
        }
      },
      getRecentRoles: () => dbState.recentRoles || [],
      addRecentRole: (roleId) => {
        if (!dbState.recentRoles) dbState.recentRoles = [];
        dbState.recentRoles = [roleId, ...dbState.recentRoles.filter(id => id !== roleId)].slice(0, 8);
        saveState();
      },

      getTools: () => [...dbState.tools],
      createTool: (name, cost_type, cost, description) => {
        const id = generateId('tool');
        dbState.tools.push({ id, name, cost_type, cost, description });
        saveState();
        return id;
      },
      updateTool: (id, name, cost_type, cost, description) => {
        const idx = dbState.tools.findIndex(t => t.id === id);
        if (idx !== -1) {
          dbState.tools[idx] = { ...dbState.tools[idx], name, cost_type, cost, description };
          saveState();
        }
      },
      deleteTool: (id) => {
        dbState.tools = dbState.tools.filter(t => t.id !== id);
        saveState();
      },

      getProjects: () => [...dbState.projects].sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at)),
      getProject: (id) => dbState.projects.find(p => p.id === id),
      createProject: (data) => {
        const id = generateId('proj');
        const project = {
          id, ...data,
          status: 'draft',
          risk_margin: data.risk_margin || 0,
          discount_percent: data.discount_percent || 0,
          discount_amount: data.discount_amount || 0,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        dbState.projects.push(project);
        const phaseId = generateId('phase');
        dbState.phases.push({ id: phaseId, project_id: id, name: 'Phase 1', order_index: 0 });
        addVersionHistory(id, 'created', 'Project created');
        saveState();
        return id;
      },
      updateProject: (id, data, trackHistory = true) => {
        const idx = dbState.projects.findIndex(p => p.id === id);
        if (idx !== -1) {
          const oldProject = dbState.projects[idx];
          dbState.projects[idx] = { ...oldProject, ...data, updated_at: new Date().toISOString() };

          // Track specific changes
          if (trackHistory) {
            if (data.risk_margin !== undefined && data.risk_margin !== oldProject.risk_margin) {
              addVersionHistory(id, 'risk_margin', `Risk margin changed from ${oldProject.risk_margin || 0}% to ${data.risk_margin}%`);
            }
            if (data.discount_percent !== undefined && data.discount_percent !== oldProject.discount_percent) {
              addVersionHistory(id, 'discount', `Discount changed from ${oldProject.discount_percent || 0}% to ${data.discount_percent}%`);
            }
            if (data.target_margin !== undefined && data.target_margin !== oldProject.target_margin) {
              addVersionHistory(id, 'margin', `Target margin changed from ${oldProject.target_margin}% to ${data.target_margin}%`);
            }
          }
          saveState();
        }
      },
      deleteProject: (id) => {
        const phases = dbState.phases.filter(p => p.project_id === id);
        phases.forEach(phase => {
          dbState.resourceCosts = dbState.resourceCosts.filter(rc => rc.phase_id !== phase.id);
          dbState.toolCosts = dbState.toolCosts.filter(tc => tc.phase_id !== phase.id);
          dbState.vendorCosts = dbState.vendorCosts.filter(vc => vc.phase_id !== phase.id);
        });
        dbState.phases = dbState.phases.filter(p => p.project_id !== id);
        dbState.projects = dbState.projects.filter(p => p.id !== id);
        dbState.boqItems = (dbState.boqItems || []).filter(b => b.project_id !== id);
        dbState.changeRequests = (dbState.changeRequests || []).filter(cr => cr.project_id !== id);
        dbState.versionHistory = dbState.versionHistory.filter(v => v.project_id !== id);
        saveState();
      },

      getVersionHistory: (projectId) => (dbState.versionHistory || []).filter(v => v.project_id === projectId).sort((a, b) => new Date(b.changed_at) - new Date(a.changed_at)),

      getPhases: (projectId) => dbState.phases.filter(p => p.project_id === projectId).sort((a, b) => a.order_index - b.order_index),
      createPhase: (projectId, name) => {
        const id = generateId('phase');
        const phases = dbState.phases.filter(p => p.project_id === projectId);
        dbState.phases.push({ id, project_id: projectId, name, order_index: phases.length });
        addVersionHistory(projectId, 'phase_added', `Phase "${name}" added`);
        saveState();
        return id;
      },
      updatePhase: (id, updates) => {
        const idx = dbState.phases.findIndex(p => p.id === id);
        if (idx !== -1) {
          if (typeof updates === 'string') {
            dbState.phases[idx].name = updates;
          } else {
            Object.assign(dbState.phases[idx], updates);
          }
          saveState();
        }
      },
      deletePhase: (id) => {
        const phase = dbState.phases.find(p => p.id === id);
        if (phase) {
          addVersionHistory(phase.project_id, 'phase_deleted', `Phase "${phase.name}" deleted`);
        }
        dbState.resourceCosts = dbState.resourceCosts.filter(rc => rc.phase_id !== id);
        dbState.toolCosts = dbState.toolCosts.filter(tc => tc.phase_id !== id);
        dbState.vendorCosts = dbState.vendorCosts.filter(vc => vc.phase_id !== id);
        dbState.phases = dbState.phases.filter(p => p.id !== id);
        saveState();
      },

      getResourceCosts: (phaseId) => {
        return dbState.resourceCosts.filter(rc => rc.phase_id === phaseId).map(rc => {
          const role = dbState.roles.find(r => r.id === rc.role_id);
          const days = rc.days || (rc.hours ? rc.hours / 5 : 0);
          const effectiveDailyRate = rc.daily_rate_override || role?.daily_rate || (role?.hourly_rate ? role.hourly_rate * 5 : 0);
          return { ...rc, days, role_name: role?.name || 'Unknown', default_daily_rate: role?.daily_rate, effective_daily_rate: effectiveDailyRate, total: days * effectiveDailyRate };
        });
      },
      addResourceCost: (phaseId, roleId, days, dailyRateOverride, notes) => {
        const id = generateId('rc');
        dbState.resourceCosts.push({ id, phase_id: phaseId, role_id: roleId, days, daily_rate_override: dailyRateOverride, notes });
        saveState();
        return id;
      },
      updateResourceCost: (id, days, dailyRateOverride, notes) => {
        const idx = dbState.resourceCosts.findIndex(rc => rc.id === id);
        if (idx !== -1) {
          dbState.resourceCosts[idx] = { ...dbState.resourceCosts[idx], days, daily_rate_override: dailyRateOverride, notes };
          saveState();
        }
      },
      deleteResourceCost: (id) => {
        dbState.resourceCosts = dbState.resourceCosts.filter(rc => rc.id !== id);
        saveState();
      },

      getToolCosts: (phaseId) => {
        return dbState.toolCosts.filter(tc => tc.phase_id === phaseId).map(tc => ({ ...tc, total: tc.cost * tc.quantity }));
      },
      addToolCost: (phaseId, data) => {
        const id = generateId('tc');
        dbState.toolCosts.push({ id, phase_id: phaseId, ...data, quantity: data.quantity || 1 });
        saveState();
        return id;
      },
      updateToolCost: (id, data) => {
        const idx = dbState.toolCosts.findIndex(tc => tc.id === id);
        if (idx !== -1) {
          dbState.toolCosts[idx] = { ...dbState.toolCosts[idx], ...data };
          saveState();
        }
      },
      deleteToolCost: (id) => {
        dbState.toolCosts = dbState.toolCosts.filter(tc => tc.id !== id);
        saveState();
      },

      getVendorCosts: (phaseId) => dbState.vendorCosts.filter(vc => vc.phase_id === phaseId),
      addVendorCost: (phaseId, data) => {
        const id = generateId('vc');
        dbState.vendorCosts.push({ id, phase_id: phaseId, ...data });
        saveState();
        return id;
      },
      updateVendorCost: (id, data) => {
        const idx = dbState.vendorCosts.findIndex(vc => vc.id === id);
        if (idx !== -1) {
          dbState.vendorCosts[idx] = { ...dbState.vendorCosts[idx], ...data };
          saveState();
        }
      },
      deleteVendorCost: (id) => {
        dbState.vendorCosts = dbState.vendorCosts.filter(vc => vc.id !== id);
        saveState();
      },

      // BOQ Items CRUD
      getBoqItems: (projectId) => {
        return (dbState.boqItems || []).filter(b => b.project_id === projectId).sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
      },
      addBoqItem: (projectId, phaseId, data) => {
        const id = generateId('boq');
        const existing = (dbState.boqItems || []).filter(b => b.project_id === projectId);
        const item = {
          id, project_id: projectId, phase_id: phaseId || null,
          name: data.name || '',
          category: data.category || 'internal',
          quantity: data.quantity || 1,
          unit_type: data.unit_type || 'days',
          unit_price: data.unit_price || 0,
          margin_percent: data.margin_percent !== undefined ? data.margin_percent : null,
          resource_ids: data.resource_ids || [],
          sort_order: existing.length,
          created_at: new Date().toISOString()
        };
        if (!dbState.boqItems) dbState.boqItems = [];
        dbState.boqItems.push(item);
        addVersionHistory(projectId, 'boq_added', `BOQ item "${data.name}" added`);
        saveState();
        return id;
      },
      updateBoqItem: (id, data) => {
        const idx = (dbState.boqItems || []).findIndex(b => b.id === id);
        if (idx !== -1) {
          dbState.boqItems[idx] = { ...dbState.boqItems[idx], ...data, updated_at: new Date().toISOString() };
          saveState();
        }
      },
      deleteBoqItem: (id) => {
        const item = (dbState.boqItems || []).find(b => b.id === id);
        if (item) {
          addVersionHistory(item.project_id, 'boq_deleted', `BOQ item "${item.name}" removed`);
        }
        dbState.boqItems = (dbState.boqItems || []).filter(b => b.id !== id);
        saveState();
      },

      // Calculate BOQ item total with margin
      calcBoqItemTotal: (item, projectMargin, phaseMargin) => {
        const baseTotal = (item.quantity || 0) * (item.unit_price || 0);
        const margin = item.margin_percent !== null && item.margin_percent !== undefined
          ? item.margin_percent
          : (phaseMargin !== null && phaseMargin !== undefined ? phaseMargin : (projectMargin || 0));
        return { baseTotal, margin, total: baseTotal * (1 + margin / 100) };
      },

      // --- Project Status State Machine ---
      isEditable: (project) => {
        return !project || project.status === 'draft' || !project.status;
      },
      submitForApproval: (projectId) => {
        const project = db.getProject(projectId);
        if (project && (project.status === 'draft' || !project.status)) {
          db.updateProject(projectId, { status: 'pending_approval' });
          addVersionHistory(projectId, 'status_change', 'Project submitted for approval');
        }
      },
      approveProject: (projectId) => {
        const project = db.getProject(projectId);
        if (project && project.status === 'pending_approval') {
          db.updateProject(projectId, { status: 'approved' });
          addVersionHistory(projectId, 'status_change', 'Project approved');
        }
      },
      revertToDraft: (projectId) => {
        const project = db.getProject(projectId);
        if (project && (project.status === 'pending_approval' || project.status === 'approved')) {
          db.updateProject(projectId, { status: 'draft' });
          addVersionHistory(projectId, 'status_change', `Project reverted to draft from ${project.status}`);
        }
      },

      // --- Change Request System ---
      getChangeRequests: (projectId) => {
        return (dbState.changeRequests || []).filter(cr => cr.project_id === projectId).sort((a, b) => new Date(b.requested_at) - new Date(a.requested_at));
      },
      createChangeRequest: (projectId, fieldPath, oldValue, newValue, reason) => {
        const id = generateId('cr');
        const cr = {
          id, project_id: projectId,
          field_path: fieldPath,
          old_value: oldValue, new_value: newValue,
          reason: reason || '',
          status: 'pending',
          requested_by: 'User',
          requested_at: new Date().toISOString(),
          applied_at: null
        };
        dbState.changeRequests.push(cr);
        addVersionHistory(projectId, 'cr_created', `Change request created: ${fieldPath} (${oldValue} → ${newValue})`);
        saveState();
        return id;
      },
      applyChangeRequest: (crId) => {
        const idx = dbState.changeRequests.findIndex(cr => cr.id === crId);
        if (idx === -1) return;
        const cr = dbState.changeRequests[idx];
        cr.status = 'applied';
        cr.applied_at = new Date().toISOString();

        // Apply the change based on field_path
        const parts = cr.field_path.split('.');
        if (parts[0] === 'project') {
          const field = parts[1];
          const project = db.getProject(cr.project_id);
          if (project) {
            const val = isNaN(cr.new_value) ? cr.new_value : parseFloat(cr.new_value);
            db.updateProject(cr.project_id, { [field]: val }, false);
          }
        } else if (parts[0] === 'boqItems') {
          const itemId = parts[1];
          const field = parts[2];
          const val = isNaN(cr.new_value) ? cr.new_value : parseFloat(cr.new_value);
          db.updateBoqItem(itemId, { [field]: val });
        } else if (parts[0] === 'phase') {
          const phaseId = parts[1];
          const field = parts[2];
          const val = isNaN(cr.new_value) ? cr.new_value : parseFloat(cr.new_value);
          db.updatePhase(phaseId, { [field]: val });
        }

        addVersionHistory(cr.project_id, 'cr_applied', `Change request applied: ${cr.field_path} set to ${cr.new_value}`);
        saveState();
      },
      rejectChangeRequest: (crId) => {
        const idx = dbState.changeRequests.findIndex(cr => cr.id === crId);
        if (idx !== -1) {
          dbState.changeRequests[idx].status = 'rejected';
          addVersionHistory(dbState.changeRequests[idx].project_id, 'cr_rejected', `Change request rejected: ${dbState.changeRequests[idx].field_path}`);
          saveState();
        }
      },

      // --- Credit Definitions CRUD ---
      getCreditDefinitions: () => (dbState.creditDefinitions || []).filter(cd => cd.is_active),
      getAllCreditDefinitions: () => dbState.creditDefinitions || [],
      addCreditDefinition: (data) => {
        const id = generateId('cred');
        dbState.creditDefinitions.push({ id, ...data, is_active: true });
        saveState();
        return id;
      },
      updateCreditDefinition: (id, data) => {
        const idx = (dbState.creditDefinitions || []).findIndex(cd => cd.id === id);
        if (idx !== -1) { Object.assign(dbState.creditDefinitions[idx], data); saveState(); }
      },
      deleteCreditDefinition: (id) => {
        const idx = (dbState.creditDefinitions || []).findIndex(cd => cd.id === id);
        if (idx !== -1) { dbState.creditDefinitions[idx].is_active = false; saveState(); }
      },

      // --- Client Agreements CRUD ---
      getClientAgreements: () => dbState.clientAgreements || [],
      getClientAgreement: (id) => (dbState.clientAgreements || []).find(a => a.id === id),
      addClientAgreement: (data) => {
        const id = generateId('agmt');
        dbState.clientAgreements.push({ id, ...data, created_at: new Date().toISOString() });
        saveState();
        return id;
      },
      updateClientAgreement: (id, data) => {
        const idx = (dbState.clientAgreements || []).findIndex(a => a.id === id);
        if (idx !== -1) { Object.assign(dbState.clientAgreements[idx], data); saveState(); }
      },
      consumeCredits: (agreementId, creditDefId, amount) => {
        const agmt = (dbState.clientAgreements || []).find(a => a.id === agreementId);
        if (!agmt) return false;
        const pool = agmt.credit_pool.find(cp => cp.credit_def_id === creditDefId);
        if (!pool || pool.remaining < amount) return false;
        pool.consumed += amount;
        pool.remaining -= amount;
        saveState();
        return true;
      },

      // --- Packages CRUD ---
      getPackages: () => (dbState.packages || []).filter(p => p.is_active),
      getAllPackages: () => dbState.packages || [],
      addPackage: (data) => {
        const id = generateId('pkg');
        dbState.packages.push({ id, ...data, is_active: true });
        saveState();
        return id;
      },
      updatePackage: (id, data) => {
        const idx = (dbState.packages || []).findIndex(p => p.id === id);
        if (idx !== -1) { Object.assign(dbState.packages[idx], data); saveState(); }
      },
      applyPackageToProject: (projectId, packageId) => {
        const pkg = (dbState.packages || []).find(p => p.id === packageId);
        if (!pkg) return;
        // Auto-populate BOQ items from package services
        pkg.included_services.forEach((svc, i) => {
          const creditDef = pkg.credit_bundle[i];
          const cred = creditDef ? (dbState.creditDefinitions || []).find(cd => cd.id === creditDef.credit_def_id) : null;
          db.addBoqItem(projectId, null, {
            name: svc.service_name,
            category: 'internal',
            quantity: svc.credit_allocation,
            unit_type: cred?.unit_label || 'credits',
            unit_price: cred?.sar_value || 0,
            margin_percent: null
          });
        });
        db.updateProject(projectId, { applied_package_id: packageId });
        addVersionHistory(projectId, 'package_applied', `Package "${pkg.name}" applied`);
      },

      // --- User & Access Control ---
      getUsers: () => (dbState.users || []).filter(u => u.is_active),
      getAllUsers: () => dbState.users || [],
      getUser: (id) => (dbState.users || []).find(u => u.id === id),
      getCurrentUser: () => (dbState.users || []).find(u => u.id === dbState.currentUserId),
      setCurrentUser: (id) => { dbState.currentUserId = id; saveState(); },
      hasPermission: (permission) => {
        const user = (dbState.users || []).find(u => u.id === dbState.currentUserId);
        if (!user) return true; // If no user system, allow everything
        return user.permissions?.[permission] === true;
      },
      addUser: (data) => {
        const id = generateId('user');
        const rolePreset = ROLE_PRESETS[data.role] || ROLE_PRESETS.operator;
        dbState.users.push({
          id, ...data,
          permissions: data.permissions || { ...rolePreset.permissions },
          is_active: true,
          created_at: new Date().toISOString()
        });
        saveState();
        return id;
      },
      updateUser: (id, data) => {
        const idx = (dbState.users || []).findIndex(u => u.id === id);
        if (idx !== -1) { Object.assign(dbState.users[idx], data); saveState(); }
      },
      deactivateUser: (id) => {
        const idx = (dbState.users || []).findIndex(u => u.id === id);
        if (idx !== -1) { dbState.users[idx].is_active = false; saveState(); }
      },

      // --- Payment Schedules ---
      getPaymentSchedule: (projectId) => (dbState.paymentSchedules || []).find(ps => ps.project_id === projectId),
      createPaymentSchedule: (projectId) => {
        const existing = (dbState.paymentSchedules || []).find(ps => ps.project_id === projectId);
        if (existing) return existing.id;
        const id = generateId('ps');
        dbState.paymentSchedules.push({ id, project_id: projectId, payments: [], created_at: new Date().toISOString() });
        saveState();
        return id;
      },
      addPayment: (projectId, payment) => {
        let schedule = (dbState.paymentSchedules || []).find(ps => ps.project_id === projectId);
        if (!schedule) {
          db.createPaymentSchedule(projectId);
          schedule = (dbState.paymentSchedules || []).find(ps => ps.project_id === projectId);
        }
        const paymentId = generateId('pay');
        schedule.payments.push({ id: paymentId, ...payment, status: payment.status || 'pending' });
        saveState();
        return paymentId;
      },
      updatePayment: (projectId, paymentId, data) => {
        const schedule = (dbState.paymentSchedules || []).find(ps => ps.project_id === projectId);
        if (schedule) {
          const idx = schedule.payments.findIndex(p => p.id === paymentId);
          if (idx !== -1) { Object.assign(schedule.payments[idx], data); saveState(); }
        }
      },
      deletePayment: (projectId, paymentId) => {
        const schedule = (dbState.paymentSchedules || []).find(ps => ps.project_id === projectId);
        if (schedule) {
          schedule.payments = schedule.payments.filter(p => p.id !== paymentId);
          saveState();
        }
      },

      calculateProjectTotals: (projectId) => {
        const phases = db.getPhases(projectId);
        const project = db.getProject(projectId);
        let totalResourceCost = 0, totalToolCost = 0, totalVendorCost = 0, totalDays = 0;

        phases.forEach(phase => {
          const resources = db.getResourceCosts(phase.id);
          const tools = db.getToolCosts(phase.id);
          const vendors = db.getVendorCosts(phase.id);
          totalResourceCost += resources.reduce((sum, r) => sum + r.total, 0);
          totalToolCost += tools.reduce((sum, t) => sum + t.total, 0);
          totalVendorCost += vendors.reduce((sum, v) => sum + v.cost, 0);
          totalDays += resources.reduce((sum, r) => sum + (r.days || 0), 0);
        });

        // BOQ totals
        const boqItems = db.getBoqItems(projectId);
        let totalBoqValue = 0;
        boqItems.forEach(item => {
          const phase = phases.find(p => p.id === item.phase_id);
          const { total } = db.calcBoqItemTotal(item, project?.target_margin || 0, phase?.margin_percent);
          totalBoqValue += total;
        });

        // SaaS recurring revenue
        const saasMonthly = project?.saas_monthly_price || 0;
        const saasYearly = project?.saas_yearly_price || 0;
        const saasAnnualRevenue = saasYearly || (saasMonthly * 12);

        // Setup fees
        const setupFee = project?.setup_fee || 0;

        // API hits revenue
        const apiBasePrices = getApiBasePrices();
        const apiType = project?.api_type || '';
        const apiBasePrice = apiType ? (apiBasePrices[apiType] || 0) : 0;
        const apiMarkup = project?.api_markup || 0;
        const apiPricePerHit = apiBasePrice + apiMarkup;
        const apiExpectedHits = project?.api_expected_hits || 0;
        const apiMonthlyRevenue = apiPricePerHit * apiExpectedHits;
        const apiAnnualRevenue = apiMonthlyRevenue * 12;

        // Product fees
        const productFees = getProductFees();
        const selectedProducts = project?.selected_products || [];
        let productSetupTotal = 0;
        let productLicenseAnnual = 0;
        selectedProducts.forEach(sp => {
          const fees = productFees[sp.id] || {};
          productSetupTotal += fees.setup || 0;
          if (sp.billing_cycle === 'weekly') productLicenseAnnual += (fees.weekly || 0) * 52;
          else if (sp.billing_cycle === 'monthly') productLicenseAnnual += (fees.monthly || 0) * 12;
          else if (sp.billing_cycle === 'yearly') productLicenseAnnual += fees.yearly || 0;
        });
        const productTotalAnnual = productSetupTotal + productLicenseAnnual;

        // Total hourly-based cost
        const totalHourlyCost = totalResourceCost + totalToolCost + totalVendorCost;

        // Risk margin (extra buffer)
        const riskMarginPercent = project?.risk_margin || 0;
        const riskMarginAmount = totalHourlyCost * (riskMarginPercent / 100);

        // Target margin and selling price calculation
        const targetMargin = project?.target_margin || 30;
        const costWithRisk = totalHourlyCost + riskMarginAmount;
        const hourlySellingPrice = costWithRisk > 0 ? costWithRisk / (1 - targetMargin / 100) : 0;

        // Total before discount
        const subtotal = hourlySellingPrice + setupFee + saasAnnualRevenue + apiAnnualRevenue + productTotalAnnual;

        // Discount calculation
        const discountPercent = project?.discount_percent || 0;
        const discountAmount = project?.discount_amount || (subtotal * (discountPercent / 100));

        // Final selling price
        const sellingPrice = subtotal - discountAmount;
        const totalCost = totalHourlyCost;
        const grossProfit = sellingPrice - totalCost - riskMarginAmount;
        const actualMargin = sellingPrice > 0 ? (grossProfit / sellingPrice) * 100 : 0;

        return {
          totalResourceCost, totalToolCost, totalVendorCost, totalHourlyCost, totalDays,
          hourlySellingPrice,
          saasMonthly, saasYearly, saasAnnualRevenue,
          setupFee,
          apiType, apiBasePrice, apiMarkup, apiPricePerHit, apiExpectedHits, apiMonthlyRevenue, apiAnnualRevenue,
          selectedProducts, productSetupTotal, productLicenseAnnual, productTotalAnnual,
          riskMarginPercent, riskMarginAmount,
          discountPercent, discountAmount, subtotal,
          totalCost, sellingPrice, grossProfit, targetMargin, actualMargin,
          totalBoqValue, boqItemCount: boqItems.length,
          pricingModels: project?.pricing_models || ['hourly']
        };
      }
    };

    // Product List
    const PRODUCT_LIST = [
      { id: 'salis', name: 'Salis', description: 'Sales Management Platform' },
      { id: 'wafir', name: 'Wafir', description: 'Financial Optimization Tool' },
      { id: 'hackify', name: 'Hackify', description: 'Development Platform' },
      { id: 'connect_ai', name: 'Connect AI', description: 'AI Integration Suite' },
      { id: 'riyali', name: 'Riyali', description: 'Financial Analytics' }
    ];

    // API List
    const API_LIST = [
      { id: 'wathq', name: 'Wathq', description: 'Commercial Registration API' },
      { id: 'spl', name: 'SPL', description: 'Saudi Post Logistics API' },
      { id: 'moj', name: 'MOJ', description: 'Ministry of Justice API' },
      { id: 'gosi', name: 'GOSI', description: 'General Organization for Social Insurance API' }
    ];

    // Get settings from localStorage
    const getProductFees = () => {
      const saved = localStorage.getItem('boud_product_fees');
      if (saved) return JSON.parse(saved);
      return { salis: { setup: 0, weekly: 0, monthly: 0, yearly: 0 }, wafir: { setup: 0, weekly: 0, monthly: 0, yearly: 0 }, hackify: { setup: 0, weekly: 0, monthly: 0, yearly: 0 }, connect_ai: { setup: 0, weekly: 0, monthly: 0, yearly: 0 }, riyali: { setup: 0, weekly: 0, monthly: 0, yearly: 0 } };
    };

    const getApiBasePrices = () => {
      const saved = localStorage.getItem('boud_api_base_prices');
      if (saved) return JSON.parse(saved);
      return { wathq: 0, spl: 0, moj: 0, gosi: 0 };
    };

    // Theme management
    const getTheme = () => localStorage.getItem('boud_theme') || 'light';
    const setTheme = (theme) => {
      localStorage.setItem('boud_theme', theme);
      document.documentElement.setAttribute('data-theme', theme);
    };

    // Auth state
    const isLoggedIn = () => localStorage.getItem('boud_logged_in') === 'true';
    const setLoggedIn = (val) => localStorage.setItem('boud_logged_in', val ? 'true' : 'false');

    // Format currency
    const formatCurrency = (amount) => new Intl.NumberFormat('en-SA', { style: 'currency', currency: 'SAR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount || 0);

    // Export Proposal to printable view
    const handleExportProposal = (project, phases, totals, vatRate) => {
      const priceWithVat = totals.sellingPrice * (1 + vatRate / 100);
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Proposal - ${project.name}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 40px; color: #231F20; line-height: 1.6; }
            .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; padding-bottom: 24px; border-bottom: 3px solid #def763; }
            .logo { font-size: 28px; font-weight: 700; color: #231F20; }
            .logo span { color: #5e56de; }
            .doc-info { text-align: right; }
            .doc-info h1 { font-size: 24px; color: #231F20; margin-bottom: 8px; }
            .doc-info p { color: #666; font-size: 14px; }
            .section { margin-bottom: 32px; }
            .section h2 { font-size: 18px; color: #5e56de; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
            .project-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .detail-item { padding: 12px; background: #f9f9f9; border-radius: 8px; }
            .detail-item .label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
            .detail-item .value { font-size: 16px; font-weight: 600; color: #231F20; margin-top: 4px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
            th { text-align: left; padding: 12px; background: #f4f4f4; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; border-bottom: 2px solid #ddd; }
            td { padding: 12px; border-bottom: 1px solid #eee; }
            .phase-name { font-weight: 600; color: #5e56de; background: #f9f9ff; }
            .subtotal { font-weight: 600; background: #f9f9f9; }
            .pricing-summary { background: #231F20; color: white; padding: 24px; border-radius: 12px; margin-top: 32px; }
            .pricing-summary h2 { color: #def763; border-bottom-color: rgba(255,255,255,0.2); }
            .pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px; }
            .pricing-item { text-align: center; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 8px; }
            .pricing-item .label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; }
            .pricing-item .value { font-size: 20px; font-weight: 700; margin-top: 4px; }
            .pricing-item .value.highlight { color: #def763; }
            .pricing-item .value.success { color: #4ADE80; }
            .pricing-item .value.orange { color: #e46a17; }
            .footer { margin-top: 48px; padding-top: 24px; border-top: 1px solid #eee; text-align: center; color: #999; font-size: 12px; }
            @media print { body { padding: 20px; } .pricing-summary { break-inside: avoid; } }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="logo">B<span>OUD</span></div>
            <div class="doc-info">
              <h1>Project Proposal</h1>
              <p>Generated: ${new Date().toLocaleDateString('en-SA', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>
          </div>

          <div class="section">
            <h2>Project Details</h2>
            <div class="project-details">
              <div class="detail-item"><div class="label">Project Name</div><div class="value">${project.name}</div></div>
              <div class="detail-item"><div class="label">Client</div><div class="value">${project.client || 'N/A'}</div></div>
              <div class="detail-item"><div class="label">Duration</div><div class="value">${project.duration_weeks ? project.duration_weeks + ' weeks' : 'N/A'}</div></div>
              <div class="detail-item"><div class="label">Target Margin</div><div class="value">${project.target_margin || 30}%</div></div>
            </div>
          </div>

          <div class="section">
            <h2>Cost Breakdown</h2>
            <table>
              <thead><tr><th>Item</th><th>Details</th><th style="text-align:right">Amount</th></tr></thead>
              <tbody>
                ${phases.map(phase => `
                  <tr class="phase-name"><td colspan="3">${phase.name}${phase.margin_percent != null ? ` (${phase.margin_percent}% margin)` : ''}</td></tr>
                  ${phase.resources.map(r => `<tr><td style="padding-left:24px">${r.role_name}</td><td>${r.days} days @ SAR ${r.effective_daily_rate?.toLocaleString()}/day</td><td style="text-align:right">SAR ${r.total.toLocaleString()}</td></tr>`).join('')}
                  ${phase.tools.map(t => `<tr><td style="padding-left:24px">${t.tool_name}</td><td>${t.cost_type === 'monthly' ? 'Monthly' : t.cost_type === 'yearly' ? 'Yearly' : 'One-time'}</td><td style="text-align:right">SAR ${t.total.toLocaleString()}</td></tr>`).join('')}
                  ${phase.vendors.map(v => `<tr><td style="padding-left:24px">${v.vendor_name}</td><td>${v.description || 'Vendor'}</td><td style="text-align:right">SAR ${v.cost.toLocaleString()}</td></tr>`).join('')}
                `).join('')}
                <tr class="subtotal"><td colspan="2">Total Cost</td><td style="text-align:right">SAR ${totals.totalCost.toLocaleString()}</td></tr>
              </tbody>
            </table>
          </div>

          ${(() => {
            const boqItems = db.getBoqItems(project.id);
            if (boqItems.length === 0) return '';
            const categories = {internal: 'Internal', external: 'External', tools: 'Tools', other: 'Other'};
            return `
            <div class="section">
              <h2>Bill of Quantities (BOQ)</h2>
              <table>
                <thead><tr><th>#</th><th>Item</th><th>Category</th><th>Qty</th><th>Unit</th><th>Unit Price</th><th>Margin%</th><th style="text-align:right">Total</th></tr></thead>
                <tbody>
                  ${boqItems.map((item, i) => {
                    const phase = dbState.phases.find(p => p.id === item.phase_id);
                    const calc = db.calcBoqItemTotal(item, project.target_margin || 0, phase?.margin_percent);
                    return `<tr><td>${i+1}</td><td>${item.name}</td><td>${categories[item.category] || item.category}</td><td>${item.quantity}</td><td>${item.unit_type || '-'}</td><td>SAR ${(item.unit_price || 0).toLocaleString()}</td><td>${calc.margin}%</td><td style="text-align:right">SAR ${Math.round(calc.total).toLocaleString()}</td></tr>`;
                  }).join('')}
                  <tr class="subtotal"><td colspan="7">BOQ Total</td><td style="text-align:right">SAR ${Math.round(totals.totalBoqValue).toLocaleString()}</td></tr>
                </tbody>
              </table>
            </div>`;
          })()}

          <div class="pricing-summary">
            <h2>Pricing Summary</h2>
            <div class="pricing-grid">
              <div class="pricing-item"><div class="label">Total Cost</div><div class="value">SAR ${totals.totalCost.toLocaleString()}</div></div>
              ${totals.riskMarginPercent > 0 ? `<div class="pricing-item"><div class="label">Risk Buffer (${totals.riskMarginPercent}%)</div><div class="value orange">SAR ${totals.riskMarginAmount.toLocaleString()}</div></div>` : ''}
              <div class="pricing-item"><div class="label">Subtotal</div><div class="value">SAR ${totals.subtotal.toLocaleString()}</div></div>
              ${totals.discountPercent > 0 ? `<div class="pricing-item"><div class="label">Discount (${totals.discountPercent}%)</div><div class="value orange">-SAR ${totals.discountAmount.toLocaleString()}</div></div>` : ''}
              <div class="pricing-item"><div class="label">Selling Price</div><div class="value highlight">SAR ${totals.sellingPrice.toLocaleString()}</div></div>
              <div class="pricing-item"><div class="label">With VAT (${vatRate}%)</div><div class="value">SAR ${Math.round(priceWithVat).toLocaleString()}</div></div>
              <div class="pricing-item"><div class="label">Profit Margin</div><div class="value success">${totals.actualMargin.toFixed(1)}%</div></div>
            </div>
          </div>

          <div class="footer">
            <p>This proposal was generated by Boud Pricing Engine</p>
            <p>Valid for 30 days from the date of issue</p>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 250);
    };

    // Export Proposal to CSV
    const handleExportCSV = (project, phases, totals, vatRate) => {
      const priceWithVat = totals.sellingPrice * (1 + vatRate / 100);
      const rows = [];

      // Header info
      rows.push(['BOUD PRICING ENGINE - PROJECT PROPOSAL']);
      rows.push(['Generated', new Date().toLocaleDateString('en-SA', { year: 'numeric', month: 'long', day: 'numeric' })]);
      rows.push([]);

      // Project details
      rows.push(['PROJECT DETAILS']);
      rows.push(['Project Name', project.name]);
      rows.push(['Client', project.client || 'N/A']);
      rows.push(['Duration', project.duration_weeks ? project.duration_weeks + ' weeks' : 'N/A']);
      rows.push(['Target Margin', (project.target_margin || 30) + '%']);
      rows.push([]);

      // Cost breakdown
      rows.push(['COST BREAKDOWN']);
      rows.push(['Phase', 'Item', 'Type', 'Details', 'Amount (SAR)']);

      phases.forEach(phase => {
        phase.resources.forEach(r => {
          rows.push([phase.name, r.role_name, 'Resource', r.days + ' days @ ' + (r.effective_daily_rate || 0) + '/day', r.total]);
        });
        phase.tools.forEach(t => {
          rows.push([phase.name, t.tool_name, 'Tool', t.cost_type === 'monthly' ? 'Monthly' : t.cost_type === 'yearly' ? 'Yearly' : 'One-time', t.total]);
        });
        phase.vendors.forEach(v => {
          rows.push([phase.name, v.vendor_name, 'Vendor', v.description || '', v.cost]);
        });
      });

      // BOQ items
      const boqItems = db.getBoqItems(project.id);
      if (boqItems.length > 0) {
        rows.push([]);
        rows.push(['BILL OF QUANTITIES']);
        rows.push(['Item', 'Category', 'Qty', 'Unit', 'Unit Price', 'Margin%', 'Total']);
        boqItems.forEach(item => {
          const phase = dbState.phases.find(p => p.id === item.phase_id);
          const calc = db.calcBoqItemTotal(item, project.target_margin || 0, phase?.margin_percent);
          rows.push([item.name, item.category, item.quantity, item.unit_type || '-', item.unit_price, calc.margin + '%', Math.round(calc.total)]);
        });
        rows.push(['BOQ Total', '', '', '', '', '', Math.round(totals.totalBoqValue)]);
      }

      rows.push([]);

      // Pricing summary
      rows.push(['PRICING SUMMARY']);
      rows.push(['Total Cost', '', '', '', totals.totalCost]);
      if (totals.riskMarginPercent > 0) {
        rows.push(['Risk Buffer (' + totals.riskMarginPercent + '%)', '', '', '', totals.riskMarginAmount]);
      }
      rows.push(['Subtotal', '', '', '', totals.subtotal]);
      if (totals.discountPercent > 0) {
        rows.push(['Discount (' + totals.discountPercent + '%)', '', '', '', -totals.discountAmount]);
      }
      rows.push(['Selling Price', '', '', '', totals.sellingPrice]);
      rows.push(['With VAT (' + vatRate + '%)', '', '', '', Math.round(priceWithVat)]);
      rows.push(['Profit Margin', '', '', '', totals.actualMargin.toFixed(1) + '%']);

      // Convert to CSV
      const csvContent = rows.map(row => row.map(cell => {
        const cellStr = String(cell === undefined || cell === null ? '' : cell);
        return cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')
          ? '"' + cellStr.replace(/"/g, '""') + '"'
          : cellStr;
      }).join(',')).join('\n');

      // Download
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = project.name.replace(/[^a-z0-9]/gi, '_') + '_proposal.csv';
      link.click();
    };

    // Boud Logo Component (SVG based on brand guidelines - curved B shape)
    const BoudLogo = ({ size = 36, showText = true }) => (
      <div style={{display: 'flex', alignItems: 'center', gap: 12}}>
        <svg width={size} height={size} viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="100" height="100" rx="16" fill="#def763"/>
          <path d="M25 20 C25 20 25 80 25 80 C25 80 55 80 65 70 C75 60 75 50 65 45 C55 40 45 45 45 45 C45 45 60 45 65 35 C70 25 60 20 50 20 C40 20 25 20 25 20 Z" fill="#231F20"/>
          <circle cx="42" cy="35" r="8" fill="#def763"/>
          <circle cx="45" cy="60" r="10" fill="#def763"/>
        </svg>
        {showText && (
          <div>
            <div style={{fontSize: size * 0.6, fontWeight: 700, color: 'white', letterSpacing: '0.05em'}}>BOUD</div>
            <div style={{fontSize: size * 0.28, color: 'var(--boud-lime)', textTransform: 'uppercase', letterSpacing: '0.1em'}}>Pricing Engine</div>
          </div>
        )}
      </div>
    );

    // Auth Pages Component
    const AuthPage = ({ onLogin }) => {
      const [isSignUp, setIsSignUp] = React.useState(false);
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [name, setName] = React.useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        // Bypass auth - just log in
        setLoggedIn(true);
        onLogin();
      };

      return (
        <div className="auth-container">
          <div className="auth-left">
            <BoudLogo size={56} showText={true} />
            <div style={{marginTop: 48, textAlign: 'center', maxWidth: 400}}>
              <h2 style={{fontSize: 28, marginBottom: 16, color: 'white'}}>Smart Pricing for Your Projects</h2>
              <p style={{opacity: 0.9, lineHeight: 1.7}}>
                Create accurate project quotes with multiple pricing models, track margins, and close deals faster.
              </p>
            </div>
            <div style={{display: 'flex', gap: 16, marginTop: 48}}>
              <div style={{textAlign: 'center', padding: 16}}>
                <div style={{fontSize: 32, fontWeight: 700, color: 'var(--boud-lime)'}}>5</div>
                <div style={{fontSize: 13, opacity: 0.8}}>Pricing Models</div>
              </div>
              <div style={{textAlign: 'center', padding: 16}}>
                <div style={{fontSize: 32, fontWeight: 700, color: 'var(--boud-lime)'}}>∞</div>
                <div style={{fontSize: 13, opacity: 0.8}}>Projects</div>
              </div>
              <div style={{textAlign: 'center', padding: 16}}>
                <div style={{fontSize: 32, fontWeight: 700, color: 'var(--boud-lime)'}}>100%</div>
                <div style={{fontSize: 13, opacity: 0.8}}>Local Data</div>
              </div>
            </div>
          </div>
          <div className="auth-right">
            <div className="auth-form">
              <h1 className="auth-title">{isSignUp ? 'Create Account' : 'Welcome Back'}</h1>
              <p className="auth-subtitle">{isSignUp ? 'Start building your pricing engine' : 'Sign in to continue to Boud'}</p>

              <form onSubmit={handleSubmit}>
                {isSignUp && (
                  <div className="form-group">
                    <label className="form-label">Full Name</label>
                    <input type="text" className="form-input" placeholder="Enter your name" value={name} onChange={e => setName(e.target.value)} />
                  </div>
                )}
                <div className="form-group">
                  <label className="form-label">Email Address</label>
                  <input type="email" className="form-input" placeholder="name@company.com" value={email} onChange={e => setEmail(e.target.value)} />
                </div>
                <div className="form-group">
                  <label className="form-label">Password</label>
                  <input type="password" className="form-input" placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} />
                </div>
                {!isSignUp && (
                  <div style={{textAlign: 'right', marginBottom: 16}}>
                    <span className="auth-link" style={{fontSize: 13}}>Forgot password?</span>
                  </div>
                )}
                <button type="submit" className="btn btn-purple" style={{width: '100%', padding: '12px 24px', fontSize: 15}}>
                  {isSignUp ? 'Create Account' : 'Sign In'}
                </button>
              </form>

              <div className="auth-divider">or continue with</div>

              <div style={{display: 'flex', gap: 12}}>
                <button className="btn btn-secondary" style={{flex: 1}} onClick={handleSubmit}>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                  Google
                </button>
                <button className="btn btn-secondary" style={{flex: 1}} onClick={handleSubmit}>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.866-.013-1.7-2.782.604-3.369-1.341-3.369-1.341-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.071 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.163 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg>
                  GitHub
                </button>
              </div>

              <p style={{textAlign: 'center', marginTop: 24, fontSize: 14, color: 'var(--gray-text)'}}>
                {isSignUp ? 'Already have an account?' : "Don't have an account?"}{' '}
                <span className="auth-link" onClick={() => setIsSignUp(!isSignUp)}>
                  {isSignUp ? 'Sign In' : 'Sign Up'}
                </span>
              </p>

              <p style={{textAlign: 'center', marginTop: 16, fontSize: 12, color: 'var(--gray-text)'}}>
                Demo Mode: Click any button to enter the app
              </p>
            </div>
          </div>
        </div>
      );
    };

    // Sidebar Component
    const Sidebar = ({ currentView, onNavigate, theme, onToggleTheme, onOpenNotifications, notificationCount, onLogout }) => {
      const [pricingExpanded, setPricingExpanded] = React.useState(['rates', 'tools', 'api-settings', 'product-fees'].includes(currentView));

      const allNavItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
        { id: 'insights', label: 'Insights', icon: 'bar-chart-3' },
        { id: 'projects', label: 'Projects', icon: 'folder-open' },
        { id: 'credits', label: 'Credits & Packages', icon: 'coins', perm: 'manage_credits' },
        { id: 'users', label: 'Users', icon: 'users-round', perm: 'manage_users' },
        { id: 'templates', label: 'Templates', icon: 'file-stack', perm: 'manage_templates' },
      ];
      const mainNavItems = allNavItems.filter(item => !item.perm || db.hasPermission(item.perm));

      const pricingNavItems = db.hasPermission('pricing_view') ? [
        { id: 'rates', label: 'Role Rates', icon: 'users' },
        { id: 'tools', label: 'Tools & Subscriptions', icon: 'wrench' },
        { id: 'api-settings', label: 'API Pricing', icon: 'zap' },
        { id: 'product-fees', label: 'Product Fees', icon: 'package' },
      ] : [];

      React.useEffect(() => { lucide.createIcons(); }, [currentView, pricingExpanded]);

      return (
        <aside className="sidebar">
          <div className="logo">
            <BoudLogo size={36} showText={true} />
          </div>

          <div style={{display: 'flex', gap: 8, marginBottom: 16, padding: '0 8px'}}>
            <button onClick={onToggleTheme} className="btn btn-icon" style={{flex: 1, background: 'rgba(255,255,255,0.1)', color: 'white', justifyContent: 'center'}}>
              <i data-lucide={theme === 'dark' ? 'sun' : 'moon'} style={{width: 16, height: 16}}></i>
            </button>
            <button onClick={onOpenNotifications} className="btn btn-icon" style={{flex: 1, background: 'rgba(255,255,255,0.1)', color: 'white', justifyContent: 'center', position: 'relative'}}>
              <i data-lucide="bell" style={{width: 16, height: 16}}></i>
              {notificationCount > 0 && (
                <span style={{position: 'absolute', top: 4, right: 4, width: 16, height: 16, background: 'var(--error)', borderRadius: '50%', fontSize: 10, display: 'flex', alignItems: 'center', justifyContent: 'center'}}>{notificationCount}</span>
              )}
            </button>
          </div>

          <nav style={{flex: 1}}>
            <ul className="nav-menu">
              {mainNavItems.map(item => (
                <li key={item.id} className={`nav-item ${currentView === item.id ? 'active' : ''}`} onClick={() => onNavigate(item.id)}>
                  <i data-lucide={item.icon}></i>
                  <span>{item.label}</span>
                </li>
              ))}

              <li className="nav-item" onClick={() => setPricingExpanded(!pricingExpanded)} style={{marginTop: 8}}>
                <i data-lucide="calculator"></i>
                <span style={{flex: 1}}>Pricing Settings</span>
                <i data-lucide={pricingExpanded ? 'chevron-down' : 'chevron-right'} style={{width: 16, height: 16, opacity: 0.5}}></i>
              </li>
              {pricingExpanded && (
                <div style={{marginLeft: 16, borderLeft: '2px solid rgba(255,255,255,0.1)', paddingLeft: 8}}>
                  {pricingNavItems.map(item => (
                    <li key={item.id} className={`nav-item ${currentView === item.id ? 'active' : ''}`} onClick={() => onNavigate(item.id)} style={{fontSize: 13, padding: '10px 12px'}}>
                      <i data-lucide={item.icon} style={{width: 16, height: 16}}></i>
                      <span>{item.label}</span>
                    </li>
                  ))}
                </div>
              )}

              <li className={`nav-item ${currentView === 'settings' ? 'active' : ''}`} onClick={() => onNavigate('settings')} style={{marginTop: 8}}>
                <i data-lucide="settings"></i>
                <span>Settings</span>
              </li>
            </ul>
          </nav>

          <div style={{borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: 12, marginTop: 16}}>
            {(() => {
              const user = db.getCurrentUser();
              return user ? (
                <div style={{padding: '8px 12px', marginBottom: 8, display: 'flex', alignItems: 'center', gap: 8}}>
                  <div style={{width: 28, height: 28, borderRadius: '50%', background: 'var(--boud-lime)', color: 'var(--boud-dark)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 700, fontSize: 12, flexShrink: 0}}>
                    {user.name.charAt(0).toUpperCase()}
                  </div>
                  <div style={{overflow: 'hidden'}}>
                    <div style={{color: 'white', fontSize: 13, fontWeight: 600, textOverflow: 'ellipsis', overflow: 'hidden', whiteSpace: 'nowrap'}}>{user.name}</div>
                    <div style={{color: 'rgba(255,255,255,0.5)', fontSize: 11}}>{ROLE_PRESETS[user.role]?.label || user.role}</div>
                  </div>
                </div>
              ) : null;
            })()}
            <button onClick={onLogout} className="btn" style={{width: '100%', background: 'rgba(255,255,255,0.1)', color: 'white', justifyContent: 'flex-start'}}>
              <i data-lucide="log-out" style={{width: 16, height: 16}}></i>
              <span>Sign Out</span>
            </button>
          </div>
        </aside>
      );
    };

    // Templates Library Component
    const TemplatesLibrary = ({ onNavigate, onRefresh }) => {
      const [templates, setTemplates] = React.useState([]);
      const [isCreateModalOpen, setIsCreateModalOpen] = React.useState(false);

      const loadTemplates = () => {
        setTemplates(getTemplates());
        setTimeout(() => lucide.createIcons(), 0);
      };

      React.useEffect(() => { loadTemplates(); }, []);

      const handleDelete = (id) => {
        if (confirm('Delete this template?')) {
          deleteTemplate(id);
          loadTemplates();
        }
      };

      const handleUseTemplate = (template) => {
        const projectData = {
          name: `${template.name} (Copy)`,
          client: '',
          duration_weeks: template.config.duration_weeks,
          target_margin: template.config.target_margin,
          pricing_models: template.config.pricing_models,
          risk_margin: template.config.risk_margin || 0,
          saas_monthly_price: template.config.saas_monthly_price,
          saas_yearly_price: template.config.saas_yearly_price,
          setup_fee: template.config.setup_fee,
          api_type: template.config.api_type,
          api_markup: template.config.api_markup,
          api_expected_hits: template.config.api_expected_hits,
          selected_products: template.config.selected_products || []
        };
        const id = db.createProject(projectData);
        onNavigate('project-pricing', id);
      };

      return (
        <div>
          <div className="page-header">
            <div>
              <h1 className="page-title">Templates Library</h1>
              <p className="text-secondary">Reusable project configurations</p>
            </div>
            <button className="btn btn-primary" onClick={() => setIsCreateModalOpen(true)}>
              <i data-lucide="plus" style={{width: 18, height: 18}}></i> Create from Project
            </button>
          </div>

          {templates.length === 0 ? (
            <div className="card">
              <div className="empty-state">
                <i data-lucide="file-stack" style={{width: 48, height: 48, color: 'var(--gray-text)', marginBottom: 16}}></i>
                <h3>No Templates Yet</h3>
                <p style={{marginTop: 8}}>Save project configurations as templates for quick reuse.</p>
              </div>
            </div>
          ) : (
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 16}}>
              {templates.map(template => (
                <div key={template.id} className="card">
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12}}>
                    <div>
                      <h3 style={{margin: 0, fontSize: 16}}>{template.name}</h3>
                      <p className="text-secondary" style={{margin: '4px 0 0', fontSize: 13}}>{template.description || 'No description'}</p>
                    </div>
                    <span className="badge badge-purple">Template</span>
                  </div>
                  <div style={{fontSize: 13, color: 'var(--gray-text)', marginBottom: 16}}>
                    <div>Margin: {template.config.target_margin}%</div>
                    <div>Models: {template.config.pricing_models?.join(', ') || 'hourly'}</div>
                    {template.config.risk_margin > 0 && <div>Risk Buffer: {template.config.risk_margin}%</div>}
                  </div>
                  <div style={{display: 'flex', gap: 8}}>
                    <button className="btn btn-primary btn-sm" onClick={() => handleUseTemplate(template)}>Use Template</button>
                    <button className="btn btn-icon btn-sm" onClick={() => handleDelete(template.id)} style={{color: 'var(--error)'}}><i data-lucide="trash-2" style={{width: 14, height: 14}}></i></button>
                  </div>
                </div>
              ))}
            </div>
          )}

          {isCreateModalOpen && <CreateTemplateModal onClose={() => setIsCreateModalOpen(false)} onSave={() => { loadTemplates(); setIsCreateModalOpen(false); }} />}
        </div>
      );
    };

    // Create Template Modal
    const CreateTemplateModal = ({ onClose, onSave }) => {
      const [name, setName] = React.useState('');
      const [description, setDescription] = React.useState('');
      const [selectedProject, setSelectedProject] = React.useState('');
      const projects = db.getProjects();

      React.useEffect(() => { lucide.createIcons(); }, []);

      const handleSave = () => {
        if (!name || !selectedProject) return;
        const project = db.getProject(selectedProject);
        if (!project) return;

        saveTemplate({
          name,
          description,
          config: {
            duration_weeks: project.duration_weeks,
            target_margin: project.target_margin,
            pricing_models: project.pricing_models,
            risk_margin: project.risk_margin,
            saas_monthly_price: project.saas_monthly_price,
            saas_yearly_price: project.saas_yearly_price,
            setup_fee: project.setup_fee,
            api_type: project.api_type,
            api_markup: project.api_markup,
            api_expected_hits: project.api_expected_hits,
            selected_products: project.selected_products
          }
        });
        onSave();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>Create Template from Project</h3>
              <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
            </div>
            <div className="modal-body">
              <div className="form-group">
                <label className="form-label">Template Name *</label>
                <input type="text" className="form-input" value={name} onChange={e => setName(e.target.value)} placeholder="e.g., Standard SaaS Project" />
              </div>
              <div className="form-group">
                <label className="form-label">Description</label>
                <textarea className="form-textarea" rows={2} value={description} onChange={e => setDescription(e.target.value)} placeholder="Brief description of when to use this template" />
              </div>
              <div className="form-group">
                <label className="form-label">Base Project *</label>
                <select className="form-select" value={selectedProject} onChange={e => setSelectedProject(e.target.value)}>
                  <option value="">Select a project</option>
                  {projects.map(p => (
                    <option key={p.id} value={p.id}>{p.name}</option>
                  ))}
                </select>
              </div>
            </div>
            <div className="modal-footer">
              <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
              <button className="btn btn-primary" onClick={handleSave} disabled={!name || !selectedProject}>Save Template</button>
            </div>
          </div>
        </div>
      );
    };

    // Role Selector Component - Enhanced with search, department tabs, and recent roles
    const RoleSelector = ({ roles, value, onChange, formatCurrency }) => {
      const [isOpen, setIsOpen] = React.useState(false);
      const [search, setSearch] = React.useState('');
      const [activeDept, setActiveDept] = React.useState('all');
      const dropdownRef = React.useRef(null);

      const departments = ['all', 'PO', 'PM', 'BA', 'UXUI', 'FE', 'Mobile', 'BE', 'QA', 'SM', 'CMS', 'DA', 'Design'];
      const recentRoleIds = db.getRecentRoles();
      const activeRoles = roles.filter(r => r.status !== 'inactive' && r.status !== 'hidden');
      const selectedRole = roles.find(r => r.id === value);

      // Filter roles by search and department
      const filteredRoles = activeRoles.filter(r => {
        const matchesSearch = !search || r.name.toLowerCase().includes(search.toLowerCase());
        const matchesDept = activeDept === 'all' || r.department === activeDept;
        return matchesSearch && matchesDept;
      });

      // Get recent roles that exist and are active
      const recentRoles = recentRoleIds.map(id => activeRoles.find(r => r.id === id)).filter(Boolean).slice(0, 5);

      // Close dropdown when clicking outside
      React.useEffect(() => {
        const handleClickOutside = (e) => {
          if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setIsOpen(false);
        };
        if (isOpen) document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [isOpen]);

      React.useEffect(() => { if (isOpen) setTimeout(() => lucide.createIcons(), 0); }, [isOpen]);

      const handleSelect = (role) => {
        onChange(role.id);
        db.addRecentRole(role.id);
        setIsOpen(false);
        setSearch('');
      };

      return (
        <div className="role-selector" ref={dropdownRef}>
          <div className={`role-selector-trigger ${isOpen ? 'open' : ''}`} onClick={() => setIsOpen(!isOpen)}>
            {selectedRole ? (
              <span><strong>{selectedRole.name}</strong> - {formatCurrency(selectedRole.daily_rate || selectedRole.hourly_rate * 5)}/day</span>
            ) : (
              <span className="role-selector-placeholder">Select a role...</span>
            )}
            <i data-lucide={isOpen ? 'chevron-up' : 'chevron-down'} style={{width: 18, height: 18, color: 'var(--gray-text)'}}></i>
          </div>
          {isOpen && (
            <div className="role-selector-dropdown">
              <div className="role-selector-search">
                <input type="text" placeholder="Search roles..." value={search} onChange={e => setSearch(e.target.value)} autoFocus />
              </div>
              <div className="role-selector-tabs">
                {departments.map(dept => (
                  <button key={dept} className={`role-selector-tab ${activeDept === dept ? 'active' : ''}`} onClick={() => setActiveDept(dept)}>
                    {dept === 'all' ? 'All' : dept}
                  </button>
                ))}
              </div>
              <div className="role-selector-list">
                {!search && activeDept === 'all' && recentRoles.length > 0 && (
                  <div className="role-selector-section">
                    <div className="role-selector-section-title">Recent</div>
                    {recentRoles.map(role => (
                      <div key={role.id} className={`role-selector-item ${value === role.id ? 'selected' : ''}`} onClick={() => handleSelect(role)}>
                        <div>
                          <span className="role-selector-item-name">{role.name}</span>
                          <span className="role-selector-item-dept">{role.department}</span>
                        </div>
                        <span className="role-selector-item-rate">{formatCurrency(role.daily_rate || role.hourly_rate * 5)}/day</span>
                      </div>
                    ))}
                  </div>
                )}
                <div className="role-selector-section">
                  {(search || activeDept !== 'all' || recentRoles.length === 0) && <div className="role-selector-section-title">{activeDept === 'all' ? 'All Roles' : activeDept}</div>}
                  {filteredRoles.length === 0 ? (
                    <div className="role-selector-empty">No roles found</div>
                  ) : (
                    filteredRoles.map(role => (
                      <div key={role.id} className={`role-selector-item ${value === role.id ? 'selected' : ''}`} onClick={() => handleSelect(role)}>
                        <div>
                          <span className="role-selector-item-name">{role.name}</span>
                          {activeDept === 'all' && <span className="role-selector-item-dept">{role.department}</span>}
                        </div>
                        <span className="role-selector-item-rate">{formatCurrency(role.daily_rate || role.hourly_rate * 5)}/day</span>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Notification Center
    const NotificationCenter = ({ isOpen, onClose, notifications, onMarkRead, onClearAll }) => {
      React.useEffect(() => { lucide.createIcons(); }, [isOpen, notifications]);

      const getIcon = (type) => {
        switch(type) {
          case 'success': return { icon: 'check-circle', color: 'var(--success)' };
          case 'warning': return { icon: 'alert-triangle', color: 'var(--warning)' };
          case 'error': return { icon: 'alert-circle', color: 'var(--error)' };
          default: return { icon: 'info', color: 'var(--boud-purple)' };
        }
      };

      return (
        <>
          <div className={`notification-overlay ${isOpen ? 'open' : ''}`} onClick={onClose}></div>
          <div className={`notification-panel ${isOpen ? 'open' : ''}`}>
            <div style={{padding: 20, borderBottom: '1px solid var(--boud-light-gray)', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
              <h3 style={{margin: 0}}>Notifications</h3>
              <div style={{display: 'flex', gap: 8}}>
                <button className="btn btn-secondary btn-sm" onClick={onClearAll}>Clear All</button>
                <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
              </div>
            </div>
            <div>
              {notifications.length === 0 ? (
                <div style={{padding: 40, textAlign: 'center', color: 'var(--gray-text)'}}>No notifications</div>
              ) : (
                notifications.map(notif => {
                  const { icon, color } = getIcon(notif.type);
                  return (
                    <div key={notif.id} className={`notification-item ${!notif.read ? 'unread' : ''}`} onClick={() => onMarkRead(notif.id)}>
                      <div style={{display: 'flex', gap: 12}}>
                        <i data-lucide={icon} style={{width: 20, height: 20, color, flexShrink: 0}}></i>
                        <div style={{flex: 1}}>
                          <div style={{fontWeight: 500, marginBottom: 4}}>{notif.title}</div>
                          <div style={{fontSize: 13, color: 'var(--gray-text)'}}>{notif.message}</div>
                          <div style={{fontSize: 11, color: 'var(--gray-text)', marginTop: 8}}>{notif.time}</div>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>
        </>
      );
    };

    // Dashboard Component
    const Dashboard = ({ onNavigate, refreshKey }) => {
      const [stats, setStats] = React.useState({ totalProjects: 0, totalRoles: 0, totalPipelineValue: 0, totalCost: 0, totalProfit: 0, avgMargin: 0, approvedCount: 0, pendingCount: 0, draftCount: 0 });
      const [recentProjects, setRecentProjects] = React.useState([]);
      const [deptBreakdown, setDeptBreakdown] = React.useState([]);

      React.useEffect(() => {
        const projects = db.getProjects();
        let totalPipelineValue = 0, totalCost = 0, totalProfit = 0, marginSum = 0;
        let approvedCount = 0, pendingCount = 0, draftCount = 0;
        const deptCosts = {};

        const allProjectTotals = projects.map(p => {
          const totals = db.calculateProjectTotals(p.id);
          totalPipelineValue += totals.sellingPrice;
          totalCost += totals.totalCost;
          totalProfit += totals.sellingPrice - totals.totalCost;
          marginSum += totals.actualMargin;
          if (p.status === 'approved') approvedCount++;
          else if (p.status === 'pending_approval') pendingCount++;
          else draftCount++;

          // Department breakdown
          const phases = db.getPhases(p.id);
          phases.forEach(phase => {
            const resources = db.getResourceCosts(phase.id);
            resources.forEach(r => {
              const role = db.getRoles().find(rl => rl.id === r.role_id);
              const dept = role?.department || 'Other';
              deptCosts[dept] = (deptCosts[dept] || 0) + r.total;
            });
          });

          return { ...p, ...totals };
        });

        const avgMargin = projects.length > 0 ? marginSum / projects.length : 0;
        setStats({ totalProjects: projects.length, totalRoles: db.getRoles().length, totalPipelineValue, totalCost, totalProfit, avgMargin, approvedCount, pendingCount, draftCount });
        setRecentProjects(allProjectTotals.slice(0, 5));

        const deptArr = Object.entries(deptCosts).sort((a, b) => b[1] - a[1]).slice(0, 8);
        const maxDept = deptArr.length > 0 ? deptArr[0][1] : 1;
        setDeptBreakdown(deptArr.map(([name, cost]) => ({ name, cost, pct: Math.round(cost / maxDept * 100) })));

        lucide.createIcons();
      }, [refreshKey]);

      return (
        <div>
          <div className="page-header">
            <h1 className="page-title">Dashboard</h1>
            <button className="btn btn-primary" onClick={() => onNavigate('projects')}>
              <i data-lucide="plus" style={{width: 18, height: 18}}></i> New Project
            </button>
          </div>
          <div className="stats-grid">
            <div className="stat-card"><div className="stat-label">Total Projects</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{stats.totalProjects}</div><div style={{fontSize: 11, marginTop: 4, color: 'var(--text-secondary)'}}>{stats.draftCount} draft · {stats.pendingCount} pending · {stats.approvedCount} approved</div></div>
            <div className="stat-card"><div className="stat-label">Pipeline Value</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{formatCurrency(stats.totalPipelineValue)}</div></div>
            <div className="stat-card"><div className="stat-label">Total Profit</div><div className="stat-value" style={{color: stats.totalProfit >= 0 ? 'var(--success)' : 'var(--error)'}}>{formatCurrency(stats.totalProfit)}</div></div>
            <div className="stat-card"><div className="stat-label">Avg Margin</div><div className="stat-value" style={{color: stats.avgMargin >= 25 ? 'var(--success)' : stats.avgMargin >= 15 ? 'var(--warning)' : 'var(--error)'}}>{stats.avgMargin.toFixed(1)}%</div></div>
          </div>

          {/* Profitability Breakdown */}
          {stats.totalCost > 0 && (
            <div className="card" style={{marginBottom: 16, padding: 20}}>
              <h3 style={{marginBottom: 12}}>Profitability Overview</h3>
              <div style={{display: 'flex', gap: 16, alignItems: 'center', marginBottom: 16}}>
                <div style={{flex: 1}}>
                  <div style={{height: 28, borderRadius: 6, overflow: 'hidden', display: 'flex', background: 'var(--bg-secondary)'}}>
                    <div style={{width: `${Math.round(stats.totalCost / stats.totalPipelineValue * 100)}%`, background: 'var(--boud-purple)', transition: 'width 0.3s'}} title={`Cost: ${formatCurrency(stats.totalCost)}`}></div>
                    <div style={{flex: 1, background: 'var(--success)', opacity: 0.6}} title={`Profit: ${formatCurrency(stats.totalProfit)}`}></div>
                  </div>
                  <div style={{display: 'flex', justifyContent: 'space-between', marginTop: 6, fontSize: 12}}>
                    <span style={{color: 'var(--boud-purple)'}}>Cost: {formatCurrency(stats.totalCost)}</span>
                    <span style={{color: 'var(--success)'}}>Profit: {formatCurrency(stats.totalProfit)}</span>
                  </div>
                </div>
              </div>
              {/* Department cost breakdown */}
              {deptBreakdown.length > 0 && (
                <div>
                  <h4 style={{fontSize: 13, color: 'var(--text-secondary)', marginBottom: 8}}>Cost by Department</h4>
                  {deptBreakdown.map(d => (
                    <div key={d.name} style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 6}}>
                      <span style={{width: 60, fontSize: 12, textAlign: 'right', color: 'var(--text-secondary)', flexShrink: 0}}>{d.name}</span>
                      <div style={{flex: 1, height: 16, borderRadius: 4, background: 'var(--bg-secondary)', overflow: 'hidden'}}>
                        <div style={{height: '100%', width: `${d.pct}%`, background: 'var(--boud-purple)', opacity: 0.7, borderRadius: 4, transition: 'width 0.3s'}}></div>
                      </div>
                      <span style={{width: 80, fontSize: 12, fontWeight: 500, textAlign: 'right'}}>{formatCurrency(d.cost)}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
          <div className="card">
            <div className="card-header"><h2>Recent Projects</h2></div>
            {recentProjects.length === 0 ? (
              <div className="empty-state">
                <p>No projects yet. Create your first project to start pricing.</p>
                <button className="btn btn-primary" onClick={() => onNavigate('projects')} style={{ marginTop: 16 }}>Create Project</button>
              </div>
            ) : (
              <table>
                <thead><tr><th>Project</th><th>Status</th><th>Client</th><th>Cost</th><th>Price</th><th>Margin</th><th></th></tr></thead>
                <tbody>
                  {recentProjects.map(p => (
                    <tr key={p.id}>
                      <td>
                        <div style={{display: 'flex', alignItems: 'center', gap: 6}}>
                          <div style={{width: 8, height: 8, borderRadius: '50%', background: p.actualMargin >= 25 ? 'var(--success)' : p.actualMargin >= 15 ? 'var(--warning)' : 'var(--error)', flexShrink: 0}}></div>
                          <span style={{fontWeight: 500}}>{p.name}</span>
                        </div>
                      </td>
                      <td><span className={`badge ${p.status === 'approved' ? 'badge-green' : p.status === 'pending_approval' ? 'badge-yellow' : 'badge-purple'}`} style={{fontSize: 10}}>{p.status === 'approved' ? 'Approved' : p.status === 'pending_approval' ? 'Pending' : 'Draft'}</span></td>
                      <td className="text-secondary">{p.client || '-'}</td>
                      <td>{formatCurrency(p.totalCost)}</td>
                      <td style={{fontWeight: 500}}>{formatCurrency(p.sellingPrice)}</td>
                      <td><span style={{fontWeight: 600, color: p.actualMargin >= 25 ? 'var(--success)' : p.actualMargin >= 15 ? 'var(--warning)' : 'var(--error)'}}>{p.actualMargin.toFixed(1)}%</span></td>
                      <td><button className="btn btn-secondary btn-sm" onClick={() => onNavigate('project-pricing', p.id)}>Open</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </div>
      );
    };

    // Rates Management, Tools Management, Projects List, Project Pricing, Insights, Settings, API Settings, Product Fees
    // These components are included in continuation due to length...

    // [Additional components continue - Rates, Tools, Projects, Settings, etc.]
    // For brevity, I'll include the key new features and modified components

    // BOQ Table Component
    const BOQTable = ({ projectId, projectMargin, editable = true, onCreateCr }) => {
      const [items, setItems] = React.useState([]);
      const [phases, setPhases] = React.useState([]);
      const [isAddOpen, setIsAddOpen] = React.useState(false);
      const [editingId, setEditingId] = React.useState(null);
      const [form, setForm] = React.useState({ name: '', category: 'internal', quantity: '1', unit_type: 'days', unit_price: '', margin_percent: '', phase_id: '' });

      const CATEGORIES = [
        { value: 'internal', label: 'Internal' },
        { value: 'external', label: 'External' },
        { value: 'tools', label: 'Tools' },
        { value: 'other', label: 'Other' }
      ];
      const UNIT_TYPES = ['days', 'hours', 'units', 'months', 'licenses', 'fixed'];

      const loadData = () => {
        setItems(db.getBoqItems(projectId));
        setPhases(db.getPhases(projectId));
        setTimeout(() => lucide.createIcons(), 0);
      };
      React.useEffect(() => { loadData(); }, [projectId]);

      const handleSave = () => {
        const data = {
          name: form.name,
          category: form.category,
          quantity: parseFloat(form.quantity) || 1,
          unit_type: form.unit_type,
          unit_price: parseFloat(form.unit_price) || 0,
          margin_percent: form.margin_percent !== '' ? parseFloat(form.margin_percent) : null,
        };
        if (editingId) {
          db.updateBoqItem(editingId, data);
        } else {
          db.addBoqItem(projectId, form.phase_id || null, data);
        }
        setIsAddOpen(false);
        setEditingId(null);
        setForm({ name: '', category: 'internal', quantity: '1', unit_type: 'days', unit_price: '', margin_percent: '', phase_id: '' });
        loadData();
      };

      const handleEdit = (item) => {
        setEditingId(item.id);
        setForm({
          name: item.name, category: item.category, quantity: item.quantity.toString(),
          unit_type: item.unit_type, unit_price: item.unit_price.toString(),
          margin_percent: item.margin_percent !== null && item.margin_percent !== undefined ? item.margin_percent.toString() : '',
          phase_id: item.phase_id || ''
        });
        setIsAddOpen(true);
      };

      const handleDelete = (id) => {
        if (confirm('Remove this BOQ item?')) {
          db.deleteBoqItem(id);
          loadData();
        }
      };

      const getMarginColor = (margin) => {
        if (margin >= 30) return 'var(--success)';
        if (margin >= 10) return 'var(--warning)';
        if (margin >= 0) return 'var(--boud-orange)';
        return 'var(--error)';
      };

      const getCategoryBadge = (cat) => {
        const styles = {
          internal: { bg: 'rgba(94, 86, 222, 0.15)', color: 'var(--boud-purple)' },
          external: { bg: 'rgba(228, 106, 23, 0.15)', color: 'var(--boud-orange)' },
          tools: { bg: 'rgba(222, 247, 99, 0.3)', color: '#6B7A1A' },
          other: { bg: 'rgba(156, 163, 175, 0.2)', color: '#6b7280' }
        };
        const s = styles[cat] || styles.other;
        return <span className="badge" style={{background: s.bg, color: s.color}}>{cat}</span>;
      };

      // Calculate totals by category
      let grandTotal = 0;
      const catTotals = { internal: 0, external: 0, tools: 0, other: 0 };
      items.forEach(item => {
        const phase = phases.find(p => p.id === item.phase_id);
        const { total, margin } = db.calcBoqItemTotal(item, projectMargin, phase?.margin_percent);
        grandTotal += total;
        catTotals[item.category] = (catTotals[item.category] || 0) + total;
      });

      return (
        <div>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16}}>
            <div>
              <h3 style={{margin: 0}}>Bill of Quantities</h3>
              <p className="text-secondary" style={{fontSize: 13, margin: '4px 0 0'}}>{items.length} items — Total: {formatCurrency(grandTotal)}</p>
            </div>
            {editable && (
              <button className="btn btn-primary btn-sm" onClick={() => { setEditingId(null); setForm({ name: '', category: 'internal', quantity: '1', unit_type: 'days', unit_price: '', margin_percent: '', phase_id: '' }); setIsAddOpen(true); }}>
                <i data-lucide="plus" style={{width: 14, height: 14}}></i> Add Item
              </button>
            )}
          </div>

          {/* Category summary chips */}
          {items.length > 0 && (
            <div style={{display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap'}}>
              {Object.entries(catTotals).filter(([,v]) => v > 0).map(([cat, total]) => (
                <div key={cat} style={{padding: '6px 12px', borderRadius: 8, fontSize: 13, fontWeight: 500, background: cat === 'internal' ? 'rgba(94,86,222,0.1)' : cat === 'external' ? 'rgba(228,106,23,0.1)' : cat === 'tools' ? 'rgba(222,247,99,0.2)' : 'rgba(156,163,175,0.1)'}}>
                  {cat.charAt(0).toUpperCase() + cat.slice(1)}: {formatCurrency(total)}
                </div>
              ))}
            </div>
          )}

          {items.length === 0 ? (
            <div style={{textAlign: 'center', padding: 32, color: 'var(--gray-text)'}}>
              <i data-lucide="clipboard-list" style={{width: 40, height: 40, marginBottom: 12}}></i>
              <p>No BOQ items yet. Add items to build your Bill of Quantities.</p>
            </div>
          ) : (
            <div style={{overflowX: 'auto'}}>
              <table>
                <thead>
                  <tr>
                    <th style={{width: 40}}>#</th>
                    <th>Item / Deliverable</th>
                    <th>Category</th>
                    <th>Phase</th>
                    <th style={{textAlign: 'right'}}>Qty</th>
                    <th>Unit</th>
                    <th style={{textAlign: 'right'}}>Unit Price</th>
                    <th style={{textAlign: 'right'}}>Margin %</th>
                    <th style={{textAlign: 'right'}}>Total</th>
                    <th style={{width: 60}}></th>
                  </tr>
                </thead>
                <tbody>
                  {items.map((item, idx) => {
                    const phase = phases.find(p => p.id === item.phase_id);
                    const { baseTotal, margin, total } = db.calcBoqItemTotal(item, projectMargin, phase?.margin_percent);
                    return (
                      <tr key={item.id}>
                        <td style={{color: 'var(--gray-text)'}}>{idx + 1}</td>
                        <td style={{fontWeight: 500}}>{item.name}</td>
                        <td>{getCategoryBadge(item.category)}</td>
                        <td className="text-secondary" style={{fontSize: 13}}>{phase?.name || '—'}</td>
                        <td style={{textAlign: 'right'}}>{item.quantity}</td>
                        <td className="text-secondary">{item.unit_type}</td>
                        <td style={{textAlign: 'right'}}>{formatCurrency(item.unit_price)}</td>
                        <td style={{textAlign: 'right'}}>
                          <span style={{color: getMarginColor(margin), fontWeight: 500}}>{margin.toFixed(1)}%</span>
                          {item.margin_percent !== null && item.margin_percent !== undefined && (
                            <span style={{fontSize: 10, marginLeft: 4, color: 'var(--boud-purple)'}}>*</span>
                          )}
                        </td>
                        <td style={{textAlign: 'right', fontWeight: 600}}>{formatCurrency(total)}</td>
                        <td>
                          {editable ? (
                            <div className="actions">
                              <button className="btn btn-icon btn-sm" onClick={() => handleEdit(item)} title="Edit"><i data-lucide="edit-2" style={{width: 14, height: 14}}></i></button>
                              <button className="btn btn-icon btn-sm" onClick={() => handleDelete(item.id)} style={{color: 'var(--error)'}} title="Delete"><i data-lucide="trash-2" style={{width: 14, height: 14}}></i></button>
                            </div>
                          ) : onCreateCr ? (
                            <button className="btn btn-icon btn-sm" onClick={() => onCreateCr(`boqItems.${item.id}.unit_price`, item.unit_price, `${item.name} unit price`)} title="Request Change" style={{color: 'var(--warning)'}}>
                              <i data-lucide="git-pull-request" style={{width: 14, height: 14}}></i>
                            </button>
                          ) : null}
                        </td>
                      </tr>
                    );
                  })}
                  <tr style={{fontWeight: 600, background: 'var(--boud-light-gray)'}}>
                    <td colSpan={8} style={{textAlign: 'right'}}>Grand Total</td>
                    <td style={{textAlign: 'right', color: 'var(--boud-purple)', fontSize: 16}}>{formatCurrency(grandTotal)}</td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
            </div>
          )}

          {/* Add/Edit BOQ Item Modal */}
          {isAddOpen && (
            <div className="modal-overlay" onClick={() => setIsAddOpen(false)}>
              <div className="modal" style={{maxWidth: 550}} onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                  <h3>{editingId ? 'Edit BOQ Item' : 'Add BOQ Item'}</h3>
                  <button className="btn btn-icon" onClick={() => setIsAddOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
                </div>
                <div className="modal-body">
                  <div className="form-group">
                    <label className="form-label">Item / Deliverable Name *</label>
                    <input type="text" className="form-input" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="e.g., UX Research, API Development" />
                  </div>
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">Category</label>
                      <select className="form-select" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                        {CATEGORIES.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}
                      </select>
                    </div>
                    <div className="form-group">
                      <label className="form-label">Phase (optional)</label>
                      <select className="form-select" value={form.phase_id} onChange={e => setForm({...form, phase_id: e.target.value})}>
                        <option value="">No phase</option>
                        {phases.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                      </select>
                    </div>
                  </div>
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">Quantity</label>
                      <input type="number" className="form-input" value={form.quantity} onChange={e => setForm({...form, quantity: e.target.value})} min="0" step="0.5" />
                    </div>
                    <div className="form-group">
                      <label className="form-label">Unit Type</label>
                      <select className="form-select" value={form.unit_type} onChange={e => setForm({...form, unit_type: e.target.value})}>
                        {UNIT_TYPES.map(u => <option key={u} value={u}>{u}</option>)}
                      </select>
                    </div>
                  </div>
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">Unit Price (SAR)</label>
                      <input type="number" className="form-input" value={form.unit_price} onChange={e => setForm({...form, unit_price: e.target.value})} min="0" step="0.01" />
                    </div>
                    <div className="form-group">
                      <label className="form-label">Margin % Override <span style={{fontSize: 11, color: 'var(--gray-text)'}}>(blank = inherit)</span></label>
                      <input type="number" className="form-input" value={form.margin_percent} onChange={e => setForm({...form, margin_percent: e.target.value})} placeholder="Inherit from project" step="1" />
                    </div>
                  </div>
                </div>
                <div className="modal-footer">
                  <button className="btn btn-secondary" onClick={() => setIsAddOpen(false)}>Cancel</button>
                  <button className="btn btn-primary" onClick={handleSave} disabled={!form.name}>{editingId ? 'Update' : 'Add Item'}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Version History Component
    const VersionHistory = ({ projectId, onClose }) => {
      const [history, setHistory] = React.useState([]);

      React.useEffect(() => {
        setHistory(db.getVersionHistory(projectId));
        lucide.createIcons();
      }, [projectId]);

      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      };

      const getChangeIcon = (type) => {
        switch(type) {
          case 'created': return 'plus-circle';
          case 'margin': return 'percent';
          case 'discount': return 'tag';
          case 'risk_margin': return 'shield';
          case 'phase_added': return 'layers';
          case 'phase_deleted': return 'trash-2';
          case 'status_change': return 'toggle-right';
          case 'cr_created': return 'git-pull-request';
          case 'cr_applied': return 'check-circle';
          case 'cr_rejected': return 'x-circle';
          case 'boq_added': return 'clipboard-list';
          case 'boq_deleted': return 'clipboard-x';
          default: return 'edit';
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" style={{maxWidth: 500}} onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 style={{display: 'flex', alignItems: 'center', gap: 8}}>
                <i data-lucide="history" style={{width: 20, height: 20}}></i>
                Version History
              </h3>
              <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
            </div>
            <div className="modal-body">
              {history.length === 0 ? (
                <div style={{textAlign: 'center', padding: 24, color: 'var(--gray-text)'}}>No changes recorded yet</div>
              ) : (
                <div className="version-history">
                  {history.map(entry => (
                    <div key={entry.id} className="version-item">
                      <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                        <i data-lucide={getChangeIcon(entry.change_type)} style={{width: 14, height: 14, color: 'var(--boud-purple)'}}></i>
                        <span className="version-time">{formatDate(entry.changed_at)}</span>
                        <span style={{fontSize: 11, color: 'var(--gray-text)'}}>by {entry.changed_by}</span>
                      </div>
                      <div className="version-change">{entry.description}</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Risk & Discount Modal
    const RiskDiscountModal = ({ project, onSave, onClose }) => {
      const [riskMargin, setRiskMargin] = React.useState(project?.risk_margin?.toString() || '0');
      const [discountPercent, setDiscountPercent] = React.useState(project?.discount_percent?.toString() || '0');

      React.useEffect(() => { lucide.createIcons(); }, []);

      const handleSave = () => {
        onSave({
          risk_margin: parseFloat(riskMargin) || 0,
          discount_percent: parseFloat(discountPercent) || 0
        });
        onClose();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>Risk Margin & Discount</h3>
              <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
            </div>
            <div className="modal-body">
              <div style={{padding: 16, background: 'rgba(94, 86, 222, 0.1)', borderRadius: 8, marginBottom: 24}}>
                <h4 style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8, color: 'var(--boud-purple)'}}>
                  <i data-lucide="shield" style={{width: 16, height: 16}}></i>
                  Risk Margin
                </h4>
                <p style={{fontSize: 13, color: 'var(--gray-text)', marginBottom: 12}}>
                  Add a buffer percentage to cover potential delays, scope creep, hidden costs, or client-side issues.
                </p>
                <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                  <input type="number" className="form-input" value={riskMargin} onChange={e => setRiskMargin(e.target.value)} min="0" max="50" step="1" style={{width: 100}} />
                  <span>%</span>
                </div>
              </div>

              <div style={{padding: 16, background: 'rgba(228, 106, 23, 0.1)', borderRadius: 8}}>
                <h4 style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8, color: 'var(--boud-orange)'}}>
                  <i data-lucide="tag" style={{width: 16, height: 16}}></i>
                  Discount
                </h4>
                <p style={{fontSize: 13, color: 'var(--gray-text)', marginBottom: 12}}>
                  Apply a discount to the final price. Can be added or modified at any time.
                </p>
                <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                  <input type="number" className="form-input" value={discountPercent} onChange={e => setDiscountPercent(e.target.value)} min="0" max="100" step="1" style={{width: 100}} />
                  <span>%</span>
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
              <button className="btn btn-primary" onClick={handleSave}>Save Changes</button>
            </div>
          </div>
        </div>
      );
    };

    // Change Request Modal
    const ChangeRequestModal = ({ form, onUpdate, onSubmit, onClose }) => (
      <div className="modal-overlay" onClick={onClose}>
        <div className="modal" style={{maxWidth: 500}} onClick={e => e.stopPropagation()}>
          <div className="modal-header">
            <h3>Request Change</h3>
            <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
          </div>
          <div className="modal-body">
            <p className="text-secondary" style={{fontSize: 13, marginBottom: 16}}>This project is locked. Submit a change request to modify this field.</p>
            {form.label && <div className="form-group"><label className="form-label">Field</label><div style={{padding: '8px 12px', background: 'var(--bg-secondary)', borderRadius: 8, fontSize: 14}}>{form.label}</div></div>}
            <div className="form-group"><label className="form-label">Current Value</label><div style={{padding: '8px 12px', background: 'var(--bg-secondary)', borderRadius: 8, fontSize: 14, fontFamily: 'monospace'}}>{form.old_value || '—'}</div></div>
            <div className="form-group"><label className="form-label">New Value *</label><input type="text" className="form-input" value={form.new_value} onChange={e => onUpdate({...form, new_value: e.target.value})} placeholder="Enter new value" autoFocus /></div>
            <div className="form-group"><label className="form-label">Reason for Change *</label><textarea className="form-input" rows={3} value={form.reason} onChange={e => onUpdate({...form, reason: e.target.value})} placeholder="Explain why this change is needed..." style={{resize: 'vertical'}}></textarea></div>
          </div>
          <div className="modal-footer">
            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
            <button className="btn btn-primary" disabled={!form.new_value || !form.reason} onClick={onSubmit}>
              <i data-lucide="git-pull-request" style={{width: 16, height: 16}}></i> Submit Request
            </button>
          </div>
        </div>
      </div>
    );

    // Change Request Panel (Side panel)
    const ChangeRequestPanel = ({ projectId, changeRequests, onClose, onRefresh }) => {
      const pending = changeRequests.filter(cr => cr.status === 'pending');
      const applied = changeRequests.filter(cr => cr.status === 'applied');
      const rejected = changeRequests.filter(cr => cr.status === 'rejected');

      const handleApply = (crId) => {
        db.applyChangeRequest(crId);
        onRefresh();
      };
      const handleReject = (crId) => {
        db.rejectChangeRequest(crId);
        onRefresh();
      };

      const formatDate = (iso) => new Date(iso).toLocaleDateString('en-SA', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

      const CrCard = ({ cr }) => (
        <div style={{padding: 12, background: 'var(--bg-secondary)', borderRadius: 8, marginBottom: 8, borderLeft: `3px solid ${cr.status === 'pending' ? 'var(--warning)' : cr.status === 'applied' ? 'var(--success)' : 'var(--error)'}`}}>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 6}}>
            <span style={{fontSize: 13, fontWeight: 600, wordBreak: 'break-all'}}>{cr.field_path}</span>
            <span className={`badge ${cr.status === 'pending' ? 'badge-yellow' : cr.status === 'applied' ? 'badge-green' : 'badge-red'}`} style={{fontSize: 10, flexShrink: 0}}>{cr.status}</span>
          </div>
          <div style={{fontSize: 12, marginBottom: 4}}>
            <span className="text-secondary">From:</span> <code style={{fontSize: 11}}>{cr.old_value}</code> → <span style={{fontWeight: 500}}>{cr.new_value}</span>
          </div>
          <p style={{fontSize: 12, color: 'var(--text-secondary)', margin: '4px 0'}}>{cr.reason}</p>
          <div style={{fontSize: 11, color: 'var(--gray-text)'}}>
            {cr.requested_by} • {formatDate(cr.requested_at)}
            {cr.applied_at && ` • Applied: ${formatDate(cr.applied_at)}`}
          </div>
          {cr.status === 'pending' && (
            <div style={{display: 'flex', gap: 6, marginTop: 8}}>
              <button className="btn btn-sm" style={{background: 'var(--success)', color: 'white', border: 'none', fontSize: 12}} onClick={() => handleApply(cr.id)}>
                <i data-lucide="check" style={{width: 12, height: 12}}></i> Apply
              </button>
              <button className="btn btn-sm" style={{background: 'var(--error)', color: 'white', border: 'none', fontSize: 12}} onClick={() => handleReject(cr.id)}>
                <i data-lucide="x" style={{width: 12, height: 12}}></i> Reject
              </button>
            </div>
          )}
        </div>
      );

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div style={{position: 'fixed', top: 0, right: 0, bottom: 0, width: 420, maxWidth: '90vw', background: 'var(--bg-primary)', boxShadow: '-4px 0 24px rgba(0,0,0,0.3)', display: 'flex', flexDirection: 'column', zIndex: 1001}} onClick={e => e.stopPropagation()}>
            <div style={{padding: '16px 20px', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
              <h3 style={{margin: 0}}>Change Requests</h3>
              <button className="btn btn-icon" onClick={onClose}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
            </div>
            <div style={{flex: 1, overflow: 'auto', padding: 20}}>
              {changeRequests.length === 0 ? (
                <div style={{textAlign: 'center', padding: 32, color: 'var(--gray-text)'}}>
                  <i data-lucide="git-pull-request" style={{width: 40, height: 40, marginBottom: 12}}></i>
                  <p>No change requests yet</p>
                </div>
              ) : (
                <>
                  {pending.length > 0 && (
                    <div style={{marginBottom: 20}}>
                      <h4 style={{fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--warning)', marginBottom: 8}}>Pending ({pending.length})</h4>
                      {pending.map(cr => <CrCard key={cr.id} cr={cr} />)}
                    </div>
                  )}
                  {applied.length > 0 && (
                    <div style={{marginBottom: 20}}>
                      <h4 style={{fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--success)', marginBottom: 8}}>Applied ({applied.length})</h4>
                      {applied.map(cr => <CrCard key={cr.id} cr={cr} />)}
                    </div>
                  )}
                  {rejected.length > 0 && (
                    <div style={{marginBottom: 20}}>
                      <h4 style={{fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--error)', marginBottom: 8}}>Rejected ({rejected.length})</h4>
                      {rejected.map(cr => <CrCard key={cr.id} cr={cr} />)}
                    </div>
                  )}
                </>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Payment Schedule Editor
    const PaymentScheduleEditor = ({ projectId, project, totals, editable, onRefresh }) => {
      const [schedule, setSchedule] = React.useState(null);
      const [isAddOpen, setIsAddOpen] = React.useState(false);
      const [form, setForm] = React.useState({ date: '', amount: '', description: '', notes: '' });

      const loadData = () => {
        setSchedule(db.getPaymentSchedule(projectId));
        setTimeout(() => lucide.createIcons(), 0);
      };
      React.useEffect(() => { loadData(); }, [projectId]);

      const payments = schedule?.payments || [];
      const totalScheduled = payments.reduce((s, p) => s + (p.amount || 0), 0);
      const totalReceived = payments.filter(p => p.status === 'received').reduce((s, p) => s + (p.amount || 0), 0);
      const remaining = (totals?.sellingPrice || 0) - totalScheduled;

      const handleAdd = () => {
        db.addPayment(projectId, {
          date: form.date,
          amount: parseFloat(form.amount) || 0,
          description: form.description,
          notes: form.notes || '',
          boq_item_ids: []
        });
        setIsAddOpen(false);
        setForm({ date: '', amount: '', description: '', notes: '' });
        loadData();
        onRefresh?.();
      };

      const toggleStatus = (paymentId, currentStatus) => {
        const newStatus = currentStatus === 'received' ? 'pending' : 'received';
        db.updatePayment(projectId, paymentId, { status: newStatus });
        loadData();
      };

      const getStatusColor = (status) => {
        if (status === 'received') return 'var(--success)';
        const payment = payments.find(p => p.status === status);
        if (payment && payment.date && new Date(payment.date) < new Date()) return 'var(--error)';
        return 'var(--warning)';
      };

      return (
        <div className="card" style={{marginBottom: 24}}>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16}}>
            <div>
              <h3 style={{margin: 0}}>Payment Schedule</h3>
              <p className="text-secondary" style={{fontSize: 13, margin: '4px 0 0'}}>
                {payments.length} payments — {formatCurrency(totalReceived)} received of {formatCurrency(totalScheduled)} scheduled
              </p>
            </div>
            {editable && (
              <button className="btn btn-primary btn-sm" onClick={() => { setForm({ date: '', amount: remaining > 0 ? remaining.toString() : '', description: '', notes: '' }); setIsAddOpen(true); }}>
                <i data-lucide="plus" style={{width: 14, height: 14}}></i> Add Payment
              </button>
            )}
          </div>

          {/* Payment progress */}
          {totalScheduled > 0 && (
            <div style={{marginBottom: 16}}>
              <div style={{display: 'flex', justifyContent: 'space-between', fontSize: 12, marginBottom: 4}}>
                <span>Collected: {formatCurrency(totalReceived)}</span>
                <span>{Math.round(totalReceived / totalScheduled * 100)}%</span>
              </div>
              <div style={{height: 8, borderRadius: 4, background: 'var(--bg-secondary)', overflow: 'hidden'}}>
                <div style={{height: '100%', width: `${Math.round(totalReceived / totalScheduled * 100)}%`, background: 'var(--success)', borderRadius: 4, transition: 'width 0.3s'}}></div>
              </div>
              {remaining > 0 && <div style={{fontSize: 12, color: 'var(--warning)', marginTop: 4}}>Unscheduled: {formatCurrency(remaining)}</div>}
              {remaining < 0 && <div style={{fontSize: 12, color: 'var(--error)', marginTop: 4}}>Over-scheduled by {formatCurrency(Math.abs(remaining))}</div>}
            </div>
          )}

          {/* Payment timeline */}
          {payments.length === 0 ? (
            <div style={{textAlign: 'center', padding: 24, color: 'var(--gray-text)'}}>
              <i data-lucide="calendar" style={{width: 36, height: 36, marginBottom: 8}}></i>
              <p>No payments scheduled yet</p>
            </div>
          ) : (
            <table>
              <thead><tr><th>Date</th><th>Description</th><th style={{textAlign: 'right'}}>Amount</th><th>Status</th><th>Notes</th><th></th></tr></thead>
              <tbody>
                {payments.sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0)).map(p => {
                  const isOverdue = p.status === 'pending' && p.date && new Date(p.date) < new Date();
                  return (
                    <tr key={p.id} style={{background: isOverdue ? 'rgba(239,68,68,0.05)' : undefined}}>
                      <td style={{whiteSpace: 'nowrap'}}>{p.date ? new Date(p.date).toLocaleDateString('en-SA', { month: 'short', day: 'numeric', year: 'numeric' }) : '—'}</td>
                      <td style={{fontWeight: 500}}>{p.description || '—'}</td>
                      <td style={{textAlign: 'right', fontWeight: 600}}>{formatCurrency(p.amount)}</td>
                      <td>
                        <button className={`badge ${p.status === 'received' ? 'badge-green' : isOverdue ? 'badge-red' : 'badge-yellow'}`}
                          style={{cursor: 'pointer', border: 'none', fontSize: 11}} onClick={() => toggleStatus(p.id, p.status)}>
                          {p.status === 'received' ? 'Received' : isOverdue ? 'Overdue' : 'Pending'}
                        </button>
                      </td>
                      <td className="text-secondary" style={{fontSize: 12}}>{p.notes || '—'}</td>
                      <td>
                        {editable && (
                          <button className="btn btn-icon btn-sm" onClick={() => { db.deletePayment(projectId, p.id); loadData(); }} style={{color: 'var(--error)'}}>
                            <i data-lucide="trash-2" style={{width: 14, height: 14}}></i>
                          </button>
                        )}
                      </td>
                    </tr>
                  );
                })}
                <tr style={{fontWeight: 600}}>
                  <td colSpan={2}>Total</td>
                  <td style={{textAlign: 'right'}}>{formatCurrency(totalScheduled)}</td>
                  <td colSpan={3}></td>
                </tr>
              </tbody>
            </table>
          )}

          {/* Add Payment Modal */}
          {isAddOpen && (
            <div className="modal-overlay" onClick={() => setIsAddOpen(false)}>
              <div className="modal" style={{maxWidth: 450}} onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>Add Payment</h3><button className="btn btn-icon" onClick={() => setIsAddOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <div className="modal-body">
                  <div className="form-group"><label className="form-label">Due Date</label><input type="date" className="form-input" value={form.date} onChange={e => setForm({...form, date: e.target.value})} /></div>
                  <div className="form-group"><label className="form-label">Amount (SAR) *</label><input type="number" className="form-input" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} /></div>
                  <div className="form-group"><label className="form-label">Description *</label><input type="text" className="form-input" value={form.description} onChange={e => setForm({...form, description: e.target.value})} placeholder="e.g., Phase 1 milestone, Final payment" /></div>
                  <div className="form-group"><label className="form-label">Notes</label><textarea className="form-input" rows={2} value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} placeholder="Follow-up notes..." style={{resize: 'vertical'}}></textarea></div>
                </div>
                <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setIsAddOpen(false)}>Cancel</button><button className="btn btn-primary" disabled={!form.amount || !form.description} onClick={handleAdd}>Add Payment</button></div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Simplified Project Pricing Component with new features
    const ProjectPricing = ({ projectId, onBack, onRefresh, onNavigate }) => {
      const [project, setProject] = React.useState(null);
      const [phases, setPhases] = React.useState([]);
      const [totals, setTotals] = React.useState(null);
      const [roles, setRoles] = React.useState([]);
      const [expandedPhases, setExpandedPhases] = React.useState({});
      const [isHistoryOpen, setIsHistoryOpen] = React.useState(false);
      const [isRiskDiscountOpen, setIsRiskDiscountOpen] = React.useState(false);
      const [activeTab, setActiveTab] = React.useState('resources');
      const [isPhaseModalOpen, setIsPhaseModalOpen] = React.useState(false);
      const [isResourceModalOpen, setIsResourceModalOpen] = React.useState(false);
      const [currentPhaseId, setCurrentPhaseId] = React.useState(null);
      const [editingItem, setEditingItem] = React.useState(null);
      const [phaseForm, setPhaseForm] = React.useState({ name: '', margin_percent: '' });
      const [resourceForm, setResourceForm] = React.useState({ role_id: '', days: '', daily_rate_override: '', notes: '' });
      const [isCrPanelOpen, setIsCrPanelOpen] = React.useState(false);
      const [isCrModalOpen, setIsCrModalOpen] = React.useState(false);
      const [isPackageSelectorOpen, setIsPackageSelectorOpen] = React.useState(false);
      const [crForm, setCrForm] = React.useState({ field_path: '', old_value: '', new_value: '', reason: '', label: '' });
      const [changeRequests, setChangeRequests] = React.useState([]);

      const editable = db.isEditable(project);

      const loadData = React.useCallback(() => {
        const p = db.getProject(projectId);
        setProject(p);
        const phaseList = db.getPhases(projectId).map(phase => ({
          ...phase,
          resources: db.getResourceCosts(phase.id),
          tools: db.getToolCosts(phase.id),
          vendors: db.getVendorCosts(phase.id)
        }));
        setPhases(phaseList);
        const exp = {};
        phaseList.forEach(ph => exp[ph.id] = true);
        setExpandedPhases(exp);
        setTotals(db.calculateProjectTotals(projectId));
        setRoles(db.getRoles());
        setChangeRequests(db.getChangeRequests(projectId));
        setTimeout(() => lucide.createIcons(), 0);
      }, [projectId]);

      React.useEffect(() => { loadData(); }, [loadData]);

      const handleSavePhase = () => {
        const marginVal = phaseForm.margin_percent === '' ? null : parseFloat(phaseForm.margin_percent);
        if (editingItem) {
          db.updatePhase(editingItem.id, { name: phaseForm.name, margin_percent: marginVal });
        } else {
          const id = db.createPhase(projectId, phaseForm.name);
          if (marginVal !== null) db.updatePhase(id, { margin_percent: marginVal });
        }
        setIsPhaseModalOpen(false);
        loadData();
      };

      const handleSaveResource = () => {
        if (editingItem) db.updateResourceCost(editingItem.id, parseFloat(resourceForm.days), resourceForm.daily_rate_override ? parseFloat(resourceForm.daily_rate_override) : null, resourceForm.notes);
        else db.addResourceCost(currentPhaseId, resourceForm.role_id, parseFloat(resourceForm.days), resourceForm.daily_rate_override ? parseFloat(resourceForm.daily_rate_override) : null, resourceForm.notes);
        setIsResourceModalOpen(false);
        loadData();
      };

      const handleSaveRiskDiscount = (data) => {
        db.updateProject(projectId, data);
        loadData();
        onRefresh?.();
      };

      const handleSaveAsTemplate = () => {
        const name = prompt('Template name:');
        if (name) {
          saveTemplate({
            name,
            description: `Based on ${project.name}`,
            config: {
              duration_weeks: project.duration_weeks,
              target_margin: project.target_margin,
              pricing_models: project.pricing_models,
              risk_margin: project.risk_margin,
              saas_monthly_price: project.saas_monthly_price,
              saas_yearly_price: project.saas_yearly_price,
              setup_fee: project.setup_fee,
              api_type: project.api_type,
              api_markup: project.api_markup,
              api_expected_hits: project.api_expected_hits,
              selected_products: project.selected_products
            }
          });
          alert('Template saved!');
        }
      };

      if (!project || !totals) return <div>Loading...</div>;

      const vatRate = parseFloat(localStorage.getItem('boud_vat_rate') || '15');
      const priceWithVat = totals.sellingPrice * (1 + vatRate / 100);

      return (
        <div>
          <div style={{display: 'flex', alignItems: 'center', gap: 16, marginBottom: 24}}>
            <button className="btn btn-icon" onClick={onBack}><i data-lucide="arrow-left" style={{width: 20, height: 20}}></i></button>
            <div style={{flex: 1}}>
              <div style={{display: 'flex', alignItems: 'center', gap: 10}}>
                <h1 className="page-title" style={{margin: 0}}>{project.name}</h1>
                <span className={`badge ${project.status === 'approved' ? 'badge-green' : project.status === 'pending_approval' ? 'badge-yellow' : 'badge-purple'}`} style={{fontSize: 12, padding: '4px 10px'}}>
                  {project.status === 'approved' ? 'Approved' : project.status === 'pending_approval' ? 'Pending Approval' : 'Draft'}
                </span>
                {!editable && (
                  <span style={{fontSize: 12, color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', gap: 4}}>
                    <i data-lucide="lock" style={{width: 12, height: 12}}></i> Locked
                  </span>
                )}
              </div>
              <p className="text-secondary" style={{margin: 0}}>{project.client && `${project.client} • `}{project.duration_weeks && `${project.duration_weeks} weeks`}</p>
            </div>
            {/* Status transition buttons */}
            {project.status === 'draft' && (
              <button className="btn btn-primary" onClick={() => { db.submitForApproval(projectId); loadData(); }} style={{background: 'var(--warning)', borderColor: 'var(--warning)'}}>
                <i data-lucide="send" style={{width: 16, height: 16}}></i> Submit for Approval
              </button>
            )}
            {project.status === 'pending_approval' && (
              <>
                <button className="btn btn-primary" onClick={() => { db.approveProject(projectId); loadData(); }} style={{background: 'var(--success)', borderColor: 'var(--success)'}}>
                  <i data-lucide="check-circle" style={{width: 16, height: 16}}></i> Approve
                </button>
                <button className="btn btn-secondary" onClick={() => { db.revertToDraft(projectId); loadData(); }}>
                  <i data-lucide="undo-2" style={{width: 16, height: 16}}></i> Revert to Draft
                </button>
              </>
            )}
            {project.status === 'approved' && (
              <button className="btn btn-secondary" onClick={() => { db.revertToDraft(projectId); loadData(); }}>
                <i data-lucide="undo-2" style={{width: 16, height: 16}}></i> Revert to Draft
              </button>
            )}
            {changeRequests.filter(cr => cr.status === 'pending').length > 0 && (
              <button className="btn btn-secondary" onClick={() => setIsCrPanelOpen(true)} style={{position: 'relative'}}>
                <i data-lucide="git-pull-request" style={{width: 16, height: 16}}></i> CRs
                <span className="badge badge-red" style={{position: 'absolute', top: -6, right: -6, fontSize: 10, padding: '2px 6px'}}>{changeRequests.filter(cr => cr.status === 'pending').length}</span>
              </button>
            )}
            <button className="btn btn-secondary" onClick={() => setIsHistoryOpen(true)}>
              <i data-lucide="history" style={{width: 16, height: 16}}></i> History
            </button>
            <button className="btn btn-secondary" onClick={handleSaveAsTemplate}>
              <i data-lucide="bookmark" style={{width: 16, height: 16}}></i> Save as Template
            </button>
            <button className="btn btn-secondary" onClick={() => handleExportCSV(project, phases, totals, vatRate)}>
              <i data-lucide="table" style={{width: 16, height: 16}}></i> CSV
            </button>
            <button className="btn btn-primary" onClick={() => handleExportProposal(project, phases, totals, vatRate)}>
              <i data-lucide="printer" style={{width: 16, height: 16}}></i> Print
            </button>
          </div>

          {/* Pricing Summary with Risk & Discount */}
          <div className="margin-display" style={{marginBottom: 24}}>
            <div className="margin-item">
              <div className="label">Total Cost</div>
              <div className="value">{formatCurrency(totals.totalCost)}</div>
            </div>
            <div className="margin-divider"></div>
            {totals.riskMarginPercent > 0 && (
              <>
                <div className="margin-item">
                  <div className="label">Risk Buffer ({totals.riskMarginPercent}%)</div>
                  <div className="value" style={{color: 'var(--boud-orange)'}}>{formatCurrency(totals.riskMarginAmount)}</div>
                </div>
                <div className="margin-divider"></div>
              </>
            )}
            <div className="margin-item">
              <div className="label">Subtotal</div>
              <div className="value">{formatCurrency(totals.subtotal)}</div>
            </div>
            {totals.discountPercent > 0 && (
              <>
                <div className="margin-divider"></div>
                <div className="margin-item">
                  <div className="label">Discount ({totals.discountPercent}%)</div>
                  <div className="value" style={{color: 'var(--boud-orange)'}}>-{formatCurrency(totals.discountAmount)}</div>
                </div>
              </>
            )}
            <div className="margin-divider"></div>
            <div className="margin-item">
              <div className="label">Selling Price</div>
              <div className="value" style={{color: 'var(--boud-lime)'}}>{formatCurrency(totals.sellingPrice)}</div>
            </div>
            <div className="margin-divider"></div>
            <div className="margin-item">
              <div className="label">With VAT ({vatRate}%)</div>
              <div className="value">{formatCurrency(priceWithVat)}</div>
            </div>
            <div className="margin-divider"></div>
            <div className="margin-item">
              <div className="label">Margin</div>
              <div className="value" style={{color: totals.actualMargin >= 25 ? 'var(--success)' : totals.actualMargin >= 15 ? 'var(--warning)' : 'var(--error)'}}>{totals.actualMargin.toFixed(1)}%</div>
            </div>
            {totals.totalBoqValue > 0 && (
              <>
                <div className="margin-divider"></div>
                <div className="margin-item">
                  <div className="label">BOQ Value ({totals.boqItemCount} items)</div>
                  <div className="value" style={{color: 'var(--boud-purple)'}}>{formatCurrency(totals.totalBoqValue)}</div>
                </div>
              </>
            )}
          </div>

          {/* Action Buttons */}
          {editable ? (
            <div style={{display: 'flex', gap: 8, marginBottom: 16}}>
              <button className="btn btn-purple" onClick={() => setIsRiskDiscountOpen(true)}>
                <i data-lucide="sliders" style={{width: 16, height: 16}}></i> Risk & Discount
              </button>
              <button className="btn btn-secondary" onClick={() => { setPhaseForm({ name: '', margin_percent: '' }); setEditingItem(null); setIsPhaseModalOpen(true); }}>
                <i data-lucide="plus" style={{width: 16, height: 16}}></i> Add Phase
              </button>
              {!project.applied_package_id && (
                <div style={{position: 'relative'}}>
                  <button className="btn btn-secondary" onClick={() => setIsPackageSelectorOpen(!isPackageSelectorOpen)}>
                    <i data-lucide="package" style={{width: 16, height: 16}}></i> Apply Package
                  </button>
                  {isPackageSelectorOpen && (
                    <div style={{position: 'absolute', top: '100%', left: 0, marginTop: 4, background: 'var(--bg-primary)', border: '1px solid var(--border)', borderRadius: 8, boxShadow: '0 8px 24px rgba(0,0,0,0.2)', padding: 8, zIndex: 100, minWidth: 250}}>
                      {db.getPackages().map(pkg => (
                        <button key={pkg.id} className="btn btn-sm" style={{width: '100%', justifyContent: 'flex-start', marginBottom: 4}} onClick={() => {
                          if (confirm(`Apply "${pkg.name}" (${formatCurrency(pkg.price_sar)}) to this project? This will add BOQ items from the package.`)) {
                            db.applyPackageToProject(projectId, pkg.id);
                            loadData();
                            setIsPackageSelectorOpen(false);
                          }
                        }}>
                          <span style={{fontWeight: 600}}>{pkg.name}</span>
                          <span className="text-secondary" style={{marginLeft: 8}}>{formatCurrency(pkg.price_sar)}</span>
                        </button>
                      ))}
                      {db.getPackages().length === 0 && <p className="text-secondary" style={{fontSize: 12, padding: 8}}>No packages available. Create one in Credits & Packages.</p>}
                    </div>
                  )}
                </div>
              )}
              {project.applied_package_id && (
                <span className="badge badge-purple" style={{padding: '6px 12px', fontSize: 12}}>
                  <i data-lucide="package" style={{width: 14, height: 14}}></i> {db.getAllPackages().find(p => p.id === project.applied_package_id)?.name || 'Package Applied'}
                </span>
              )}
            </div>
          ) : (
            <div style={{display: 'flex', gap: 8, marginBottom: 16, alignItems: 'center'}}>
              <div style={{padding: '8px 16px', background: 'var(--bg-secondary)', borderRadius: 8, fontSize: 13, color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', gap: 6}}>
                <i data-lucide="lock" style={{width: 14, height: 14}}></i>
                Project is {project.status === 'approved' ? 'approved' : 'pending approval'} — use Change Requests to modify
              </div>
              <button className="btn btn-secondary" onClick={() => setIsCrPanelOpen(true)}>
                <i data-lucide="git-pull-request" style={{width: 16, height: 16}}></i> Change Requests ({changeRequests.length})
              </button>
            </div>
          )}

          {/* View Tabs */}
          <div className="tabs" style={{marginBottom: 20}}>
            <button className={`tab ${activeTab === 'resources' ? 'active' : ''}`} onClick={() => setActiveTab('resources')}>Resources & Costs</button>
            <button className={`tab ${activeTab === 'boq' ? 'active' : ''}`} onClick={() => setActiveTab('boq')}>
              BOQ {totals.boqItemCount > 0 && <span className="badge badge-purple" style={{marginLeft: 6, fontSize: 11}}>{totals.boqItemCount}</span>}
            </button>
            <button className={`tab ${activeTab === 'billing' ? 'active' : ''}`} onClick={() => setActiveTab('billing')}>
              Billing {(() => { const s = db.getPaymentSchedule(projectId); return s && s.payments.length > 0 ? <span className="badge badge-green" style={{marginLeft: 6, fontSize: 11}}>{s.payments.length}</span> : null; })()}
            </button>
          </div>

          {/* BOQ Tab */}
          {activeTab === 'boq' && (
            <div className="card" style={{marginBottom: 24}}>
              <BOQTable projectId={projectId} projectMargin={project.target_margin || 0} editable={editable} onCreateCr={(fieldPath, oldVal, label) => { setCrForm({ field_path: fieldPath, old_value: String(oldVal), new_value: '', reason: '', label }); setIsCrModalOpen(true); }} />
            </div>
          )}

          {/* Billing Tab */}
          {activeTab === 'billing' && (
            <PaymentScheduleEditor projectId={projectId} project={project} totals={totals} editable={editable} onRefresh={loadData} />
          )}

          {/* Resources Tab - Phases */}
          {activeTab === 'resources' && phases.map(phase => (
            <div key={phase.id} className="phase-section">
              <div className="phase-header" onClick={() => setExpandedPhases(prev => ({...prev, [phase.id]: !prev[phase.id]}))}>
                <h3 style={{display: 'flex', alignItems: 'center', gap: 8}}>
                  <i data-lucide={expandedPhases[phase.id] ? 'chevron-down' : 'chevron-right'} style={{width: 16, height: 16}}></i>
                  {phase.name}
                  {phase.margin_percent !== null && phase.margin_percent !== undefined && (
                    <span className={`badge ${phase.margin_percent > 30 ? 'badge-green' : phase.margin_percent > 10 ? 'badge-yellow' : phase.margin_percent > 0 ? 'badge-purple' : 'badge-red'}`} style={{fontSize: 11, marginLeft: 4}}>
                      {phase.margin_percent}% margin
                    </span>
                  )}
                </h3>
                <div style={{display: 'flex', alignItems: 'center', gap: 12}}>
                  <div style={{display: 'flex', alignItems: 'center', gap: 4}} onClick={e => e.stopPropagation()}>
                    <label style={{fontSize: 12, color: 'var(--text-secondary)', whiteSpace: 'nowrap'}}>Margin%</label>
                    <input type="number" className="form-input" style={{width: 70, padding: '2px 6px', fontSize: 12, textAlign: 'center'}}
                      value={phase.margin_percent ?? ''} placeholder="—"
                      disabled={!editable}
                      onChange={e => {
                        if (!editable) return;
                        const val = e.target.value === '' ? null : parseFloat(e.target.value);
                        db.updatePhase(phase.id, { margin_percent: val });
                        loadData();
                      }}
                    />
                  </div>
                  <div className="phase-total">{formatCurrency(phase.resources.reduce((s, r) => s + r.total, 0) + phase.tools.reduce((s, t) => s + t.total, 0) + phase.vendors.reduce((s, v) => s + v.cost, 0))}</div>
                </div>
              </div>
              {expandedPhases[phase.id] && (
                <div className="phase-content">
                  <div style={{marginBottom: 16}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                      <h4>Resources</h4>
                      {editable && (
                        <button className="btn btn-sm btn-secondary" onClick={() => { setCurrentPhaseId(phase.id); setResourceForm({ role_id: '', days: '', daily_rate_override: '', notes: '' }); setEditingItem(null); setIsResourceModalOpen(true); }}>
                          <i data-lucide="plus" style={{width: 14, height: 14}}></i> Add
                        </button>
                      )}
                    </div>
                    {phase.resources.length === 0 ? (
                      <p className="text-secondary" style={{fontSize: 13}}>No resources added yet</p>
                    ) : (
                      <table>
                        <thead><tr><th>Role</th><th>Days</th><th>Daily Rate</th><th>Total</th><th></th></tr></thead>
                        <tbody>
                          {phase.resources.map(r => (
                            <tr key={r.id}>
                              <td>{r.role_name}</td>
                              <td>{r.days}d</td>
                              <td>{formatCurrency(r.effective_daily_rate)}/day</td>
                              <td style={{fontWeight: 600}}>{formatCurrency(r.total)}</td>
                              <td>
                                {editable && (
                                  <button className="btn btn-icon btn-sm" onClick={() => db.deleteResourceCost(r.id) || loadData()} style={{color: 'var(--error)'}}><i data-lucide="trash-2" style={{width: 14, height: 14}}></i></button>
                                )}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>
                </div>
              )}
            </div>
          ))}

          {/* Modals */}
          {/* Note: modals render outside tab content */}
          {isHistoryOpen && <VersionHistory projectId={projectId} onClose={() => setIsHistoryOpen(false)} />}
          {isRiskDiscountOpen && <RiskDiscountModal project={project} onSave={handleSaveRiskDiscount} onClose={() => setIsRiskDiscountOpen(false)} />}
          {isCrModalOpen && <ChangeRequestModal form={crForm} onUpdate={setCrForm} onSubmit={() => { db.createChangeRequest(projectId, crForm.field_path, crForm.old_value, crForm.new_value, crForm.reason); setIsCrModalOpen(false); loadData(); }} onClose={() => setIsCrModalOpen(false)} />}
          {isCrPanelOpen && <ChangeRequestPanel projectId={projectId} changeRequests={changeRequests} onClose={() => setIsCrPanelOpen(false)} onRefresh={() => { loadData(); }} />}

          {isPhaseModalOpen && (
            <div className="modal-overlay" onClick={() => setIsPhaseModalOpen(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>{editingItem ? 'Edit Phase' : 'Add Phase'}</h3><button className="btn btn-icon" onClick={() => setIsPhaseModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <div className="modal-body">
                  <div className="form-group"><label className="form-label">Phase Name</label><input type="text" className="form-input" value={phaseForm.name} onChange={e => setPhaseForm(prev => ({...prev, name: e.target.value}))} placeholder="e.g., Discovery, Development" /></div>
                  <div className="form-group"><label className="form-label">Phase Margin % <span style={{color: 'var(--text-secondary)', fontWeight: 400}}>(optional — overrides project margin for this phase)</span></label><input type="number" className="form-input" value={phaseForm.margin_percent} onChange={e => setPhaseForm(prev => ({...prev, margin_percent: e.target.value}))} placeholder="Leave empty to use project margin" /></div>
                </div>
                <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setIsPhaseModalOpen(false)}>Cancel</button><button className="btn btn-primary" onClick={handleSavePhase}>Save</button></div>
              </div>
            </div>
          )}

          {isResourceModalOpen && (
            <div className="modal-overlay" onClick={() => setIsResourceModalOpen(false)}>
              <div className="modal" style={{maxWidth: 550}} onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>Add Resource</h3><button className="btn btn-icon" onClick={() => setIsResourceModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <div className="modal-body">
                  <div className="form-group">
                    <label className="form-label">Role</label>
                    <RoleSelector roles={roles} value={resourceForm.role_id} onChange={id => setResourceForm({...resourceForm, role_id: id})} formatCurrency={formatCurrency} />
                  </div>
                  <div className="form-row">
                    <div className="form-group"><label className="form-label">Days (1 day = 5 hours)</label><input type="number" className="form-input" value={resourceForm.days} onChange={e => setResourceForm({...resourceForm, days: e.target.value})} min="0" step="0.5" /></div>
                    <div className="form-group"><label className="form-label">Daily Rate Override (optional)</label><input type="number" className="form-input" value={resourceForm.daily_rate_override} onChange={e => setResourceForm({...resourceForm, daily_rate_override: e.target.value})} placeholder="Use default" /></div>
                  </div>
                </div>
                <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setIsResourceModalOpen(false)}>Cancel</button><button className="btn btn-primary" onClick={handleSaveResource}>Add</button></div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Default 89 roles from Resources Pricing List
    const DEFAULT_ROLES = [
      { name: 'Senior Consultant - PO', hourly_rate: 710, department: 'PO' },
      { name: 'Consultant - PO', hourly_rate: 600, department: 'PO' },
      { name: 'Associate Consultant - PO', hourly_rate: 450, department: 'PO' },
      { name: 'Senior Specialist - PO', hourly_rate: 250, department: 'PO' },
      { name: 'Specialist - PO', hourly_rate: 190, department: 'PO' },
      { name: 'Senior Analyst - PO', hourly_rate: 142.5, department: 'PO' },
      { name: 'Junior Analyst - PO', hourly_rate: 110, department: 'PO' },
      { name: 'Intern - PO', hourly_rate: 15, department: 'PO' },
      { name: 'Senior Consultant - PM', hourly_rate: 560, department: 'PM' },
      { name: 'Consultant - PM', hourly_rate: 450, department: 'PM' },
      { name: 'Associate Consultant - PM', hourly_rate: 350, department: 'PM' },
      { name: 'Senior Specialist - PM', hourly_rate: 220, department: 'PM' },
      { name: 'Specialist - PM', hourly_rate: 150, department: 'PM' },
      { name: 'Senior Analyst - PM', hourly_rate: 100, department: 'PM' },
      { name: 'Junior Analyst - PM', hourly_rate: 70, department: 'PM' },
      { name: 'Intern - PM', hourly_rate: 30, department: 'PM' },
      { name: 'Senior Consultant - BA', hourly_rate: 350, department: 'BA' },
      { name: 'Consultant - BA', hourly_rate: 300, department: 'BA' },
      { name: 'Associate Consultant - BA', hourly_rate: 250, department: 'BA' },
      { name: 'Senior Specialist - BA', hourly_rate: 200, department: 'BA' },
      { name: 'Specialist - BA', hourly_rate: 170, department: 'BA' },
      { name: 'Senior Analyst - BA', hourly_rate: 140, department: 'BA' },
      { name: 'Junior Analyst - BA', hourly_rate: 100, department: 'BA' },
      { name: 'Intern - BA', hourly_rate: 30, department: 'BA' },
      { name: 'Senior Consultant - UXUI', hourly_rate: 450, department: 'UXUI' },
      { name: 'Consultant - UXUI', hourly_rate: 300, department: 'UXUI' },
      { name: 'Associate Consultant - UXUI', hourly_rate: 200, department: 'UXUI' },
      { name: 'Senior Specialist - UXUI', hourly_rate: 160, department: 'UXUI' },
      { name: 'Specialist - UXUI', hourly_rate: 125, department: 'UXUI' },
      { name: 'Senior Analyst - UXUI', hourly_rate: 95, department: 'UXUI' },
      { name: 'Junior Analyst - UXUI', hourly_rate: 57, department: 'UXUI' },
      { name: 'Intern - UXUI', hourly_rate: 30, department: 'UXUI' },
      { name: 'Senior Consultant Engineer - FE', hourly_rate: 250, department: 'FE' },
      { name: 'Consultant Engineer - FE', hourly_rate: 200, department: 'FE' },
      { name: 'Associate Consultant Engineer - FE', hourly_rate: 160, department: 'FE' },
      { name: 'Senior Specialist - FE', hourly_rate: 120, department: 'FE' },
      { name: 'Specialist - FE', hourly_rate: 80, department: 'FE' },
      { name: 'Senior Analyst - FE', hourly_rate: 45, department: 'FE' },
      { name: 'Junior Analyst - FE', hourly_rate: 45, department: 'FE' },
      { name: 'Intern - FE', hourly_rate: 30, department: 'FE' },
      { name: 'Senior Consultant Engineer - Mobile', hourly_rate: 350, department: 'Mobile' },
      { name: 'Consultant Engineer - Mobile', hourly_rate: 250, department: 'Mobile' },
      { name: 'Associate Consultant Engineer - Mobile', hourly_rate: 200, department: 'Mobile' },
      { name: 'Senior Specialist - Mobile', hourly_rate: 140, department: 'Mobile' },
      { name: 'Specialist - Mobile', hourly_rate: 80, department: 'Mobile' },
      { name: 'Senior Analyst - Mobile', hourly_rate: 57, department: 'Mobile' },
      { name: 'Junior Analyst - Mobile', hourly_rate: 40, department: 'Mobile' },
      { name: 'Intern - Mobile', hourly_rate: 30, department: 'Mobile' },
      { name: 'Senior Consultant Engineer - BE', hourly_rate: 250, department: 'BE' },
      { name: 'Consultant Engineer - BE', hourly_rate: 190, department: 'BE' },
      { name: 'Associate Consultant Engineer - BE', hourly_rate: 150, department: 'BE' },
      { name: 'Senior Specialist - BE', hourly_rate: 115, department: 'BE' },
      { name: 'Specialist - BE', hourly_rate: 90, department: 'BE' },
      { name: 'Senior Analyst - BE', hourly_rate: 70, department: 'BE' },
      { name: 'Junior Analyst - BE', hourly_rate: 50, department: 'BE' },
      { name: 'Intern - BE', hourly_rate: 30, department: 'BE' },
      { name: 'Senior Consultant - QA', hourly_rate: 250, department: 'QA' },
      { name: 'Consultant - QA', hourly_rate: 190, department: 'QA' },
      { name: 'Associate Consultant - QA', hourly_rate: 150, department: 'QA' },
      { name: 'Senior Specialist - QA', hourly_rate: 115, department: 'QA' },
      { name: 'Specialist - QA', hourly_rate: 90, department: 'QA' },
      { name: 'Senior Analyst - QA', hourly_rate: 70, department: 'QA' },
      { name: 'Junior Analyst - QA', hourly_rate: 50, department: 'QA' },
      { name: 'Intern - QA', hourly_rate: 30, department: 'QA' },
      { name: 'Senior Consultant - SM', hourly_rate: 250, department: 'SM' },
      { name: 'Consultant - SM', hourly_rate: 190, department: 'SM' },
      { name: 'Associate Consultant - SM', hourly_rate: 150, department: 'SM' },
      { name: 'Senior Specialist - SM', hourly_rate: 115, department: 'SM' },
      { name: 'Specialist - SM', hourly_rate: 90, department: 'SM' },
      { name: 'Senior Analyst - SM', hourly_rate: 70, department: 'SM' },
      { name: 'Junior Analyst - SM', hourly_rate: 50, department: 'SM' },
      { name: 'Intern - SM', hourly_rate: 30, department: 'SM' },
      { name: 'Senior Consultant - CMS', hourly_rate: 250, department: 'CMS' },
      { name: 'Consultant - CMS', hourly_rate: 190, department: 'CMS' },
      { name: 'Associate Consultant - CMS', hourly_rate: 150, department: 'CMS' },
      { name: 'Senior Specialist - CMS', hourly_rate: 115, department: 'CMS' },
      { name: 'Specialist - CMS', hourly_rate: 90, department: 'CMS' },
      { name: 'Senior Analyst - CMS', hourly_rate: 70, department: 'CMS' },
      { name: 'Junior Analyst - CMS', hourly_rate: 50, department: 'CMS' },
      { name: 'Intern - CMS', hourly_rate: 30, department: 'CMS' },
      { name: 'Senior Consultant - DA', hourly_rate: 490.91, department: 'DA' },
      { name: 'Consultant - DA', hourly_rate: 409.09, department: 'DA' },
      { name: 'Associate Consultant - DA', hourly_rate: 318.18, department: 'DA' },
      { name: 'Senior Specialist - DA', hourly_rate: 227.27, department: 'DA' },
      { name: 'Specialist - DA', hourly_rate: 181.82, department: 'DA' },
      { name: 'Senior Analyst - DA', hourly_rate: 159.09, department: 'DA' },
      { name: 'Junior Analyst - DA', hourly_rate: 136.36, department: 'DA' },
      { name: 'Intern - DA', hourly_rate: 45.45, department: 'DA' },
      { name: 'Web Designer', hourly_rate: 109.09, department: 'Design' }
    ];

    // Simplified components for rates, tools, projects list, insights, settings
    const RatesManagement = ({ onRefresh }) => {
      const [roles, setRoles] = React.useState([]);
      const [isModalOpen, setIsModalOpen] = React.useState(false);
      const [isImportModalOpen, setIsImportModalOpen] = React.useState(false);
      const [importPreview, setImportPreview] = React.useState([]);
      const [editingRole, setEditingRole] = React.useState(null);
      const [formData, setFormData] = React.useState({ name: '', daily_rate: '', department: '' });
      const [filterDept, setFilterDept] = React.useState('all');
      const [isDragging, setIsDragging] = React.useState(false);
      const [selectedRoles, setSelectedRoles] = React.useState([]);
      const [showInactive, setShowInactive] = React.useState(false);
      const [showHidden, setShowHidden] = React.useState(false);
      const fileInputRef = React.useRef(null);
      const dropZoneRef = React.useRef(null);

      const departments = ['PO', 'PM', 'BA', 'UXUI', 'FE', 'Mobile', 'BE', 'QA', 'SM', 'CMS', 'DA', 'Design'];

      React.useEffect(() => { setRoles(db.getRoles()); setTimeout(() => lucide.createIcons(), 0); }, []);

      // Filter roles based on department and status
      const filteredRoles = roles.filter(r => {
        if (filterDept !== 'all' && r.department !== filterDept) return false;
        if (!showInactive && r.status === 'inactive') return false;
        if (!showHidden && r.status === 'hidden') return false;
        return true;
      });
      const displayedRoles = filteredRoles;

      // Toggle role status
      const toggleRoleStatus = (roleId, newStatus) => {
        db.updateRoleStatus(roleId, newStatus);
        setRoles(db.getRoles());
        setTimeout(() => lucide.createIcons(), 0);
      };

      // Bulk actions
      const bulkAction = (action) => {
        if (selectedRoles.length === 0) return;
        if (action === 'delete') {
          if (!confirm(`Delete ${selectedRoles.length} roles? This cannot be undone.`)) return;
          selectedRoles.forEach(id => db.deleteRole(id));
        } else if (action === 'deactivate') {
          if (!confirm(`Deactivate ${selectedRoles.length} roles?`)) return;
          selectedRoles.forEach(id => db.updateRoleStatus(id, 'inactive'));
        } else if (action === 'activate') {
          selectedRoles.forEach(id => db.updateRoleStatus(id, 'active'));
        } else if (action === 'hide') {
          if (!confirm(`Hide ${selectedRoles.length} roles?`)) return;
          selectedRoles.forEach(id => db.updateRoleStatus(id, 'hidden'));
        } else if (action === 'unhide') {
          selectedRoles.forEach(id => db.updateRoleStatus(id, 'active'));
        }
        setSelectedRoles([]);
        setRoles(db.getRoles());
        onRefresh?.();
        setTimeout(() => lucide.createIcons(), 0);
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (editingRole) {
          db.updateRole(editingRole.id, formData.name, parseFloat(formData.daily_rate), formData.department);
        } else {
          db.createRole(formData.name, parseFloat(formData.daily_rate), formData.department);
        }
        setRoles(db.getRoles());
        setIsModalOpen(false);
        onRefresh?.();
      };

      const processFile = (file) => {
        if (!file || !file.name.endsWith('.csv')) {
          alert('Please upload a CSV file');
          return;
        }
        const reader = new FileReader();
        reader.onload = (evt) => {
          const text = evt.target.result;
          const lines = text.split('\n').filter(l => l.trim());
          const preview = [];
          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
            if (cols.length >= 2 && cols[0] && !isNaN(parseFloat(cols[1]))) {
              const rate = parseFloat(cols[1]);
              preview.push({ name: cols[0], daily_rate: rate, hourly_rate: Math.round((rate / 5) * 100) / 100, department: cols[2] || '' });
            }
          }
          if (preview.length > 0) {
            setImportPreview(preview);
            setIsImportModalOpen(true);
          } else {
            alert('No valid roles found in CSV');
          }
        };
        reader.readAsText(file);
      };

      const handleFileUpload = (e) => {
        processFile(e.target.files[0]);
        e.target.value = '';
      };

      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        const file = e.dataTransfer.files[0];
        processFile(file);
      };

      const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
      const handleDragLeave = (e) => { e.preventDefault(); setIsDragging(false); };

      const confirmImport = () => {
        importPreview.forEach(role => db.createRole(role.name, role.daily_rate, role.department));
        setRoles(db.getRoles());
        setIsImportModalOpen(false);
        setImportPreview([]);
        onRefresh?.();
      };

      const downloadTemplate = () => {
        const csv = 'Role Name,Daily Rate,Department\n' + DEFAULT_ROLES.map(r => `"${r.name}",${r.hourly_rate * 5},${r.department}`).join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'boud_roles_template.csv';
        link.click();
      };

      const loadDefaultRoles = () => {
        if (confirm(`This will add ${DEFAULT_ROLES.length} default roles to your list. Continue?`)) {
          DEFAULT_ROLES.forEach(role => db.createRole(role.name, role.hourly_rate * 5, role.department));
          setRoles(db.getRoles());
          onRefresh?.();
        }
      };

      return (
        <div>
          <div className="page-header">
            <div><h1 className="page-title">Role Rates</h1><p className="text-secondary">Manage daily rates for each role ({roles.length} roles) — 1 day = 5 hours</p></div>
            <div style={{display: 'flex', gap: 8}}>
              <button className="btn btn-secondary" onClick={loadDefaultRoles}>
                <i data-lucide="database" style={{width: 16, height: 16}}></i> Load Defaults (89)
              </button>
              <button className="btn btn-primary" onClick={() => { setEditingRole(null); setFormData({ name: '', daily_rate: '', department: '' }); setIsModalOpen(true); }}>
                <i data-lucide="plus" style={{width: 18, height: 18}}></i> Add Role
              </button>
            </div>
          </div>

          {/* Import Zone */}
          <div
            ref={dropZoneRef}
            onDrop={handleDrop}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onClick={() => fileInputRef.current?.click()}
            style={{
              border: `2px dashed ${isDragging ? 'var(--boud-purple)' : 'rgba(0,0,0,0.15)'}`,
              borderRadius: 12, padding: 24, marginBottom: 24, textAlign: 'center',
              background: isDragging ? 'rgba(94, 86, 222, 0.05)' : 'white',
              cursor: 'pointer', transition: 'all 0.2s ease'
            }}
          >
            <input type="file" ref={fileInputRef} accept=".csv" onChange={handleFileUpload} style={{display: 'none'}} />
            <i data-lucide="upload-cloud" style={{width: 40, height: 40, color: 'var(--boud-purple)', marginBottom: 12}}></i>
            <p style={{fontWeight: 600, margin: '0 0 4px 0'}}>Drag & drop CSV file here, or click to browse</p>
            <p className="text-secondary" style={{fontSize: 13, margin: 0}}>CSV format: Role Name, Daily Rate, Department</p>
            <div style={{marginTop: 16, display: 'flex', gap: 12, justifyContent: 'center'}}>
              <button className="btn btn-sm btn-secondary" onClick={(e) => { e.stopPropagation(); downloadTemplate(); }}>
                <i data-lucide="download" style={{width: 14, height: 14}}></i> Download Template (89 roles)
              </button>
            </div>
          </div>

          {/* Example Format */}
          <div className="card" style={{marginBottom: 24, padding: 16, background: 'rgba(94, 86, 222, 0.05)'}}>
            <h4 style={{margin: '0 0 12px 0', display: 'flex', alignItems: 'center', gap: 8}}>
              <i data-lucide="file-text" style={{width: 16, height: 16}}></i> CSV Format Example
            </h4>
            <div style={{background: '#1e1e1e', color: '#def763', padding: 16, borderRadius: 8, fontFamily: 'monospace', fontSize: 13, overflowX: 'auto'}}>
              <div style={{color: '#888'}}>// Header row (required)</div>
              <div>Role Name,Daily Rate,Department</div>
              <div style={{color: '#888', marginTop: 8}}>// Data rows (1 day = 5 hours)</div>
              <div>Senior Consultant - PM,2800,PM</div>
              <div>Consultant - BA,1500,BA</div>
              <div>Specialist - FE,400,FE</div>
            </div>
          </div>

          <div style={{marginBottom: 16, display: 'flex', gap: 8, flexWrap: 'wrap', alignItems: 'center'}}>
            <button className={`btn btn-sm ${filterDept === 'all' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setFilterDept('all')}>All ({roles.filter(r => r.status !== 'hidden').length})</button>
            {departments.map(dept => {
              const count = roles.filter(r => r.department === dept && r.status !== 'hidden').length;
              return count > 0 ? (
                <button key={dept} className={`btn btn-sm ${filterDept === dept ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setFilterDept(dept)}>{dept} ({count})</button>
              ) : null;
            })}
            <span style={{marginLeft: 'auto'}}></span>
            <label style={{display: 'flex', alignItems: 'center', gap: 6, fontSize: 13, cursor: 'pointer'}}>
              <input type="checkbox" checked={showInactive} onChange={e => setShowInactive(e.target.checked)} />
              Show Inactive
            </label>
            <label style={{display: 'flex', alignItems: 'center', gap: 6, fontSize: 13, cursor: 'pointer'}}>
              <input type="checkbox" checked={showHidden} onChange={e => setShowHidden(e.target.checked)} />
              Show Hidden
            </label>
          </div>

          {/* Bulk Actions Bar */}
          {selectedRoles.length > 0 && (
            <div style={{display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: 'rgba(94, 86, 222, 0.1)', borderRadius: 8, marginBottom: 16}}>
              <span style={{fontWeight: 600}}>{selectedRoles.length} selected</span>
              <button className="btn btn-sm btn-secondary" onClick={() => bulkAction('deactivate')}>
                <i data-lucide="pause-circle" style={{width: 14, height: 14}}></i> Deactivate
              </button>
              <button className="btn btn-sm btn-secondary" onClick={() => bulkAction('activate')}>
                <i data-lucide="play-circle" style={{width: 14, height: 14}}></i> Activate
              </button>
              <button className="btn btn-sm btn-secondary" onClick={() => bulkAction('hide')}>
                <i data-lucide="eye-off" style={{width: 14, height: 14}}></i> Hide
              </button>
              <button className="btn btn-sm btn-secondary" onClick={() => bulkAction('unhide')}>
                <i data-lucide="eye" style={{width: 14, height: 14}}></i> Unhide
              </button>
              <button className="btn btn-sm" style={{background: 'var(--error)', color: 'white'}} onClick={() => bulkAction('delete')}>
                <i data-lucide="trash-2" style={{width: 14, height: 14}}></i> Delete
              </button>
              <button className="btn btn-sm btn-secondary" onClick={() => setSelectedRoles([])} style={{marginLeft: 'auto'}}>
                Clear Selection
              </button>
            </div>
          )}

          <div className="card">
            <table>
              <thead>
                <tr>
                  <th style={{width: 40}}>
                    <input type="checkbox" checked={selectedRoles.length === displayedRoles.length && displayedRoles.length > 0} onChange={e => setSelectedRoles(e.target.checked ? displayedRoles.map(r => r.id) : [])} />
                  </th>
                  <th>Role Name</th>
                  <th>Department</th>
                  <th>Daily Rate</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {displayedRoles.length === 0 ? (
                  <tr><td colSpan={6} style={{textAlign: 'center', padding: 32}} className="text-secondary">
                    No roles yet. Click "Load Defaults" to add 89 pre-configured roles, or import your own CSV.
                  </td></tr>
                ) : displayedRoles.map(role => (
                  <tr key={role.id} style={{opacity: role.status === 'inactive' || role.status === 'hidden' ? 0.5 : 1}}>
                    <td>
                      <input type="checkbox" checked={selectedRoles.includes(role.id)} onChange={e => {
                        if (e.target.checked) setSelectedRoles([...selectedRoles, role.id]);
                        else setSelectedRoles(selectedRoles.filter(id => id !== role.id));
                      }} />
                    </td>
                    <td style={{fontWeight: 500}}>{role.name}</td>
                    <td><span className="badge badge-info" style={{background: 'rgba(94, 86, 222, 0.15)', color: 'var(--boud-purple)'}}>{role.department || '-'}</span></td>
                    <td style={{color: 'var(--boud-purple)', fontWeight: 600}}>{formatCurrency(role.daily_rate || role.hourly_rate * 5)}/day <span style={{fontSize: 11, color: 'var(--gray-text)'}}>({formatCurrency(role.hourly_rate)}/hr)</span></td>
                    <td>
                      {role.status === 'inactive' && <span className="badge" style={{background: 'rgba(251, 191, 36, 0.2)', color: '#b45309'}}>Inactive</span>}
                      {role.status === 'hidden' && <span className="badge" style={{background: 'rgba(156, 163, 175, 0.2)', color: '#6b7280'}}>Hidden</span>}
                      {(!role.status || role.status === 'active') && <span className="badge" style={{background: 'rgba(74, 222, 128, 0.2)', color: '#15803d'}}>Active</span>}
                    </td>
                    <td>
                      <div className="actions">
                        <button className="btn btn-icon btn-sm" onClick={() => { setEditingRole(role); setFormData({ name: role.name, daily_rate: (role.daily_rate || role.hourly_rate * 5).toString(), department: role.department || '' }); setIsModalOpen(true); }} title="Edit"><i data-lucide="edit-2" style={{width: 16, height: 16}}></i></button>
                        <button className="btn btn-icon btn-sm" onClick={() => toggleRoleStatus(role.id, role.status === 'inactive' ? 'active' : 'inactive')} title={role.status === 'inactive' ? 'Activate' : 'Deactivate'}>
                          <i data-lucide={role.status === 'inactive' ? 'play-circle' : 'pause-circle'} style={{width: 16, height: 16, color: role.status === 'inactive' ? 'var(--success)' : 'var(--warning)'}}></i>
                        </button>
                        <button className="btn btn-icon btn-sm" onClick={() => toggleRoleStatus(role.id, role.status === 'hidden' ? 'active' : 'hidden')} title={role.status === 'hidden' ? 'Unhide' : 'Hide'}>
                          <i data-lucide={role.status === 'hidden' ? 'eye' : 'eye-off'} style={{width: 16, height: 16}}></i>
                        </button>
                        <button className="btn btn-icon btn-sm" onClick={() => { if (confirm('Delete this role?')) { db.deleteRole(role.id); setRoles(db.getRoles()); setSelectedRoles(selectedRoles.filter(id => id !== role.id)); } }} style={{color: 'var(--error)'}} title="Delete"><i data-lucide="trash-2" style={{width: 16, height: 16}}></i></button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Add/Edit Role Modal */}
          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>{editingRole ? 'Edit Role' : 'Add Role'}</h3><button className="btn btn-icon" onClick={() => setIsModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <form onSubmit={handleSubmit}>
                  <div className="modal-body">
                    <div className="form-group"><label className="form-label">Role Name</label><input type="text" className="form-input" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required placeholder="e.g. Senior Consultant - PM" /></div>
                    <div className="form-row">
                      <div className="form-group"><label className="form-label">Daily Rate (SAR) — 1 day = 5 hrs</label><input type="number" step="0.01" className="form-input" value={formData.daily_rate} onChange={e => setFormData({...formData, daily_rate: e.target.value})} required /></div>
                      <div className="form-group"><label className="form-label">Department</label>
                        <select className="form-select" value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})}>
                          <option value="">Select...</option>
                          {departments.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                      </div>
                    </div>
                  </div>
                  <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={() => setIsModalOpen(false)}>Cancel</button><button type="submit" className="btn btn-primary">Save</button></div>
                </form>
              </div>
            </div>
          )}

          {/* Import Confirmation Modal */}
          {isImportModalOpen && (
            <div className="modal-overlay" onClick={() => setIsImportModalOpen(false)}>
              <div className="modal" style={{maxWidth: 600}} onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                  <h3>Confirm Import</h3>
                  <button className="btn btn-icon" onClick={() => setIsImportModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button>
                </div>
                <div className="modal-body">
                  <div style={{padding: 16, background: 'rgba(222, 247, 99, 0.2)', borderRadius: 8, marginBottom: 16}}>
                    <p style={{fontWeight: 600, margin: 0}}><i data-lucide="alert-circle" style={{width: 16, height: 16, display: 'inline', verticalAlign: 'middle', marginRight: 8}}></i>You are about to import {importPreview.length} roles</p>
                    <p className="text-secondary" style={{margin: '8px 0 0 0', fontSize: 13}}>These roles will be added to your existing roles and can be used immediately in project pricing.</p>
                  </div>
                  <div style={{maxHeight: 300, overflowY: 'auto'}}>
                    <table style={{fontSize: 13}}>
                      <thead><tr><th>Role Name</th><th>Department</th><th>Daily Rate</th></tr></thead>
                      <tbody>
                        {importPreview.slice(0, 20).map((role, i) => (
                          <tr key={i}>
                            <td>{role.name}</td>
                            <td>{role.department || '-'}</td>
                            <td>{formatCurrency(role.daily_rate || role.hourly_rate * 5)}/day</td>
                          </tr>
                        ))}
                        {importPreview.length > 20 && <tr><td colSpan={3} className="text-secondary" style={{textAlign: 'center'}}>...and {importPreview.length - 20} more</td></tr>}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div className="modal-footer">
                  <button className="btn btn-secondary" onClick={() => setIsImportModalOpen(false)}>Cancel</button>
                  <button className="btn btn-primary" onClick={confirmImport}><i data-lucide="check" style={{width: 16, height: 16}}></i> Confirm Import</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const ToolsManagement = ({ onRefresh }) => {
      const [tools, setTools] = React.useState([]);
      React.useEffect(() => { setTools(db.getTools()); lucide.createIcons(); }, []);
      return (
        <div>
          <div className="page-header"><div><h1 className="page-title">Tools & Subscriptions</h1><p className="text-secondary">Manage costs for tools and services</p></div></div>
          <div className="card">
            <table>
              <thead><tr><th>Name</th><th>Type</th><th>Cost</th><th>Description</th></tr></thead>
              <tbody>
                {tools.map(tool => (
                  <tr key={tool.id}>
                    <td style={{fontWeight: 500}}>{tool.name}</td>
                    <td><span className="badge badge-info">{tool.cost_type}</span></td>
                    <td style={{color: 'var(--boud-dark)', fontWeight: 600}}>{formatCurrency(tool.cost)}</td>
                    <td className="text-secondary">{tool.description || '-'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    // User Management
    const UserManagement = ({ onRefresh }) => {
      const [users, setUsers] = React.useState([]);
      const [isModalOpen, setIsModalOpen] = React.useState(false);
      const [editingUser, setEditingUser] = React.useState(null);
      const [form, setForm] = React.useState({ name: '', email: '', role: 'bd_user' });
      const currentUser = db.getCurrentUser();

      const loadData = () => {
        setUsers(db.getUsers());
        setTimeout(() => lucide.createIcons(), 0);
      };
      React.useEffect(() => { loadData(); }, []);

      if (!db.hasPermission('manage_users')) {
        return <div className="card" style={{textAlign: 'center', padding: 40}}><p>You do not have permission to manage users.</p></div>;
      }

      const handleSave = () => {
        const rolePreset = ROLE_PRESETS[form.role];
        if (editingUser) {
          db.updateUser(editingUser.id, { name: form.name, email: form.email, role: form.role, permissions: { ...rolePreset.permissions } });
        } else {
          db.addUser({ name: form.name, email: form.email, role: form.role });
        }
        setIsModalOpen(false); setEditingUser(null);
        setForm({ name: '', email: '', role: 'bd_user' });
        loadData();
      };

      const getRoleBadgeColor = (role) => {
        const colors = { super_admin: 'badge-red', admin: 'badge-purple', manager: 'badge-yellow', bd_user: 'badge-green', operator: '', finance: 'badge-purple', collections: 'badge-yellow' };
        return colors[role] || '';
      };

      return (
        <div>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24}}>
            <h1 className="page-title">User Management</h1>
            <button className="btn btn-primary" onClick={() => { setEditingUser(null); setForm({ name: '', email: '', role: 'bd_user' }); setIsModalOpen(true); }}>
              <i data-lucide="user-plus" style={{width: 16, height: 16}}></i> Add User
            </button>
          </div>

          {/* Current user indicator */}
          {currentUser && (
            <div className="card" style={{marginBottom: 16, padding: 12, display: 'flex', alignItems: 'center', gap: 12, background: 'rgba(94,86,222,0.08)'}}>
              <div style={{width: 36, height: 36, borderRadius: '50%', background: 'var(--boud-purple)', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 700, fontSize: 14}}>
                {currentUser.name.charAt(0).toUpperCase()}
              </div>
              <div style={{flex: 1}}>
                <div style={{fontWeight: 600, fontSize: 14}}>Logged in as: {currentUser.name}</div>
                <div style={{fontSize: 12, color: 'var(--text-secondary)'}}>{ROLE_PRESETS[currentUser.role]?.label || currentUser.role}</div>
              </div>
            </div>
          )}

          {/* User list */}
          <div style={{display: 'grid', gap: 8}}>
            {users.map(user => (
              <div key={user.id} className="card" style={{padding: 14, display: 'flex', alignItems: 'center', gap: 12, border: user.id === dbState.currentUserId ? '2px solid var(--boud-purple)' : undefined}}>
                <div style={{width: 40, height: 40, borderRadius: '50%', background: user.id === dbState.currentUserId ? 'var(--boud-purple)' : 'var(--bg-secondary)', color: user.id === dbState.currentUserId ? 'white' : 'var(--text-primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 700, fontSize: 16}}>
                  {user.name.charAt(0).toUpperCase()}
                </div>
                <div style={{flex: 1}}>
                  <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                    <span style={{fontWeight: 600}}>{user.name}</span>
                    <span className={`badge ${getRoleBadgeColor(user.role)}`} style={{fontSize: 10}}>{ROLE_PRESETS[user.role]?.label || user.role}</span>
                    {user.id === dbState.currentUserId && <span className="badge badge-green" style={{fontSize: 10}}>Current</span>}
                  </div>
                  <div style={{fontSize: 12, color: 'var(--text-secondary)'}}>{user.email}</div>
                </div>
                <div className="actions" style={{display: 'flex', gap: 4}}>
                  {user.id !== dbState.currentUserId && (
                    <button className="btn btn-sm btn-secondary" onClick={() => { db.setCurrentUser(user.id); loadData(); }}>
                      Switch
                    </button>
                  )}
                  <button className="btn btn-icon btn-sm" onClick={() => { setEditingUser(user); setForm({ name: user.name, email: user.email, role: user.role }); setIsModalOpen(true); }}>
                    <i data-lucide="edit-2" style={{width: 14, height: 14}}></i>
                  </button>
                  {user.role !== 'super_admin' && (
                    <button className="btn btn-icon btn-sm" onClick={() => { if (confirm(`Deactivate ${user.name}?`)) { db.deactivateUser(user.id); loadData(); } }} style={{color: 'var(--error)'}}>
                      <i data-lucide="user-x" style={{width: 14, height: 14}}></i>
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* Permission Matrix */}
          {users.length > 0 && (
            <div style={{marginTop: 24}}>
              <h3 style={{marginBottom: 12}}>Permission Matrix</h3>
              <div style={{overflowX: 'auto'}}>
                <table style={{fontSize: 12}}>
                  <thead>
                    <tr>
                      <th>User</th>
                      {Object.entries(PERMISSIONS).map(([key, label]) => (
                        <th key={key} style={{textAlign: 'center', fontSize: 10, padding: '8px 4px', maxWidth: 60, whiteSpace: 'normal'}}>{label}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {users.map(user => (
                      <tr key={user.id}>
                        <td style={{fontWeight: 500, whiteSpace: 'nowrap'}}>{user.name}</td>
                        {Object.keys(PERMISSIONS).map(perm => (
                          <td key={perm} style={{textAlign: 'center'}}>
                            <input type="checkbox" checked={user.permissions?.[perm] || false}
                              onChange={e => {
                                const updated = { ...user.permissions, [perm]: e.target.checked };
                                db.updateUser(user.id, { permissions: updated });
                                loadData();
                              }}
                              disabled={user.role === 'super_admin'}
                              style={{cursor: user.role === 'super_admin' ? 'not-allowed' : 'pointer'}}
                            />
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Add/Edit User Modal */}
          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="modal" style={{maxWidth: 450}} onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>{editingUser ? 'Edit User' : 'Add User'}</h3><button className="btn btn-icon" onClick={() => setIsModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <div className="modal-body">
                  <div className="form-group"><label className="form-label">Name *</label><input type="text" className="form-input" value={form.name} onChange={e => setForm({...form, name: e.target.value})} /></div>
                  <div className="form-group"><label className="form-label">Email *</label><input type="email" className="form-input" value={form.email} onChange={e => setForm({...form, email: e.target.value})} /></div>
                  <div className="form-group">
                    <label className="form-label">Role *</label>
                    <select className="form-input" value={form.role} onChange={e => setForm({...form, role: e.target.value})}>
                      {Object.entries(ROLE_PRESETS).map(([key, preset]) => (
                        <option key={key} value={key}>{preset.label}</option>
                      ))}
                    </select>
                  </div>
                </div>
                <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setIsModalOpen(false)}>Cancel</button><button className="btn btn-primary" disabled={!form.name || !form.email} onClick={handleSave}>Save</button></div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Credits & Packages Management
    const CreditsAndPackages = ({ onRefresh }) => {
      const [activeTab, setActiveTab] = React.useState('definitions');
      const [creditDefs, setCreditDefs] = React.useState([]);
      const [packages, setPackages] = React.useState([]);
      const [agreements, setAgreements] = React.useState([]);
      const [isModalOpen, setIsModalOpen] = React.useState(false);
      const [editingItem, setEditingItem] = React.useState(null);
      const [form, setForm] = React.useState({ name: '', type: 'monetary', sar_value: '', unit_label: '' });
      const [isPkgModalOpen, setIsPkgModalOpen] = React.useState(false);
      const [pkgForm, setPkgForm] = React.useState({ name: '', price_sar: '', credit_bundle: [], included_services: [] });
      const [editingPkg, setEditingPkg] = React.useState(null);

      const loadData = () => {
        setCreditDefs(db.getAllCreditDefinitions().filter(cd => cd.is_active));
        setPackages(db.getPackages());
        setAgreements(db.getClientAgreements());
        setTimeout(() => lucide.createIcons(), 0);
      };
      React.useEffect(() => { loadData(); }, []);

      const CREDIT_TYPES = [
        { value: 'monetary', label: 'Monetary (SAR)', color: 'var(--boud-purple)' },
        { value: 'usage', label: 'Usage-Based', color: 'var(--boud-orange)' },
        { value: 'operational', label: 'Operational', color: 'var(--success)' }
      ];

      const handleSaveCreditDef = () => {
        const data = { name: form.name, type: form.type, sar_value: parseFloat(form.sar_value) || 0, unit_label: form.unit_label || form.name };
        if (editingItem) { db.updateCreditDefinition(editingItem.id, data); }
        else { db.addCreditDefinition(data); }
        setIsModalOpen(false); setEditingItem(null);
        setForm({ name: '', type: 'monetary', sar_value: '', unit_label: '' });
        loadData();
      };

      const handleEditCreditDef = (cd) => {
        setEditingItem(cd);
        setForm({ name: cd.name, type: cd.type, sar_value: cd.sar_value.toString(), unit_label: cd.unit_label || '' });
        setIsModalOpen(true);
      };

      const handleSavePackage = () => {
        const data = {
          name: pkgForm.name,
          price_sar: parseFloat(pkgForm.price_sar) || 0,
          credit_bundle: pkgForm.credit_bundle,
          included_services: pkgForm.included_services
        };
        if (editingPkg) { db.updatePackage(editingPkg.id, data); }
        else { db.addPackage(data); }
        setIsPkgModalOpen(false); setEditingPkg(null);
        setPkgForm({ name: '', price_sar: '', credit_bundle: [], included_services: [] });
        loadData();
      };

      const getTypeColor = (type) => {
        const t = CREDIT_TYPES.find(ct => ct.value === type);
        return t ? t.color : 'var(--gray-text)';
      };

      return (
        <div>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24}}>
            <h1 className="page-title">Credits & Packages</h1>
          </div>

          <div className="tabs" style={{marginBottom: 20}}>
            <button className={`tab ${activeTab === 'definitions' ? 'active' : ''}`} onClick={() => setActiveTab('definitions')}>Credit Types</button>
            <button className={`tab ${activeTab === 'packages' ? 'active' : ''}`} onClick={() => setActiveTab('packages')}>
              Hackify Packages {packages.length > 0 && <span className="badge badge-purple" style={{marginLeft: 6, fontSize: 11}}>{packages.length}</span>}
            </button>
            <button className={`tab ${activeTab === 'agreements' ? 'active' : ''}`} onClick={() => setActiveTab('agreements')}>
              Client Agreements {agreements.length > 0 && <span className="badge badge-green" style={{marginLeft: 6, fontSize: 11}}>{agreements.length}</span>}
            </button>
          </div>

          {/* Credit Definitions Tab */}
          {activeTab === 'definitions' && (
            <div>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16}}>
                <p className="text-secondary">{creditDefs.length} credit types defined</p>
                <button className="btn btn-primary btn-sm" onClick={() => { setEditingItem(null); setForm({ name: '', type: 'monetary', sar_value: '', unit_label: '' }); setIsModalOpen(true); }}>
                  <i data-lucide="plus" style={{width: 14, height: 14}}></i> Add Credit Type
                </button>
              </div>
              <div style={{display: 'grid', gap: 12}}>
                {creditDefs.map(cd => (
                  <div key={cd.id} className="card" style={{padding: 16}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <div style={{display: 'flex', alignItems: 'center', gap: 12}}>
                        <div style={{width: 40, height: 40, borderRadius: 10, background: `${getTypeColor(cd.type)}20`, display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                          <i data-lucide={cd.type === 'monetary' ? 'banknote' : cd.type === 'usage' ? 'activity' : 'headphones'} style={{width: 20, height: 20, color: getTypeColor(cd.type)}}></i>
                        </div>
                        <div>
                          <div style={{fontWeight: 600}}>{cd.name}</div>
                          <div style={{fontSize: 12, color: 'var(--text-secondary)'}}>
                            <span className="badge" style={{background: `${getTypeColor(cd.type)}20`, color: getTypeColor(cd.type), fontSize: 10, marginRight: 6}}>{cd.type}</span>
                            {cd.unit_label} — {formatCurrency(cd.sar_value)} per unit
                          </div>
                        </div>
                      </div>
                      <div className="actions">
                        <button className="btn btn-icon btn-sm" onClick={() => handleEditCreditDef(cd)}><i data-lucide="edit-2" style={{width: 14, height: 14}}></i></button>
                        <button className="btn btn-icon btn-sm" onClick={() => { db.deleteCreditDefinition(cd.id); loadData(); }} style={{color: 'var(--error)'}}><i data-lucide="trash-2" style={{width: 14, height: 14}}></i></button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Packages Tab */}
          {activeTab === 'packages' && (
            <div>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16}}>
                <p className="text-secondary">Hackify productized packages</p>
                <button className="btn btn-primary btn-sm" onClick={() => {
                  setEditingPkg(null);
                  setPkgForm({ name: '', price_sar: '', credit_bundle: creditDefs.map(cd => ({ credit_def_id: cd.id, quantity: 0 })), included_services: [] });
                  setIsPkgModalOpen(true);
                }}>
                  <i data-lucide="plus" style={{width: 14, height: 14}}></i> Add Package
                </button>
              </div>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: 16}}>
                {packages.map(pkg => {
                  const totalCreditValue = (pkg.credit_bundle || []).reduce((sum, cb) => {
                    const cd = creditDefs.find(c => c.id === cb.credit_def_id);
                    return sum + (cd ? cd.sar_value * cb.quantity : 0);
                  }, 0);
                  return (
                    <div key={pkg.id} className="card" style={{padding: 0, overflow: 'hidden'}}>
                      <div style={{background: 'var(--boud-purple)', color: 'white', padding: '16px 20px'}}>
                        <h3 style={{margin: 0, fontSize: 18}}>{pkg.name}</h3>
                        <div style={{fontSize: 24, fontWeight: 700, marginTop: 4}}>{formatCurrency(pkg.price_sar)}</div>
                        {totalCreditValue > 0 && (
                          <div style={{fontSize: 12, opacity: 0.8, marginTop: 4}}>Credit value: {formatCurrency(totalCreditValue)} ({totalCreditValue > pkg.price_sar ? 'Premium' : Math.round((1 - pkg.price_sar / totalCreditValue) * 100) + '% savings'})</div>
                        )}
                      </div>
                      <div style={{padding: '16px 20px'}}>
                        <h4 style={{fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--gray-text)', marginBottom: 8}}>Credit Bundle</h4>
                        {(pkg.credit_bundle || []).filter(cb => cb.quantity > 0).map(cb => {
                          const cd = creditDefs.find(c => c.id === cb.credit_def_id);
                          return cd ? (
                            <div key={cb.credit_def_id} style={{display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: 13}}>
                              <span>{cd.name}</span>
                              <span style={{fontWeight: 600}}>{cb.quantity.toLocaleString()} {cd.unit_label}</span>
                            </div>
                          ) : null;
                        })}
                        <h4 style={{fontSize: 13, textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--gray-text)', marginBottom: 8, marginTop: 12}}>Included Services</h4>
                        {(pkg.included_services || []).map((svc, i) => (
                          <div key={i} style={{display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: 13}}>
                            <span>{svc.service_name}</span>
                            <span className="text-secondary">{svc.credit_allocation} credits</span>
                          </div>
                        ))}
                        <div style={{display: 'flex', gap: 8, marginTop: 12}}>
                          <button className="btn btn-sm btn-secondary" onClick={() => {
                            setEditingPkg(pkg);
                            setPkgForm({ name: pkg.name, price_sar: pkg.price_sar.toString(), credit_bundle: pkg.credit_bundle || [], included_services: pkg.included_services || [] });
                            setIsPkgModalOpen(true);
                          }}>Edit</button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Agreements Tab */}
          {activeTab === 'agreements' && (
            <div>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16}}>
                <p className="text-secondary">{agreements.length} client agreements</p>
                <button className="btn btn-primary btn-sm" onClick={() => {
                  const name = prompt('Client name:');
                  if (name) {
                    db.addClientAgreement({
                      client_name: name,
                      project_id: null,
                      credit_pool: creditDefs.map(cd => ({ credit_def_id: cd.id, allocated: 0, consumed: 0, remaining: 0 })),
                      expiry_date: null,
                      is_transferable: false
                    });
                    loadData();
                  }
                }}>
                  <i data-lucide="plus" style={{width: 14, height: 14}}></i> Add Agreement
                </button>
              </div>
              {agreements.length === 0 ? (
                <div className="card" style={{textAlign: 'center', padding: 32}}>
                  <i data-lucide="handshake" style={{width: 40, height: 40, color: 'var(--gray-text)', marginBottom: 12}}></i>
                  <p className="text-secondary">No client agreements yet. Create one to start tracking credit allocation.</p>
                </div>
              ) : (
                <div style={{display: 'grid', gap: 12}}>
                  {agreements.map(agmt => {
                    const totalAllocated = agmt.credit_pool.reduce((s, cp) => s + cp.allocated, 0);
                    const totalConsumed = agmt.credit_pool.reduce((s, cp) => s + cp.consumed, 0);
                    const pct = totalAllocated > 0 ? Math.round(totalConsumed / totalAllocated * 100) : 0;
                    return (
                      <div key={agmt.id} className="card" style={{padding: 16}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                          <h3 style={{margin: 0, fontSize: 16}}>{agmt.client_name}</h3>
                          <span className="text-secondary" style={{fontSize: 12}}>{new Date(agmt.created_at).toLocaleDateString()}</span>
                        </div>
                        {totalAllocated > 0 && (
                          <div style={{marginBottom: 8}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: 12, marginBottom: 4}}>
                              <span>Utilization</span><span style={{fontWeight: 600}}>{pct}%</span>
                            </div>
                            <div style={{height: 6, background: 'var(--bg-secondary)', borderRadius: 3, overflow: 'hidden'}}>
                              <div style={{height: '100%', width: `${pct}%`, background: pct > 80 ? 'var(--error)' : pct > 50 ? 'var(--warning)' : 'var(--success)', borderRadius: 3, transition: 'width 0.3s'}}></div>
                            </div>
                          </div>
                        )}
                        <div style={{display: 'flex', flexWrap: 'wrap', gap: 8}}>
                          {agmt.credit_pool.filter(cp => cp.allocated > 0).map(cp => {
                            const cd = creditDefs.find(c => c.id === cp.credit_def_id);
                            return cd ? (
                              <div key={cp.credit_def_id} style={{padding: '4px 8px', borderRadius: 6, fontSize: 11, background: 'var(--bg-secondary)'}}>
                                {cd.name}: {cp.consumed}/{cp.allocated}
                              </div>
                            ) : null;
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* Credit Definition Modal */}
          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="modal" style={{maxWidth: 450}} onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>{editingItem ? 'Edit Credit Type' : 'Add Credit Type'}</h3><button className="btn btn-icon" onClick={() => setIsModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <div className="modal-body">
                  <div className="form-group"><label className="form-label">Name *</label><input type="text" className="form-input" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="e.g., Design Hour, API Call" /></div>
                  <div className="form-group">
                    <label className="form-label">Type *</label>
                    <select className="form-input" value={form.type} onChange={e => setForm({...form, type: e.target.value})}>
                      {CREDIT_TYPES.map(t => <option key={t.value} value={t.value}>{t.label}</option>)}
                    </select>
                  </div>
                  <div className="form-group"><label className="form-label">SAR Value per Unit *</label><input type="number" className="form-input" value={form.sar_value} onChange={e => setForm({...form, sar_value: e.target.value})} placeholder="e.g., 500" /></div>
                  <div className="form-group"><label className="form-label">Unit Label</label><input type="text" className="form-input" value={form.unit_label} onChange={e => setForm({...form, unit_label: e.target.value})} placeholder="e.g., API Call, Design Hour" /></div>
                </div>
                <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setIsModalOpen(false)}>Cancel</button><button className="btn btn-primary" disabled={!form.name || !form.sar_value} onClick={handleSaveCreditDef}>Save</button></div>
              </div>
            </div>
          )}

          {/* Package Modal */}
          {isPkgModalOpen && (
            <div className="modal-overlay" onClick={() => setIsPkgModalOpen(false)}>
              <div className="modal" style={{maxWidth: 600}} onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>{editingPkg ? 'Edit Package' : 'Add Package'}</h3><button className="btn btn-icon" onClick={() => setIsPkgModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <div className="modal-body">
                  <div className="form-row">
                    <div className="form-group"><label className="form-label">Package Name *</label><input type="text" className="form-input" value={pkgForm.name} onChange={e => setPkgForm({...pkgForm, name: e.target.value})} placeholder="e.g., Hackify Basic" /></div>
                    <div className="form-group"><label className="form-label">Price (SAR) *</label><input type="number" className="form-input" value={pkgForm.price_sar} onChange={e => setPkgForm({...pkgForm, price_sar: e.target.value})} /></div>
                  </div>
                  <h4 style={{marginTop: 16, marginBottom: 8}}>Credit Bundle</h4>
                  {creditDefs.map(cd => {
                    const existing = pkgForm.credit_bundle.find(cb => cb.credit_def_id === cd.id);
                    return (
                      <div key={cd.id} style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8}}>
                        <span style={{flex: 1, fontSize: 13}}>{cd.name} ({formatCurrency(cd.sar_value)}/unit)</span>
                        <input type="number" className="form-input" style={{width: 100}} value={existing?.quantity || ''} placeholder="0"
                          onChange={e => {
                            const qty = parseInt(e.target.value) || 0;
                            const updated = pkgForm.credit_bundle.filter(cb => cb.credit_def_id !== cd.id);
                            if (qty > 0) updated.push({ credit_def_id: cd.id, quantity: qty });
                            setPkgForm({...pkgForm, credit_bundle: updated});
                          }}
                        />
                      </div>
                    );
                  })}
                  <h4 style={{marginTop: 16, marginBottom: 8}}>Included Services</h4>
                  {(pkgForm.included_services || []).map((svc, i) => (
                    <div key={i} style={{display: 'flex', gap: 8, marginBottom: 8}}>
                      <input type="text" className="form-input" style={{flex: 1}} value={svc.service_name} placeholder="Service name"
                        onChange={e => {
                          const updated = [...pkgForm.included_services];
                          updated[i] = {...updated[i], service_name: e.target.value};
                          setPkgForm({...pkgForm, included_services: updated});
                        }}
                      />
                      <input type="number" className="form-input" style={{width: 80}} value={svc.credit_allocation} placeholder="Credits"
                        onChange={e => {
                          const updated = [...pkgForm.included_services];
                          updated[i] = {...updated[i], credit_allocation: parseInt(e.target.value) || 0};
                          setPkgForm({...pkgForm, included_services: updated});
                        }}
                      />
                      <button className="btn btn-icon btn-sm" onClick={() => {
                        setPkgForm({...pkgForm, included_services: pkgForm.included_services.filter((_, idx) => idx !== i)});
                      }} style={{color: 'var(--error)'}}><i data-lucide="x" style={{width: 14, height: 14}}></i></button>
                    </div>
                  ))}
                  <button className="btn btn-sm btn-secondary" onClick={() => setPkgForm({...pkgForm, included_services: [...(pkgForm.included_services || []), { service_name: '', credit_allocation: 0 }]})}>
                    <i data-lucide="plus" style={{width: 12, height: 12}}></i> Add Service
                  </button>
                </div>
                <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setIsPkgModalOpen(false)}>Cancel</button><button className="btn btn-primary" disabled={!pkgForm.name || !pkgForm.price_sar} onClick={handleSavePackage}>Save Package</button></div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const ProjectsList = ({ onNavigate, refreshKey, onRefresh }) => {
      const [projects, setProjects] = React.useState([]);
      const [isModalOpen, setIsModalOpen] = React.useState(false);
      const [formData, setFormData] = React.useState({ name: '', client: '', duration_weeks: '', target_margin: '30', pricing_models: ['hourly'], risk_margin: '0' });

      React.useEffect(() => {
        const list = db.getProjects().map(p => ({ ...p, ...db.calculateProjectTotals(p.id) }));
        setProjects(list);
        setTimeout(() => lucide.createIcons(), 0);
      }, [refreshKey]);

      const handleSubmit = (e) => {
        e.preventDefault();
        const id = db.createProject({
          name: formData.name,
          client: formData.client,
          duration_weeks: formData.duration_weeks ? parseInt(formData.duration_weeks) : null,
          target_margin: parseFloat(formData.target_margin),
          pricing_models: formData.pricing_models,
          risk_margin: parseFloat(formData.risk_margin) || 0
        });
        setIsModalOpen(false);
        onNavigate('project-pricing', id);
      };

      return (
        <div>
          <div className="page-header">
            <div><h1 className="page-title">Projects</h1><p className="text-secondary">Create and manage pricing models</p></div>
            <button className="btn btn-primary" onClick={() => setIsModalOpen(true)}><i data-lucide="plus" style={{width: 18, height: 18}}></i> New Project</button>
          </div>
          {projects.length === 0 ? (
            <div className="card"><div className="empty-state"><p>No projects yet.</p><button className="btn btn-primary" onClick={() => setIsModalOpen(true)} style={{marginTop: 16}}>Create Project</button></div></div>
          ) : (
            <div style={{display: 'grid', gap: 16}}>
              {projects.map(p => (
                <div key={p.id} className="card" style={{cursor: 'pointer'}} onClick={() => onNavigate('project-pricing', p.id)}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                    <div>
                      <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                        <h3 style={{margin: 0}}>{p.name}</h3>
                        <span className={`badge ${p.status === 'approved' ? 'badge-green' : p.status === 'pending_approval' ? 'badge-yellow' : 'badge-purple'}`} style={{fontSize: 10}}>
                          {p.status === 'approved' ? 'Approved' : p.status === 'pending_approval' ? 'Pending' : 'Draft'}
                        </span>
                        {p.riskMarginPercent > 0 && (
                          <span style={{display: 'inline-flex', alignItems: 'center', gap: 4, padding: '2px 8px', borderRadius: 100, fontSize: 11, fontWeight: 500, background: 'rgba(94, 86, 222, 0.15)', color: 'var(--boud-purple)'}}>
                            <i data-lucide="shield" style={{width: 12, height: 12}}></i>
                            {p.riskMarginPercent}% Risk
                          </span>
                        )}
                        {p.discountPercent > 0 && (
                          <span style={{display: 'inline-flex', alignItems: 'center', gap: 4, padding: '2px 8px', borderRadius: 100, fontSize: 11, fontWeight: 500, background: 'rgba(228, 106, 23, 0.15)', color: 'var(--boud-orange)'}}>
                            <i data-lucide="tag" style={{width: 12, height: 12}}></i>
                            {p.discountPercent}% Off
                          </span>
                        )}
                      </div>
                      <p className="text-secondary" style={{margin: '4px 0 0'}}>{p.client || 'No client'} • {p.duration_weeks ? `${p.duration_weeks} weeks` : 'No duration'}</p>
                    </div>
                    <div style={{display: 'flex', gap: 24, alignItems: 'center'}}>
                      <div style={{textAlign: 'right'}}><div style={{fontSize: 12, color: 'var(--gray-text)'}}>Cost</div><div style={{fontWeight: 500}}>{formatCurrency(p.totalCost)}</div></div>
                      <div style={{textAlign: 'right'}}><div style={{fontSize: 12, color: 'var(--gray-text)'}}>Price</div><div style={{fontSize: 18, fontWeight: 700, color: 'var(--boud-purple)'}}>{formatCurrency(p.sellingPrice)}</div></div>
                      <div style={{textAlign: 'right'}}><div style={{fontSize: 12, color: 'var(--gray-text)'}}>Margin</div><div style={{fontWeight: 600, color: p.actualMargin >= 25 ? 'var(--success)' : p.actualMargin >= 15 ? '#d39e00' : 'var(--error)'}}>{p.actualMargin.toFixed(1)}%</div></div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-header"><h3>Create Project</h3><button className="btn btn-icon" onClick={() => setIsModalOpen(false)}><i data-lucide="x" style={{width: 20, height: 20}}></i></button></div>
                <form onSubmit={handleSubmit}>
                  <div className="modal-body">
                    <div className="form-group"><label className="form-label">Project Name *</label><input type="text" className="form-input" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required /></div>
                    <div className="form-group"><label className="form-label">Client</label><input type="text" className="form-input" value={formData.client} onChange={e => setFormData({...formData, client: e.target.value})} /></div>
                    <div className="form-row">
                      <div className="form-group"><label className="form-label">Duration (weeks)</label><input type="number" className="form-input" value={formData.duration_weeks} onChange={e => setFormData({...formData, duration_weeks: e.target.value})} /></div>
                      <div className="form-group"><label className="form-label">Target Margin (%)</label><input type="number" className="form-input" value={formData.target_margin} onChange={e => setFormData({...formData, target_margin: e.target.value})} /></div>
                    </div>
                    <div className="form-group"><label className="form-label">Risk Buffer (%)</label><input type="number" className="form-input" value={formData.risk_margin} onChange={e => setFormData({...formData, risk_margin: e.target.value})} placeholder="0" /></div>
                  </div>
                  <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={() => setIsModalOpen(false)}>Cancel</button><button type="submit" className="btn btn-primary">Create & Configure</button></div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    };

    const Insights = ({ refreshKey }) => {
      const [stats, setStats] = React.useState({ totalProjects: 0, pipelineValue: 0, totalProfit: 0, avgMargin: 0 });
      const [projectMargins, setProjectMargins] = React.useState([]);
      const [deptMargins, setDeptMargins] = React.useState([]);
      const [boqCategories, setBoqCategories] = React.useState([]);
      const [topCostDrivers, setTopCostDrivers] = React.useState([]);

      React.useEffect(() => {
        const projects = db.getProjects();
        let pipelineValue = 0, totalProfit = 0, margins = [];
        const projectData = [];
        const deptCostMap = {}, deptRevenueMap = {};
        const catTotals = { internal: 0, external: 0, tools: 0, other: 0 };
        const costDrivers = [];

        projects.forEach(p => {
          const totals = db.calculateProjectTotals(p.id);
          pipelineValue += totals.sellingPrice;
          totalProfit += totals.grossProfit;
          margins.push(totals.actualMargin);
          projectData.push({ name: p.name, margin: totals.actualMargin, cost: totals.totalCost, price: totals.sellingPrice, status: p.status });

          // BOQ category breakdown
          const boqItems = db.getBoqItems(p.id);
          boqItems.forEach(item => {
            const phase = db.getPhases(p.id).find(ph => ph.id === item.phase_id);
            const calc = db.calcBoqItemTotal(item, p.target_margin || 0, phase?.margin_percent);
            catTotals[item.category] = (catTotals[item.category] || 0) + calc.total;
          });

          // Department data
          const phases = db.getPhases(p.id);
          phases.forEach(phase => {
            db.getResourceCosts(phase.id).forEach(r => {
              const role = db.getRoles().find(rl => rl.id === r.role_id);
              const dept = role?.department || 'Other';
              deptCostMap[dept] = (deptCostMap[dept] || 0) + r.total;
              costDrivers.push({ name: role?.name || 'Unknown', dept, cost: r.total, project: p.name });
            });
          });
        });

        const avgMargin = margins.length > 0 ? margins.reduce((a, b) => a + b, 0) / margins.length : 0;
        setStats({ totalProjects: projects.length, pipelineValue, totalProfit, avgMargin });
        setProjectMargins(projectData.sort((a, b) => b.margin - a.margin));

        // Dept margins
        const deptArr = Object.entries(deptCostMap).sort((a, b) => b[1] - a[1]).map(([name, cost]) => ({ name, cost }));
        setDeptMargins(deptArr);

        // BOQ categories
        const catArr = Object.entries(catTotals).filter(([, v]) => v > 0).sort((a, b) => b[1] - a[1]);
        const catTotal = catArr.reduce((s, [, v]) => s + v, 0);
        setBoqCategories(catArr.map(([name, value]) => ({ name, value, pct: catTotal > 0 ? Math.round(value / catTotal * 100) : 0 })));

        // Top cost drivers
        setTopCostDrivers(costDrivers.sort((a, b) => b.cost - a.cost).slice(0, 10));

        lucide.createIcons();
      }, [refreshKey]);

      const catColors = { internal: 'var(--boud-purple)', external: 'var(--boud-orange)', tools: '#6B7A1A', other: '#6b7280' };

      return (
        <div>
          <div className="page-header"><h1 className="page-title">Insights</h1><p className="text-secondary">Performance analytics and cost intelligence</p></div>
          <div className="stats-grid">
            <div className="stat-card"><div className="stat-label">Total Projects</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{stats.totalProjects}</div></div>
            <div className="stat-card"><div className="stat-label">Pipeline Value</div><div className="stat-value" style={{color: 'var(--boud-purple)'}}>{formatCurrency(stats.pipelineValue)}</div></div>
            <div className="stat-card"><div className="stat-label">Total Profit</div><div className="stat-value" style={{color: stats.totalProfit >= 0 ? 'var(--success)' : 'var(--error)'}}>{formatCurrency(stats.totalProfit)}</div></div>
            <div className="stat-card"><div className="stat-label">Average Margin</div><div className="stat-value" style={{color: stats.avgMargin >= 25 ? 'var(--success)' : stats.avgMargin >= 15 ? 'var(--warning)' : 'var(--error)'}}>{stats.avgMargin.toFixed(1)}%</div></div>
          </div>

          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginTop: 16}}>
            {/* Margin Distribution */}
            <div className="card" style={{padding: 20}}>
              <h3 style={{marginBottom: 12}}>Project Margin Distribution</h3>
              {projectMargins.length === 0 ? (
                <p className="text-secondary">No projects yet</p>
              ) : (
                <div>
                  {projectMargins.map((p, i) => (
                    <div key={i} style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8}}>
                      <div style={{width: 8, height: 8, borderRadius: '50%', background: p.margin >= 25 ? 'var(--success)' : p.margin >= 15 ? 'var(--warning)' : 'var(--error)', flexShrink: 0}}></div>
                      <span style={{flex: 1, fontSize: 13, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{p.name}</span>
                      <div style={{width: 100, height: 12, borderRadius: 3, background: 'var(--bg-secondary)', overflow: 'hidden', flexShrink: 0}}>
                        <div style={{height: '100%', width: `${Math.min(Math.max(p.margin, 0), 100)}%`, background: p.margin >= 25 ? 'var(--success)' : p.margin >= 15 ? 'var(--warning)' : 'var(--error)', borderRadius: 3}}></div>
                      </div>
                      <span style={{width: 50, textAlign: 'right', fontSize: 13, fontWeight: 600, color: p.margin >= 25 ? 'var(--success)' : p.margin >= 15 ? 'var(--warning)' : 'var(--error)'}}>{p.margin.toFixed(1)}%</span>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* BOQ Category Breakdown */}
            <div className="card" style={{padding: 20}}>
              <h3 style={{marginBottom: 12}}>BOQ by Category</h3>
              {boqCategories.length === 0 ? (
                <p className="text-secondary">No BOQ data yet</p>
              ) : (
                <div>
                  {/* Stacked bar */}
                  <div style={{height: 32, borderRadius: 8, overflow: 'hidden', display: 'flex', marginBottom: 16}}>
                    {boqCategories.map(c => (
                      <div key={c.name} style={{width: `${c.pct}%`, background: catColors[c.name] || '#999', transition: 'width 0.3s'}} title={`${c.name}: ${c.pct}%`}></div>
                    ))}
                  </div>
                  {boqCategories.map(c => (
                    <div key={c.name} style={{display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: 13}}>
                      <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                        <div style={{width: 10, height: 10, borderRadius: 2, background: catColors[c.name] || '#999'}}></div>
                        <span style={{textTransform: 'capitalize'}}>{c.name}</span>
                      </div>
                      <div><span style={{fontWeight: 600}}>{formatCurrency(c.value)}</span> <span className="text-secondary">({c.pct}%)</span></div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Department Cost Analysis */}
            <div className="card" style={{padding: 20}}>
              <h3 style={{marginBottom: 12}}>Cost by Department</h3>
              {deptMargins.length === 0 ? (
                <p className="text-secondary">No resource data yet</p>
              ) : (
                <div>
                  {deptMargins.map(d => {
                    const max = deptMargins[0]?.cost || 1;
                    return (
                      <div key={d.name} style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8}}>
                        <span style={{width: 50, fontSize: 12, textAlign: 'right', color: 'var(--text-secondary)', flexShrink: 0}}>{d.name}</span>
                        <div style={{flex: 1, height: 18, borderRadius: 4, background: 'var(--bg-secondary)', overflow: 'hidden'}}>
                          <div style={{height: '100%', width: `${Math.round(d.cost / max * 100)}%`, background: 'var(--boud-purple)', opacity: 0.7, borderRadius: 4}}></div>
                        </div>
                        <span style={{width: 80, fontSize: 12, fontWeight: 500, textAlign: 'right'}}>{formatCurrency(d.cost)}</span>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Top Cost Drivers */}
            <div className="card" style={{padding: 20}}>
              <h3 style={{marginBottom: 12}}>Top Cost Drivers</h3>
              {topCostDrivers.length === 0 ? (
                <p className="text-secondary">No resource data yet</p>
              ) : (
                <table style={{fontSize: 13}}>
                  <thead><tr><th>Role</th><th>Dept</th><th>Project</th><th style={{textAlign: 'right'}}>Cost</th></tr></thead>
                  <tbody>
                    {topCostDrivers.map((d, i) => (
                      <tr key={i}>
                        <td style={{fontWeight: 500}}>{d.name}</td>
                        <td className="text-secondary">{d.dept}</td>
                        <td className="text-secondary" style={{fontSize: 12}}>{d.project}</td>
                        <td style={{textAlign: 'right', fontWeight: 600}}>{formatCurrency(d.cost)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
          </div>
        </div>
      );
    };

    const Settings = ({ onRefresh }) => {
      const [vatRate, setVatRate] = React.useState('15');
      const [saved, setSaved] = React.useState(false);
      React.useEffect(() => { const s = localStorage.getItem('boud_vat_rate'); if (s) setVatRate(s); lucide.createIcons(); }, []);
      const handleSave = () => { localStorage.setItem('boud_vat_rate', vatRate); setSaved(true); setTimeout(() => setSaved(false), 2000); onRefresh?.(); };
      return (
        <div>
          <div className="page-header"><div><h1 className="page-title">Settings</h1><p className="text-secondary">Configure application settings</p></div></div>
          <div className="card" style={{maxWidth: 600}}>
            <h3 style={{marginBottom: 24}}>Tax Settings</h3>
            <div className="form-group">
              <label className="form-label">VAT Rate (%)</label>
              <div style={{display: 'flex', gap: 12, alignItems: 'center'}}>
                <input type="number" className="form-input" value={vatRate} onChange={e => setVatRate(e.target.value)} min="0" max="100" style={{maxWidth: 120}} />
                <span>%</span>
              </div>
            </div>
            <button className="btn btn-primary" onClick={handleSave}>Save Settings</button>
            {saved && <span style={{marginLeft: 12, color: 'var(--success)'}}>Saved!</span>}
          </div>
        </div>
      );
    };

    const ApiSettings = ({ onRefresh }) => {
      React.useEffect(() => { lucide.createIcons(); }, []);
      return (
        <div>
          <div className="page-header"><div><h1 className="page-title">API Pricing</h1><p className="text-secondary">Configure API base prices</p></div></div>
          <div className="card"><p>Configure API pricing in Settings.</p></div>
        </div>
      );
    };

    const ProductFees = ({ onRefresh }) => {
      React.useEffect(() => { lucide.createIcons(); }, []);
      return (
        <div>
          <div className="page-header"><div><h1 className="page-title">Product Fees</h1><p className="text-secondary">Configure product license fees</p></div></div>
          <div className="card"><p>Product fees configuration.</p></div>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [isLoading, setIsLoading] = React.useState(true);
      const [isAuthenticated, setIsAuthenticated] = React.useState(false);
      const [currentView, setCurrentView] = React.useState('dashboard');
      const [selectedProjectId, setSelectedProjectId] = React.useState(null);
      const [refreshKey, setRefreshKey] = React.useState(0);
      const [theme, setThemeState] = React.useState(getTheme());
      const [isNotificationsOpen, setIsNotificationsOpen] = React.useState(false);
      const [notifications, setNotifications] = React.useState([
        { id: 1, type: 'success', title: 'Welcome to Boud!', message: 'Your pricing engine is ready to use.', time: 'Just now', read: false },
        { id: 2, type: 'info', title: 'New Features', message: 'Risk margin, discounts, templates & version history now available.', time: '2 min ago', read: false }
      ]);

      React.useEffect(() => {
        loadState();
        document.documentElement.setAttribute('data-theme', theme);
        setIsAuthenticated(isLoggedIn());
        setIsLoading(false);
      }, []);

      const handleNavigate = (view, projectId = null) => {
        setCurrentView(view);
        setSelectedProjectId(projectId);
      };

      const triggerRefresh = () => setRefreshKey(k => k + 1);
      const handleToggleTheme = () => { const newTheme = theme === 'dark' ? 'light' : 'dark'; setThemeState(newTheme); setTheme(newTheme); };
      const handleMarkRead = (id) => setNotifications(prev => prev.map(n => n.id === id ? {...n, read: true} : n));
      const handleClearAll = () => setNotifications([]);
      const unreadCount = notifications.filter(n => !n.read).length;

      const handleLogin = () => setIsAuthenticated(true);
      const handleLogout = () => { setLoggedIn(false); setIsAuthenticated(false); };

      if (isLoading) {
        return (
          <div className="loading-screen">
            <BoudLogo size={56} showText={true} />
            <div style={{marginTop: 16, fontSize: 14, color: 'var(--boud-lime)', textTransform: 'uppercase', letterSpacing: '0.2em'}}>Loading...</div>
          </div>
        );
      }

      if (!isAuthenticated) {
        return <AuthPage onLogin={handleLogin} />;
      }

      const renderContent = () => {
        switch (currentView) {
          case 'dashboard': return <Dashboard onNavigate={handleNavigate} refreshKey={refreshKey} />;
          case 'insights': return <Insights refreshKey={refreshKey} />;
          case 'rates': return <RatesManagement onRefresh={triggerRefresh} />;
          case 'tools': return <ToolsManagement onRefresh={triggerRefresh} />;
          case 'api-settings': return <ApiSettings onRefresh={triggerRefresh} />;
          case 'product-fees': return <ProductFees onRefresh={triggerRefresh} />;
          case 'projects': return <ProjectsList onNavigate={handleNavigate} refreshKey={refreshKey} onRefresh={triggerRefresh} />;
          case 'project-pricing': return <ProjectPricing projectId={selectedProjectId} onBack={() => handleNavigate('projects')} onRefresh={triggerRefresh} onNavigate={handleNavigate} />;
          case 'credits': return <CreditsAndPackages onRefresh={triggerRefresh} />;
          case 'users': return <UserManagement onRefresh={triggerRefresh} />;
          case 'templates': return <TemplatesLibrary onNavigate={handleNavigate} onRefresh={triggerRefresh} />;
          case 'settings': return <Settings onRefresh={triggerRefresh} />;
          default: return <Dashboard onNavigate={handleNavigate} refreshKey={refreshKey} />;
        }
      };

      return (
        <div className="app-container">
          <Sidebar
            currentView={currentView}
            onNavigate={handleNavigate}
            theme={theme}
            onToggleTheme={handleToggleTheme}
            onOpenNotifications={() => setIsNotificationsOpen(true)}
            notificationCount={unreadCount}
            onLogout={handleLogout}
          />
          <main className="main-content">{renderContent()}</main>
          <NotificationCenter
            isOpen={isNotificationsOpen}
            onClose={() => setIsNotificationsOpen(false)}
            notifications={notifications}
            onMarkRead={handleMarkRead}
            onClearAll={handleClearAll}
          />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
